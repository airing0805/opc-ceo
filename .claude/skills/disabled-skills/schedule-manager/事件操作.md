# 事件操作

## 概述

负责日程事件的创建、查询、更新、删除和提醒管理。

## 创建事件

### 输入参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `title` | string | 是 | 事件标题 |
| `startTime` | string | 是 | 开始时间，格式 `YYYY-MM-DD HH:mm` |
| `endTime` | string | 是 | 结束时间，格式 `YYYY-MM-DD HH:mm` |
| `type` | string | 否 | 事件类型，默认 `event` |
| `timeBlock` | string | 否 | 时间块类型 |
| `description` | string | 否 | 事件描述 |
| `location` | string | 否 | 事件地点 |
| `reminder` | number | 否 | 提醒提前时间（分钟） |
| `taskId` | string | 否 | 关联任务 ID |

### 处理流程

```
1. 验证时间有效性（开始 < 结束）
2. 检查时间冲突（时间块不能重叠）
3. 生成事件 ID: EVENT-YYYY-MM-DD-NNN
4. 获取当前时间戳
5. 创建 Event 实体
6. 设置默认提醒（如未指定）
7. 保存到 MCP Memory
```

### 示例

```
创建会议事件:
- 标题: 项目进度会议
- 时间: 2026-02-24 14:00 - 15:00
- 类型: meeting
- 时间块: TB-MEET
- 地点: 线上会议
- 提醒: 15 分钟前

生成 ID: EVENT-2026-02-24-001
```

## 查询事件

### 查询方式

| 方式 | 参数 | 说明 |
|------|------|------|
| 按 ID | `eventId` | 查询单个事件 |
| 按日期 | `date` / `dateRange` | 查询指定日期或日期范围 |
| 按状态 | `status` | 查询指定状态的事件 |
| 按任务 | `taskId` | 查询关联指定任务的事件 |
| 按时间块 | `timeBlock` | 查询指定时间块类型的事件 |

### 查询结果格式

```json
{
  "date": "2026-02-24",
  "events": [
    {
      "eventId": "EVENT-2026-02-24-001",
      "title": "项目进度会议",
      "startTime": "2026-02-24 14:00",
      "endTime": "2026-02-24 15:00",
      "type": "meeting",
      "timeBlock": "TB-MEET",
      "location": "线上会议",
      "reminder": 15,
      "status": "pending",
      "createdAt": "2026-02-24T10:00:00Z"
    }
  ],
  "count": 1,
  "summary": {
    "totalDuration": 60,
    "byType": {
      "meeting": 60
    }
  }
}
```

## 更新事件

### 可更新字段

| 字段 | 说明 |
|------|------|
| `title` | 标题 |
| `startTime` / `endTime` | 时间 |
| `description` | 描述 |
| `location` | 地点 |
| `reminder` | 提醒时间 |
| `status` | 状态 |
| `timeBlock` | 时间块类型 |

### 处理流程

```
1. 验证事件 ID 存在
2. 检查时间冲突（如修改时间）
3. 更新指定字段
4. 更新 updatedAt 时间戳
5. 保存到 MCP Memory
```

## 删除事件

### 处理流程

```
1. 验证事件 ID 存在
2. 记录删除原因（如提供）
3. 删除 Event 实体
4. 记录删除日志
```

## 时间冲突检测

### 冲突规则

- `TB-DEEP` (深度工作) 不能与其他时间块重叠
- `TB-MEET` (会议) 可以与其他会议时间块重叠
- `TB-ADMIN`、`TB-LEARN`、`TB-BREAK` 不能重叠

### 检测逻辑

```
function hasConflict(newEvent, existingEvents):
  for event in existingEvents:
    if event.status == 'cancelled':
      continue
    if newEvent.timeBlock == 'TB-MEET' and event.timeBlock == 'TB-MEET':
      continue  # 会议可以重叠
    if timeRangesOverlap(newEvent, event):
      return true
  return false
```

## 提醒系统

### 提醒类型

| 类型 | 说明 |
|------|------|
| 前置提醒 | 事件开始前 N 分钟 |
| 多次提醒 | 开始前 1 天、1 小时、15 分钟 |

### 提醒触发

```
当前时间 >= 事件开始时间 - 提醒时间
→ 触发提醒
→ 更新事件状态为 'ongoing'
```

## MCP Memory 实体定义

### Event 实体

```yaml
entityType: Event
name: EVENT-2026-02-24-001
observations:
  - title: 项目进度会议
  - startTime: 2026-02-24 14:00
  - endTime: 2026-02-24 15:00
  - type: meeting
  - timeBlock: TB-MEET
  - description: 讨论项目进度和下一步计划
  - location: 线上会议
  - reminder: 15
  - status: pending
  - createdAt: 2026-02-24T10:00:00Z
  - updatedAt: 2026-02-24T10:00:00Z
```

## 注意事项

- 事件删除不可恢复
- 更新时间需检查冲突
- 取消事件需要更新状态而非删除
- 提醒时间不能超过事件时长

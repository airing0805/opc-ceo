# 交易操作

## 概述

负责交易的记录、查询、更新和删除操作。

## 交易记录

### 创建交易

**输入参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `date` | string | 是 | 交易日期，格式 `YYYY-MM-DD` |
| `amount` | number | 是 | 金额（收入为正，支出为负） |
| `category` | string | 是 | 分类代码 |
| `description` | string | 是 | 交易描述 |
| `currency` | string | 否 | 货币单位，默认 `CNY` |
| `projectId` | string | 否 | 关联项目 ID |
| `tags` | array | 否 | 标签数组 |

**处理流程**：

```
1. 生成交易 ID: TXN-YYYY-MM-DD-NNN
2. 获取当前时间戳
3. 创建 Transaction 实体到 MCP Memory
4. 返回交易 ID
```

**示例**：

```
创建交易:
- 日期: 2026-02-23
- 金额: 5000 (收入)
- 分类: INC-PROJ
- 描述: 某项目开发收入

生成 ID: TXN-2026-02-23-001
```

### 查询交易

**查询方式**：

| 方式 | 参数 | 说明 |
|------|------|------|
| 按 ID | `transactionId` | 查询单笔交易 |
| 按日期 | `date` / `dateRange` | 查询指定日期或日期范围 |
| 按分类 | `category` | 查询指定分类的交易 |
| 按项目 | `projectId` | 查询指定项目的交易 |
| 按标签 | `tag` | 查询包含指定标签的交易 |

**查询结果格式**：

```json
{
  "transactions": [
    {
      "transactionId": "TXN-2026-02-23-001",
      "date": "2026-02-23",
      "amount": 5000,
      "currency": "CNY",
      "category": "INC-PROJ",
      "description": "某项目开发收入",
      "projectId": "PROJ-001",
      "tags": ["web", "frontend"],
      "createdAt": "2026-02-23T10:00:00Z",
      "updatedAt": "2026-02-23T10:00:00Z"
    }
  ],
  "count": 1,
  "summary": {
    "income": 5000,
    "expense": 0,
    "balance": 5000
  }
}
```

## 交易更新

### 更新交易

**可更新字段**：

| 字段 | 说明 |
|------|------|
| `amount` | 金额 |
| `description` | 描述 |
| `category` | 分类 |
| `tags` | 标签 |

**处理流程**：

```
1. 验证交易 ID 存在
2. 更新指定字段
3. 更新 updatedAt 时间戳
4. 保存到 MCP Memory
```

### 删除交易

**处理流程**：

```
1. 验证交易 ID 存在
2. 删除 Transaction 实体
3. 记录删除日志
```

## 交易验证

### 验证规则

| 规则 | 说明 |
|------|------|
| 金额验证 | 金额不能为 0 |
| 分类验证 | 分类代码必须有效 |
| 日期验证 | 日期格式必须为 `YYYY-MM-DD` |
| ID 唯一性 | 交易 ID 必须唯一 |

## MCP Memory 实体定义

### Transaction 实体

```yaml
entityType: Transaction
name: TXN-2026-02-23-001
observations:
  - date: 2026-02-23
  - amount: 5000
  - currency: CNY
  - category: INC-PROJ
  - description: 某项目开发收入
  - projectId: PROJ-001
  - tags: [web, frontend]
  - createdAt: 2026-02-23T10:00:00Z
  - updatedAt: 2026-02-23T10:00:00Z
```

## 注意事项

- 交易删除不可恢复
- 更新交易会自动更新 updatedAt 时间戳
- 金额为负数表示支出

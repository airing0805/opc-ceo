# 底层执行能力

> 本文档记录 Coach 的具体操作流程和工具使用规范，是 V4.0 自我进化能力的重要补充。

---

## 概述

Coach 作为实战派的 CEO 教练，必须具备独立执行底层操作的能力。本文档详细记录各类操作的具体流程和工具使用示例。

---

## 一、文档操作流程

### 1.1 读取文档

**首选工具**: `mcp__filesystem__read_file`

> **重要**: 根据项目规范，当前电脑环境 Direct 编辑/写入有问题，所有文档操作**优先使用 MCP 工具**。

#### 使用场景

| 场景 | 说明 |
|------|------|
| 读取任务分配 | 获取当前任务状态和角色负载 |
| 读取战略目标 | 了解当前战略方向 |
| 读取版本规划 | 查看具体规划内容 |
| 读取角色记忆 | 获取历史上下文 |

#### 工具调用示例

```json
// 读取任务分配文档
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md"
})

// 读取战略目标文档
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/战略规划/战略目标.md"
})

// 读取版本规划
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/版本规划/v2-技能规划/README.md"
})
```

#### 备选工具

当 MCP 工具不可用时，使用内置 `Read` 工具：

```json
Read({
  "file_path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md"
})
```

### 1.2 写入文档

**首选工具**: `mcp__filesystem__write_file`

#### 使用场景

| 场景 | 说明 |
|------|------|
| 创建新文档 | 创建新的规划文档或记录 |
| 更新任务状态 | 修改任务分配中的状态 |
| 记录协调事件 | 写入协调记录文档 |
| 保存执行日志 | 记录操作过程 |

#### 工具调用示例

```json
// 写入新文档
mcp__filesystem__write_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/协调记录.md",
  "content": "# 协调记录\n\n## COORD-2026-02-26-001\n\n**时间**: 2026-02-26\n**类型**: 任务分配协调\n**内容**: ...\n"
})

// 更新任务状态
mcp__filesystem__write_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/执行日志/2026-02-26.md",
  "content": "# 执行日志 - 2026-02-26\n\n## 完成的任务\n- v2.3.1.1 创建底层执行能力.md\n"
})
```

### 1.3 编辑文档

**首选工具**: `mcp__filesystem__edit_file`

#### 使用场景

| 场景 | 说明 |
|------|------|
| 追加内容 | 在文档末尾添加新内容 |
| 修改特定部分 | 替换文档中的某个段落 |
| 更新状态 | 修改任务状态等特定字段 |

#### 工具调用示例

```json
// 编辑文档（替换特定内容）
mcp__filesystem__edit_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md",
  "old_string": "| v2.3.1.1 | 待执行 |",
  "new_string": "| v2.3.1.1 | 已完成 |"
})
```

### 1.4 文档操作最佳实践

```
1. 优先使用 MCP 工具（mcp__filesystem__*）
2. 使用绝对路径，避免相对路径问题
3. 写入前先读取确认内容格式
4. 批量操作时分步执行，每步验证
5. 重要操作前备份原文档内容
```

---

## 二、Memory 操作流程

### 2.1 创建实体

**工具**: `mcp__memory__create_entities`

#### 使用场景

| 场景 | 实体类型 | 示例实体名 |
|------|----------|------------|
| 创建任务 | Task | TASK-v2.3.1.1 |
| 记录决策 | Decision | DECISION-2026-02-26-001 |
| 创建进化记录 | CoachEvolution | COACH-EVOLUTION-2026-02-26-001 |
| 记录评估 | CoachEvaluation | COACH-EVAL-2026-02-26-001 |
| 记录协调事件 | CoordinationEvent | COORD-2026-02-26-001 |

#### 工具调用示例

```json
// 创建任务实体
mcp__memory__create_entities({
  "entities": [
    {
      "name": "TASK-v2.3.1.1",
      "entityType": "Task",
      "observations": [
        "description: 创建 Coach 底层执行能力.md",
        "status: in_progress",
        "assignedTo: ceo-coach",
        "priority: high",
        "createdAt: 2026-02-26T10:00:00",
        "dueDate: 2026-02-26"
      ]
    }
  ]
})

// 创建决策记录
mcp__memory__create_entities({
  "entities": [
    {
      "name": "DECISION-2026-02-26-001",
      "entityType": "Decision",
      "observations": [
        "context: Coach 能力增强",
        "decision: 创建底层执行能力.md 文档",
        "reason: V4.0 进化报告承诺",
        "impact: 提升 Coach 独立执行能力",
        "timestamp: 2026-02-26T10:00:00"
      ]
    }
  ]
})

// 创建自我评估记录
mcp__memory__create_entities({
  "entities": [
    {
      "name": "COACH-EVAL-2026-02-26-001",
      "entityType": "CoachEvaluation",
      "observations": [
        "type: decision_review",
        "decisionId: DECISION-2026-02-26-001",
        "quality: 85%",
        "improvement: 优化风险评估流程",
        "timestamp: 2026-02-26T10:00:00"
      ]
    }
  ]
})

// 创建进化记录
mcp__memory__create_entities({
  "entities": [
    {
      "name": "COACH-EVOLUTION-2026-02-26-001",
      "entityType": "CoachEvolution",
      "observations": [
        "type: capability_improvement",
        "area: execution_capability",
        "change: 新增底层执行能力.md 模块",
        "status: completed",
        "timestamp: 2026-02-26T10:30:00"
      ]
    }
  ]
})
```

### 2.2 查询实体

**工具**: `mcp__memory__search_nodes`

#### 使用场景

| 场景 | 查询关键词 |
|------|------------|
| 检查 Memory 状态 | "company status task project" |
| 查找特定任务 | "TASK-v2.3" |
| 查找决策记录 | "DECISION-2026-02" |
| 查找进化记录 | "COACH-EVOLUTION" |

#### 工具调用示例

```json
// 启动自检 - 检查 Memory 状态
mcp__memory__search_nodes({
  "query": "company status task project"
})

// 查找特定任务
mcp__memory__search_nodes({
  "query": "TASK-v2.3.1"
})

// 查找当天的决策记录
mcp__memory__search_nodes({
  "query": "DECISION-2026-02-26"
})

// 查找进化记录
mcp__memory__search_nodes({
  "query": "COACH-EVOLUTION"
})
```

### 2.3 查看完整图谱

**工具**: `mcp__memory__read_graph`

#### 使用场景

当需要了解 Memory 中的所有实体和关系时使用。

#### 工具调用示例

```json
// 读取完整 Memory 图谱
mcp__memory__read_graph({})
```

### 2.4 添加观察记录

**工具**: `mcp__memory__add_observations`

#### 使用场景

| 场景 | 说明 |
|------|------|
| 更新任务状态 | 修改任务的 status 观察 |
| 添加进展记录 | 为实体添加新的观察 |
| 记录执行结果 | 添加完成时间等信息 |

#### 工具调用示例

```json
// 更新任务状态
mcp__memory__add_observations({
  "observations": [
    {
      "entityName": "TASK-v2.3.1.1",
      "contents": [
        "status: completed",
        "completedAt: 2026-02-26T11:00:00",
        "result: 成功创建底层执行能力.md"
      ]
    }
  ]
})
```

### 2.5 创建关系

**工具**: `mcp__memory__create_relations`

#### 使用场景

| 场景 | 关系类型 | 说明 |
|------|----------|------|
| 任务依赖 | depends_on | 任务之间的依赖关系 |
| 任务归属 | assigned_to | 任务分配给角色 |
| 决策关联 | relates_to | 决策与任务的关系 |

#### 工具调用示例

```json
// 创建任务与决策的关系
mcp__memory__create_relations({
  "relations": [
    {
      "from": "TASK-v2.3.1.1",
      "to": "DECISION-2026-02-26-001",
      "relationType": "triggered_by"
    }
  ]
})
```

### 2.6 删除操作

**工具**: `mcp__memory__delete_entities`, `mcp__memory__delete_observations`, `mcp__memory__delete_relations`

#### 使用场景

谨慎使用删除操作，仅在以下情况：
- 实体创建错误需要修正
- 测试数据清理
- 过期数据归档

#### 工具调用示例

```json
// 删除特定观察
mcp__memory__delete_observations({
  "deletions": [
    {
      "entityName": "TASK-v2.3.1.1",
      "observations": ["status: in_progress"]
    }
  ]
})
```

---

## 三、MCP 工具优先级

### 3.1 工具选择矩阵

| 操作类型 | 首选工具 | 备选工具 | 说明 |
|----------|----------|----------|------|
| 文档读取 | mcp__filesystem__read_file | Read | MCP 优先，解决环境问题 |
| 文档写入 | mcp__filesystem__write_file | Write | MCP 优先 |
| 文档编辑 | mcp__filesystem__edit_file | Edit | MCP 优先 |
| 文件搜索 | Glob | Bash find | 更友好的输出格式 |
| 内容搜索 | Grep | Bash grep | 更友好的输出格式 |
| 命令执行 | Bash | - | Git 操作、目录管理 |
| Memory 查询 | mcp__memory__search_nodes | - | 唯一选择 |
| Memory 创建 | mcp__memory__create_entities | - | 唯一选择 |
| Memory 更新 | mcp__memory__add_observations | - | 唯一选择 |

### 3.2 工具使用原则

```
1. MCP 工具优先 - 解决 Direct 编辑环境问题
2. 内置工具次之 - 作为备选方案
3. Bash 最后 - 仅用于系统操作
4. 避免混用 - 同一任务使用同类工具
```

---

## 四、常见操作场景示例

### 4.1 启动自检流程

**触发时机**: 每次唤醒 ceo-coach 时

**执行步骤**:

```
步骤1: 检查 Memory 状态
  工具: mcp__memory__search_nodes
  参数: { query: "company status task project" }
  判断: 若返回空，则需要从文档重建

步骤2: 检查 Git 状态
  工具: Bash
  命令: git status
  判断: 若有未提交变更，记录到日志

步骤3: 检查待办任务
  工具: mcp__filesystem__read_file
  路径: docs/沟通文档/任务分配.md
  判断: 识别未完成任务

步骤4: 检查关键文档
  工具: mcp__filesystem__read_file
  路径: docs/战略规划/战略目标.md
  判断: 确认文档存在且可读
```

**示例代码**:

```json
// 步骤1: 检查 Memory
mcp__memory__search_nodes({ "query": "company status task project" })

// 步骤2: 检查 Git 状态
Bash({ "command": "git status" })

// 步骤3: 检查待办任务
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md"
})

// 步骤4: 检查战略目标
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/战略规划/战略目标.md"
})
```

### 4.2 Memory 重建流程

**触发时机**: Memory 查询返回空结果时

**执行步骤**:

```
步骤1: 读取任务分配文档
  工具: mcp__filesystem__read_file
  路径: docs/沟通文档/任务分配.md

步骤2: 解析文档中的任务
  方法: 提取任务 ID、状态、负责人

步骤3: 创建 Memory 实体
  工具: mcp__memory__create_entities
  内容: 为每个任务创建 Task 实体

步骤4: 读取战略目标
  工具: mcp__filesystem__read_file
  路径: docs/战略规划/战略目标.md

步骤5: 创建 Goal 实体
  工具: mcp__memory__create_entities
  内容: 为每个目标创建 Goal 实体
```

**示例代码**:

```json
// 步骤1: 读取任务文档
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md"
})

// 步骤3: 创建任务实体（示例）
mcp__memory__create_entities({
  "entities": [
    {
      "name": "TASK-v2.3.1.1",
      "entityType": "Task",
      "observations": [
        "description: 创建底层执行能力.md",
        "status: pending",
        "assignedTo: ceo-coach"
      ]
    }
  ]
})

// 步骤4: 读取战略目标
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/战略规划/战略目标.md"
})
```

### 4.3 任务记录流程

**触发时机**: 与用户沟通确认任务后

**执行步骤**:

```
步骤1: 创建 Memory 实体
  工具: mcp__memory__create_entities
  内容: 创建 Task 实体

步骤2: 更新任务分配文档
  工具: mcp__filesystem__read_file + mcp__filesystem__write_file
  内容: 追加新任务记录

步骤3: 记录决策（如有）
  工具: mcp__memory__create_entities
  内容: 创建 Decision 实体
```

**示例代码**:

```json
// 步骤1: 创建 Memory 实体
mcp__memory__create_entities({
  "entities": [
    {
      "name": "TASK-v2.4.1.1",
      "entityType": "Task",
      "observations": [
        "description: 优化风险评估流程",
        "status: pending",
        "assignedTo: ceo-coach",
        "priority: medium",
        "createdAt: 2026-02-26T12:00:00"
      ]
    }
  ]
})
```

### 4.4 进化记录流程

**触发时机**: 完成能力改进后

**执行步骤**:

```
步骤1: 创建进化记录
  工具: mcp__memory__create_entities
  内容: 创建 CoachEvolution 实体

步骤2: 更新 Skill 模块索引
  工具: mcp__filesystem__edit_file
  内容: 在 SKILL.md 中添加新模块引用

步骤3: 记录到执行日志
  工具: mcp__filesystem__write_file
  内容: 记录进化时间和内容
```

**示例代码**:

```json
// 步骤1: 创建进化记录
mcp__memory__create_entities({
  "entities": [
    {
      "name": "COACH-EVOLUTION-2026-02-26-001",
      "entityType": "CoachEvolution",
      "observations": [
        "type: capability_improvement",
        "area: execution_capability",
        "change: 新增底层执行能力.md 模块",
        "status: completed",
        "timestamp: 2026-02-26T11:00:00"
      ]
    }
  ]
})
```

### 4.5 风险预警检测

**触发时机**: 定期检查或任务状态变更时

**执行步骤**:

```
步骤1: 读取任务分配文档
  工具: mcp__filesystem__read_file

步骤2: 分析任务状态
  方法: 检查截止日期、任务数量

步骤3: 创建预警记录（如检测到风险）
  工具: mcp__memory__create_entities
  内容: 创建 RiskAlert 实体

步骤4: 记录到问题清单
  工具: mcp__filesystem__edit_file
  内容: 追加问题记录
```

**示例代码**:

```json
// 步骤3: 创建预警记录
mcp__memory__create_entities({
  "entities": [
    {
      "name": "RISK-2026-02-26-001",
      "entityType": "RiskAlert",
      "observations": [
        "type: task_delay",
        "taskId: TASK-v2.3.1.1",
        "severity: medium",
        "detectedAt: 2026-02-26T14:00:00",
        "action: 记录到问题清单，提醒用户"
      ]
    }
  ]
})
```

---

## 五、文件系统操作

### 5.1 目录列表

**工具**: `mcp__filesystem__list_directory`

#### 使用场景

| 场景 | 说明 |
|------|------|
| 检查目录结构 | 了解当前目录内容 |
| 查找文件 | 确认文件是否存在 |
| 统计文件数量 | 触发目录规范检查 |

#### 工具调用示例

```json
// 列出目录内容
mcp__filesystem__list_directory({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs"
})

// 列出带大小的目录内容
mcp__filesystem__list_directory_with_sizes({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs"
})
```

### 5.2 目录树

**工具**: `mcp__filesystem__directory_tree`

#### 使用场景

需要查看完整目录结构时使用。

#### 工具调用示例

```json
// 获取目录树
mcp__filesystem__directory_tree({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs"
})
```

### 5.3 创建目录

**工具**: `mcp__filesystem__create_directory`

#### 使用场景

创建新目录用于组织文档。

#### 工具调用示例

```json
// 创建新目录
mcp__filesystem__create_directory({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/新目录"
})
```

### 5.4 移动文件

**工具**: `mcp__filesystem__move_file`

#### 使用场景

文件重命名或移动到其他目录。

#### 工具调用示例

```json
// 移动文件
mcp__filesystem__move_file({
  "source": "E:/workspaces_2026_python/OPC-CEO/docs/旧位置/文件.md",
  "destination": "E:/workspaces_2026_python/OPC-CEO/docs/新位置/文件.md"
})
```

### 5.5 搜索文件

**工具**: `mcp__filesystem__search_files`

#### 使用场景

在目录中搜索匹配的文件。

#### 工具调用示例

```json
// 搜索 markdown 文件
mcp__filesystem__search_files({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs",
  "pattern": "*.md"
})
```

---

## 六、搜索操作

### 6.1 文件名搜索

**工具**: `Glob`

#### 使用场景

| 场景 | 模式示例 |
|------|----------|
| 查找所有 markdown 文件 | `**/*.md` |
| 查找特定目录下的文件 | `docs/**/*.md` |
| 查找特定前缀的文件 | `**/SKILL.md` |

#### 工具调用示例

```json
// 查找所有 markdown 文件
Glob({
  "pattern": "**/*.md",
  "path": "E:/workspaces_2026_python/OPC-CEO"
})

// 查找所有 SKILL.md 文件
Glob({
  "pattern": "**/SKILL.md",
  "path": "E:/workspaces_2026_python/OPC-CEO/.claude/skills"
})
```

### 6.2 内容搜索

**工具**: `Grep`

#### 使用场景

| 场景 | 模式示例 |
|------|----------|
| 搜索关键词 | `"v2.3.1"` |
| 搜索特定模式 | `"TASK-v\\d+\\.\\d+"` |
| 搜索多个文件类型 | 配合 glob 参数 |

#### 工具调用示例

```json
// 搜索任务 ID
Grep({
  "pattern": "v2\\.3\\.1",
  "path": "E:/workspaces_2026_python/OPC-CEO/docs",
  "output_mode": "content"
})

// 搜索并显示行号
Grep({
  "pattern": "status:",
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档",
  "output_mode": "content",
  "glob": "*.md"
})
```

---

## 七、命令执行

### 7.1 Git 操作

**工具**: `Bash`

#### 常用 Git 命令

```json
// 查看状态
Bash({ "command": "git status" })

// 查看差异
Bash({ "command": "git diff" })

// 查看日志
Bash({ "command": "git log --oneline -10" })

// 添加文件
Bash({ "command": "git add 文件路径" })

// 提交
Bash({ "command": "git commit -m \"提交信息\"" })
```

### 7.2 目录操作

```json
// 创建目录
Bash({ "command": "mkdir -p 目录路径" })

// 列出目录
Bash({ "command": "ls -la 目录路径" })
```

---

## 八、操作检查清单

### 8.1 文档操作检查

```
□ 是否使用了 MCP 工具？（优先）
□ 是否使用了绝对路径？
□ 写入前是否读取确认格式？
□ 重要操作是否有备份？
□ 是否记录到 Memory？
```

### 8.2 Memory 操作检查

```
□ 实体名称是否符合命名规范？
□ entityType 是否正确？
□ observations 是否包含必要字段？
□ 是否创建了必要的关系？
□ 是否同步到文档？
```

### 8.3 执行后检查

```
□ 是否记录到 Memory？
□ 是否同步到文档？
□ 是否更新任务状态？
□ 是否复盘总结？
□ 是否有遗漏？
```

---

## 九、故障排除

### 9.1 MCP 工具不可用

**症状**: 调用 mcp__* 工具返回错误

**解决方案**:
1. 使用内置工具作为备选（Read, Write, Edit）
2. 记录问题到执行日志
3. 通知用户检查 MCP 配置

### 9.2 Memory 返回空

**症状**: search_nodes 返回空结果

**解决方案**:
1. 执行 Memory 重建流程
2. 从文档读取数据
3. 创建必要的 Memory 实体

### 9.3 文档写入失败

**症状**: write_file 返回错误

**解决方案**:
1. 检查路径是否存在
2. 检查文件权限
3. 尝试使用内置 Write 工具
4. 检查磁盘空间

---

## 十、版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0.0 | 2026-02-26 | 初始版本 - 文档操作、Memory 操作、常见场景示例 |

---

## 相关模块

- [SKILL.md](SKILL.md) - 主入口文档
- [自我进化.md](自我进化.md) - 自我反思与持续改进
- [快速参考.md](快速参考.md) - 快速查阅手册

---

> ceo-coach V4.0 - 底层执行能力模块

---
name: network-proxy
description: 网络代理配置 - OpenClash、Clash 客户端、系统代理
version: 1.0.0
parent: devops-engineer
---

# 网络代理配置

## OpenClash 安装（OpenWrt 路由器）

### 前置要求

- OpenWrt 固件（21.02+ 推荐）
- 足够的存储空间（10MB+）
- 科学上网订阅链接
- SSH 访问权限

### 安装步骤

#### 1. SSH 登录路由器

```bash
ssh root@192.168.1.1
# 密码是路由器管理密码
```

#### 2. 更新软件包

```bash
opkg update
```

#### 3. 安装依赖

```bash
# 基础依赖
opkg install coreutils-nohup bash

# 防火墙依赖
opkg install iptables-mod-tproxy iptables-mod-extra kmod-tun

# Ruby 依赖
opkg install ruby ruby-yaml

# LuCI 依赖
opkg install luci-lib-base luci-lib-jsonc
```

#### 4. 下载并安装 OpenClash

```bash
cd /tmp

# 下载最新版本（访问 GitHub Releases 页面查看最新版本号）
wget https://github.com/vernesong/OpenClash/releases/download/v0.46.033-beta/luci-app-openclash_0.46.033-beta_all.ipk

# 安装
opkg install luci-app-openclash_*.ipk

# 如果提示依赖问题，强制安装
opkg install --force-depends luci-app-openclash_*.ipk

# 重启路由器
reboot
```

#### 5. 下载内核

安装后首次访问 OpenClash 页面会提示下载内核：

```bash
# 或手动下载内核
cd /tmp
wget https://github.com/MetaCubeX/mihomo/releases/download/v1.18.1/mihomo-linux-armv8-v1.18.1.gz
gunzip mihomo-linux-armv8-v1.18.1.gz
mv mihomo-linux-armv8-v1.18.1 /etc/openclash/core/metacube
chmod +x /etc/openclash/core/metacube
```

### 配置 OpenClash

#### 1. 登录管理界面

访问: http://192.168.1.1/cgi-bin/luci/admin/services/openclash

#### 2. 基础设置

1. **覆写设置** > **常规设置**:
   - 启用 Meta 内核
   - 选择运行模式

2. **配置订阅** > **添加订阅**:
   - 名称：自定义
   - 地址：粘贴订阅链接
   - 点击"保存配置"

3. **更新订阅**:
   - 点击"更新配置"

#### 3. 运行模式

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| Fake-IP | 更快的响应 | 游戏、日常使用 |
| Redir-Host | 更准确的 DNS | 需要准确 IP 的场景 |

#### 4. 启动 OpenClash

点击"运行 OpenClash"按钮

### OpenClash 常用命令

```bash
# 查看状态
/etc/init.d/openclash status

# 启动/停止/重启
/etc/init.d/openclash start
/etc/init.d/openclash stop
/etc/init.d/openclash restart

# 查看日志
logread | grep openclash

# 实时日志
logread -f | grep openclash

# 查看配置
cat /etc/openclash/config/*.yaml

# 手动更新订阅
curl -s http://127.0.0.1:9090/configs -X PUT -d '{"path":"/etc/openclash/config/your_config.yaml"}'
```

### OpenClash 故障排查

```bash
# 检查进程
ps | grep clash

# 检查端口
netstat -tlnp | grep clash

# 检查内核
ls -la /etc/openclash/core/

# 手动启动（调试用）
/etc/openclash/core/metacube -d /etc/openclash

# 清理并重装
rm -rf /etc/openclash
opkg remove luci-app-openclash
# 然后重新安装
```

## Clash 客户端配置（Windows/Mac）

### Windows 客户端

#### Clash Verge（推荐）

```powershell
# 使用 winget 安装
winget install MetaCubeX.Clash.Verge

# 使用 scoop 安装
scoop bucket add extras
scoop install clash-verge
```

#### Clash for Windows（经典）

```powershell
# 使用 winget
winget install Fndroid.ClashForWindows

# 手动下载
# https://github.com/Fndroid/clash_for_windows_pkg/releases
```

### Mac 客户端

```bash
# ClashX Pro（推荐）
brew install --cask clashx-pro

# Clash for Windows
brew install --cask clash-for-windows
```

### 配置文件

#### 配置文件位置

```
Windows: %USERPROFILE%\.config\clash\
Mac/Linux: ~/.config/clash/
```

#### 配置示例

```yaml
# config.yaml
mixed-port: 7890
allow-lan: true
mode: rule
log-level: info
external-controller: 127.0.0.1:9090

proxies:
  - name: "Server1"
    type: ss
    server: server1.example.com
    port: 443
    cipher: aes-256-gcm
    password: "password123"
    
  - name: "Server2"
    type: vmess
    server: server2.example.com
    port: 443
    uuid: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
    alterId: 0
    cipher: auto

proxy-groups:
  - name: "Proxy"
    type: select
    proxies:
      - Server1
      - Server2
      - DIRECT
      
  - name: "Auto"
    type: url-test
    proxies:
      - Server1
      - Server2
    url: http://www.gstatic.com/generate_204
    interval: 300

rules:
  # 直连
  - DOMAIN-SUFFIX,cn,Proxy
  - DOMAIN-KEYWORD,baidu,Proxy
  
  # 代理
  - DOMAIN-SUFFIX,google.com,Proxy
  - DOMAIN-SUFFIX,github.com,Proxy
  - DOMAIN-SUFFIX,youtube.com,Proxy
  
  # 局域网直连
  - IP-CIDR,192.168.0.0/16,DIRECT
  - IP-CIDR,10.0.0.0/8,DIRECT
  
  # 最终规则
  - GEOIP,CN,Proxy
  - MATCH,Proxy
```

## 系统代理设置

### Windows 系统代理

#### 通过命令行设置

```powershell
# 启用代理
netsh winhttp set proxy 127.0.0.1:7890

# 通过注册表设置
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value 1
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyServer -Value "127.0.0.1:7890"

# 设置绕过列表
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyOverride -Value "localhost;127.*;10.*;172.16.*;172.31.*;192.168.*;<local>"

# 禁用代理
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value 0
```

#### 查看当前代理设置

```powershell
netsh winhttp show proxy
Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
```

### Git 代理

```bash
# HTTP/HTTPS 代理
git config --global http.proxy http://127.0.0.1:7890
git config --global https.proxy http://127.0.0.1:7890

# SOCKS5 代理
git config --global http.proxy socks5://127.0.0.1:7891
git config --global https.proxy socks5://127.0.0.1:7891

# 只为 GitHub 设置代理
git config --global http.https://github.com.proxy http://127.0.0.1:7890

# 取消代理
git config --global --unset http.proxy
git config --global --unset https.proxy
```

### npm/yarn/pnpm 代理

```bash
# npm
npm config set proxy http://127.0.0.1:7890
npm config set https-proxy http://127.0.0.1:7890

# 取消
npm config delete proxy
npm config delete https-proxy

# yarn
yarn config set proxy http://127.0.0.1:7890
yarn config set https-proxy http://127.0.0.1:7890

# pnpm
pnpm config set proxy http://127.0.0.1:7890
pnpm config set https-proxy http://127.0.0.1:7890
```

### pip 代理

```bash
# 临时使用
pip install package --proxy http://127.0.0.1:7890

# 永久配置（~/.pip/pip.ini）
[global]
proxy = http://127.0.0.1:7890
```

### curl/wget 代理

```bash
# curl 临时使用
curl -x http://127.0.0.1:7890 https://google.com

# curl 永久配置（~/.curlrc）
proxy = http://127.0.0.1:7890

# wget 临时使用
wget -e use_proxy=yes -e http_proxy=127.0.0.1:7890 https://google.com

# wget 永久配置（~/.wgetrc）
use_proxy = on
http_proxy = 127.0.0.1:7890
https_proxy = 127.0.0.1:7890
```

### 环境变量代理（通用）

```bash
# Windows PowerShell
$env:HTTP_PROXY = "http://127.0.0.1:7890"
$env:HTTPS_PROXY = "http://127.0.0.1:7890"
$env:ALL_PROXY = "socks5://127.0.0.1:7891"

# Windows CMD
set HTTP_PROXY=http://127.0.0.1:7890
set HTTPS_PROXY=http://127.0.0.1:7890

# Linux/Mac
export HTTP_PROXY="http://127.0.0.1:7890"
export HTTPS_PROXY="http://127.0.0.1:7890"
export ALL_PROXY="socks5://127.0.0.1:7891"

# 绕过本地地址
export NO_PROXY="localhost,127.0.0.1,192.168.0.0/16,10.0.0.0/8"
```

## 常用端口

| 服务 | 端口 |
|------|------|
| Clash HTTP/SOCKS | 7890 |
| Clash SOCKS5 | 7891 |
| Clash Dashboard | 9090 |
| OpenClash | 9090 |
| Shadowsocks | 8388 |
| V2Ray | 10086 |

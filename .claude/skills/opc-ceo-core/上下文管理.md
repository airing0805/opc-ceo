# 上下文管理

## 功能概述

管理会话状态、历史记录和全局上下文，确保对话连续性和信息完整性。

## 操作命令

### 命令 1：保存上下文

**用途**：保存当前会话的上下文状态到知识图谱

**语法**：
```
保存上下文:
- 会话ID: <会话标识>
- 用户意图: <意图描述>
- 当前任务: [任务列表]
- 状态信息: <状态描述>
- 时间戳: <时间>
```

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| 会话ID | string | 是 | 会话唯一标识 |
| 用户意图 | string | 是 | 用户当前意图 |
| 当前任务 | array | 是 | 进行中的任务列表 |
| 状态信息 | string | 是 | 当前状态描述 |
| 时间戳 | string | 是 | ISO 8601 格式时间 |

**示例**：
```
保存上下文:
- 会话ID: SESSION-2026-02-23-001
- 用户意图: 创建新角色并设置能力边界
- 当前任务: [TASK-2026-02-23-001, TASK-2026-02-23-002]
- 状态信息: 正在创建角色设计文档
- 时间戳: 2026-02-23T10:30:00
```

### 命令 2：恢复上下文

**用途**：从知识图谱恢复之前的会话上下文

**语法**：
```
恢复上下文:
- 会话ID: <会话标识>
```

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| 会话ID | string | 是 | 要恢复的会话ID |

**示例**：
```
恢复上下文:
- 会话ID: SESSION-2026-02-23-001
```

### 命令 3：查询历史

**用途**：查询历史上下文记录

**语法**：
```
查询历史:
- 类型: <类型>
- 时间范围: <范围>
- 关键词: [关键词列表]
```

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| 类型 | string | 否 | Context/Decision/Task 等 |
| 时间范围 | string | 否 | 如 "2026-02-23" 或 "最近7天" |
| 关键词 | array | 否 | 搜索关键词 |

**示例**：
```
查询历史:
- 类型: Context
- 时间范围: 2026-02-23
- 关键词: [角色创建, 能力边界]
```

## MCP Memory 使用

### 创建上下文实体

```
使用 mcp__memory__create_entities:
{
  "name": "SESSION-2026-02-23-001",
  "entityType": "Context",
  "observations": [
    "userIntent: 创建新角色并设置能力边界",
    "currentTasks: [TASK-2026-02-23-001, TASK-2026-02-23-002]",
    "state: 正在创建角色设计文档",
    "timestamp: 2026-02-23T10:30:00",
    "activeRoles: [opc-ceo-core]"
  ]
}
```

### 查询上下文

```
使用 mcp__memory__open_nodes:
names: ["SESSION-2026-02-23-001"]
```

### 搜索历史记录

```
使用 mcp__memory__search_nodes:
query: "角色创建 能力边界"
```

## 上下文管理质量

### 评估维度

| 维度 | 合格 | 优秀 | 卓越 |
|------|------|------|------|
| 完整性 | 不遗漏关键信息 | 信息全面 | 信息完整且有备份 |
| 准确性 | 无错误 | 信息准确 | 信息精准 |
| 可检索性 | 可查到历史 | 可快速检索 | 可精准检索 |
| 可恢复性 | 可恢复上下文 | 可快速恢复 | 可选择性恢复 |

## 上下文生命周期

```
创建 ──► 更新 ──► 归档
  │        │        │
  ▼        ▼        ▼
激活状态  活跃状态  静态存储
```

### 状态说明

| 状态 | 说明 |
|------|------|
| 创建 | 新上下文初始化 |
| 更新 | 上下文信息变化时更新 |
| 归档 | 会话结束，归档存储 |
| 激活 | 当前使用的上下文 |
| 活跃 | 最近使用的上下文 |
| 静态 | 归档的上下文 |

## 最佳实践

1. **定期保存** - 每次重要操作后保存上下文
2. **结构化存储** - 使用一致的格式存储
3. **及时清理** - 定期清理过期上下文
4. **备份重要** - 重要上下文创建备份

## 错误处理

| 错误类型 | 处理方式 |
|----------|----------|
| 上下文丢失 | 尝试从历史记录恢复 |
| 状态不一致 | 以最新保存的状态为准 |
| 查询失败 | 扩大查询范围或提示用户 |

## 相关模块

- [决策支持](决策支持.md) - 决策记录作为上下文一部分
- [协调流程](协调流程.md) - 协调信息加入上下文

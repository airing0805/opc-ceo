---
name: troubleshooting
description: 故障排查 - 网络、Git、Claude Code 问题诊断与解决
version: 1.0.0
parent: devops-engineer
---

# 故障排查

## 网络问题

### 基础诊断

```bash
# 测试网络连接
ping 8.8.8.8
ping google.com
ping github.com

# 测试 DNS
nslookup github.com
nslookup api.anthropic.com
nslookup registry.npmjs.org

# 测试端口
telnet github.com 443
# 或 PowerShell
Test-NetConnection github.com -Port 443
```

### DNS 问题

```powershell
# 刷新 DNS 缓存
ipconfig /flushdns

# 查看 DNS 缓存
ipconfig /displaydns

# 修改 DNS 服务器
# 控制面板 > 网络和共享中心 > 更改适配器设置
# 属性 > Internet 协议版本 4 (TCP/IPv4)
# 使用 DNS: 8.8.8.8, 8.8.4.4 或 114.114.114.114

# 通过命令行
netsh interface ip set dns "以太网" static 8.8.8.8 primary
netsh interface ip add dns "以太网" 8.8.4.4 index=2
```

### 网络重置

```powershell
# 重置网络栈
netsh winsock reset
netsh int ip reset

# 重置防火墙
netsh advfirewall reset

# 清除 ARP 缓存
netsh interface ip delete arpcache

# 重置 IP 配置
ipconfig /release
ipconfig /renew

# 重启网络适配器
Restart-NetAdapter -Name "以太网"
```

### 代理问题

```bash
# 检查代理设置
netsh winhttp show proxy

# 检查环境变量
echo $env:HTTP_PROXY
echo $env:HTTPS_PROXY

# 测试代理
curl -x http://127.0.0.1:7890 https://google.com

# 临时禁用代理
$env:HTTP_PROXY = ""
$env:HTTPS_PROXY = ""
```

### 端口占用

```powershell
# 查看端口占用
netstat -ano | findstr :8080
netstat -ano | findstr :443

# 查看进程详情
Get-Process -Id <PID>

# 结束占用端口的进程
taskkill /PID <PID> /F

# 使用 PowerShell
$port = Get-NetTCPConnection -LocalPort 8080
Stop-Process -Id $port.OwningProcess -Force
```

## Git 问题

### SSH 连接问题

```bash
# 测试 SSH 连接
ssh -T git@github.com
ssh -T git@gitee.com

# 详细输出
ssh -vT git@github.com

# 检查 SSH agent
eval "$(ssh-agent -s)"
ssh-add -l

# 添加密钥
ssh-add ~/.ssh/id_ed25519

# 检查 known_hosts
cat ~/.ssh/known_hosts

# 重新生成 known_hosts
ssh-keyscan github.com >> ~/.ssh/known_hosts
```

### 认证问题

```bash
# 检查凭据配置
git config --global credential.helper

# 清除缓存的凭据
# Windows: 控制面板 > 凭据管理器 > Windows 凭据
# 删除 git:https://github.com 相关凭据

# 重新配置凭据管理器
git config --global credential.helper manager

# 使用 Token
# GitHub > Settings > Developer settings > Personal access tokens
# 生成新 token，使用 token 作为密码
```

### 推送/拉取问题

```bash
# 检查远程配置
git remote -v

# 更新远程地址
git remote set-url origin https://github.com/user/repo.git
git remote set-url origin git@github.com:user/repo.git

# 强制更新（谨慎使用）
git fetch origin
git reset --hard origin/main

# 解决冲突
git status
git diff
git add .
git commit -m "Resolve conflicts"

# 撤销未提交的更改
git checkout -- .
git clean -fd
```

### 大文件问题

```bash
# 安装 Git LFS
git lfs install

# 跟踪大文件
git lfs track "*.psd"
git lfs track "*.zip"

# 查看跟踪
git lfs track

# 推送 LFS
git lfs push --all origin
```

### 仓库损坏

```bash
# 检查仓库完整性
git fsck

# 修复损坏
git fsck --full
git gc --prune=now

# 重新克隆
rm -rf .git
git init
git remote add origin <url>
git fetch
git reset --hard origin/main
```

## Claude Code 问题

### 安装问题

```bash
# 检查 Node.js 版本
node --version  # 需要 18+

# 检查 npm
npm --version

# 清除 npm 缓存
npm cache clean --force

# 重新安装
npm uninstall -g @anthropic-ai/claude-code
npm install -g @anthropic-ai/claude-code

# 检查安装位置
which claude
where claude
```

### API Key 问题

```bash
# 检查环境变量
echo $env:ANTHROPIC_API_KEY

# 设置 API Key
# 方式 1: 环境变量
$env:ANTHROPIC_API_KEY = "your-api-key"

# 方式 2: 配置文件
claude config set apiKey YOUR_API_KEY

# 方式 3: settings.json
# 添加到 env 配置
```

### 权限问题

```json
// settings.json 权限配置
{
  "permissions": {
    "allow": [
      "Bash(*)",
      "Read(*)",
      "Write(*)",
      "Edit(*)"
    ]
  }
}
```

```bash
# 检查文件权限
ls -la ~/.claude/

# 修复权限（Linux/Mac）
chmod 700 ~/.claude
chmod 600 ~/.claude/settings.json
```

### 缓存问题

```bash
# 清除缓存
rm -rf ~/.claude/cache

# 清除所有本地数据（谨慎）
rm -rf ~/.claude

# 重新初始化
claude config init
```

### 日志查看

```bash
# 日志位置
# Windows: %APPDATA%\claude-code\logs\
# Mac/Linux: ~/.claude-code/logs/

# 查看最新日志
Get-Content "$env:APPDATA\claude-code\logs\latest.log" -Tail 50

# 实时日志
Get-Content "$env:APPDATA\claude-code\logs\latest.log" -Wait
```

## Docker 问题

### Docker 无法启动

```powershell
# 检查服务状态
Get-Service -Name com.docker.service

# 重启 Docker 服务
Restart-Service com.docker.service

# 检查 WSL
wsl --list --verbose
wsl --shutdown
# 然后重启 Docker Desktop
```

### 镜像拉取失败

```bash
# 检查网络
ping hub.docker.com

# 配置镜像加速
# 编辑 Docker Desktop 设置或 daemon.json

# 手动拉取
docker pull --platform linux/amd64 nginx

# 使用代理
export HTTP_PROXY=http://127.0.0.1:7890
docker pull nginx
```

### 容器问题

```bash
# 查看容器日志
docker logs container_name
docker logs --tail 100 container_name

# 进入容器调试
docker exec -it container_name sh

# 检查容器状态
docker inspect container_name

# 资源使用
docker stats container_name
```

### 磁盘空间问题

```bash
# 查看磁盘使用
docker system df

# 清理
docker system prune -a
docker volume prune

# 删除悬空镜像
docker image prune

# 删除停止的容器
docker container prune
```

## Python 问题

### 包安装问题

```bash
# 升级 pip
python -m pip install --upgrade pip

# 清除缓存
pip cache purge

# 使用镜像
pip install package -i https://pypi.tuna.tsinghua.edu.cn/simple

# 强制重装
pip install --force-reinstall package

# 依赖冲突
pip install pipdeptree
pipdeptree
```

### 虚拟环境问题

```bash
# 重新创建虚拟环境
rm -rf .venv
python -m venv .venv
.\.venv\Scripts\activate
pip install -r requirements.txt

# 检查环境
which python
pip list
```

## Node.js 问题

### npm 安装问题

```bash
# 清除缓存
npm cache clean --force

# 删除 node_modules
rm -rf node_modules package-lock.json
npm install

# 使用镜像
npm config set registry https://registry.npmmirror.com

# 权限问题（Linux/Mac）
sudo chown -R $(whoami) ~/.npm
sudo chown -R $(whoami) /usr/local/lib/node_modules
```

### 版本问题

```bash
# 检查版本
node --version
npm --version

# 使用 nvm 切换版本
nvm list
nvm use 20
nvm install 20

# 更新 npm
npm install -g npm@latest
```

## 系统问题

### 磁盘空间不足

```powershell
# 查看磁盘使用
Get-Volume
Get-PSDrive -PSProvider FileSystem

# 查找大文件
Get-ChildItem -Path C:\ -Recurse -ErrorAction SilentlyContinue | 
  Sort-Object Length -Descending | 
  Select-Object -First 20 FullName, @{N='Size(MB)';E={[math]::Round($_.Length/1MB,2)}}

# 清理系统
cleanmgr /d C:
Remove-Item -Path "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
```

### 内存问题

```powershell
# 查看内存使用
Get-Process | Sort-Object WorkingSet -Descending | Select-Object Name, @{N='Memory(MB)';E={[math]::Round($_.WorkingSet/1MB,2)}} -First 20

# 清理内存
[System.GC]::Collect()
```

### CPU 占用高

```powershell
# 查看 CPU 使用
Get-Process | Sort-Object CPU -Descending | Select-Object Name, CPU -First 20

# 结束进程
Stop-Process -Name "process_name" -Force
Stop-Process -Id <PID> -Force
```

## 快速诊断脚本

```powershell
# diagnostic.ps1 - 系统诊断脚本

Write-Host "=== System Diagnostic ===" -ForegroundColor Green

# 网络检查
Write-Host "`n[Network]" -ForegroundColor Yellow
Test-NetConnection github.com -Port 443 -InformationLevel Quiet
Test-NetConnection google.com -Port 443 -InformationLevel Quiet

# DNS 检查
Write-Host "`n[DNS]" -ForegroundColor Yellow
nslookup github.com

# Git 检查
Write-Host "`n[Git]" -ForegroundColor Yellow
git --version
ssh -T git@github.com 2>&1

# Node.js 检查
Write-Host "`n[Node.js]" -ForegroundColor Yellow
node --version
npm --version

# Python 检查
Write-Host "`n[Python]" -ForegroundColor Yellow
python --version
pip --version

# Docker 检查
Write-Host "`n[Docker]" -ForegroundColor Yellow
docker --version
docker info 2>&1 | Select-String "Server Version"

# Claude Code 检查
Write-Host "`n[Claude Code]" -ForegroundColor Yellow
claude --version 2>&1

# 磁盘空间
Write-Host "`n[Disk Space]" -ForegroundColor Yellow
Get-Volume | Format-Table DriveLetter, FileSystemLabel, @{N='Size(GB)';E={[math]::Round($_.Size/1GB,2)}}, @{N='Free(GB)';E={[math]::Round($_.SizeRemaining/1GB,2)}}

Write-Host "`n=== Diagnostic Complete ===" -ForegroundColor Green
```

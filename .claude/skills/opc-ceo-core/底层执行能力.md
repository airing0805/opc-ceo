# 底层执行能力

> 本文档记录 CEO 的具体操作流程和工具使用规范，V8.0 新增完整错误处理流程。

---

## 概述

CEO 作为一人公司的总控中心，必须具备高效执行底层操作的能力。本文档详细记录各类操作的具体流程、工具选择决策树和执行检查清单。

**核心原则**：
1. **MCP 工具优先** - 文档操作优先使用 MCP 工具
2. **主动思考，被动执行** - 思考要深入，执行要等待确认
3. **并行优先** - 识别可并行任务，提高执行效率

---

## 一、工具选择决策树

> V8.0 增强：更详细的判断条件和备选方案

### 1.1 完整工具选择决策树（V8.0）

```
任务输入
    │
    ├── 操作类型判断
    │   │
    │   ├── 文档操作
    │   │   │
    │   │   ├── 读取 → mcp__filesystem__read_file（首选）
    │   │   │         └── 失败 → Read 工具
    │   │   │
    │   │   ├── 写入 → mcp__filesystem__write_file（首选）
    │   │   │         └── 失败 → Write 工具
    │   │   │
    │   │   └── 编辑 → Edit 工具（精确替换首选）
    │   │             └── 失败 → mcp__filesystem__edit_file
    │   │
    │   ├── 文件系统
    │   │   │
    │   │   ├── 搜索文件 → Glob（首选）
    │   │   │             └── 失败 → mcp__filesystem__search_files
    │   │   │
    │   │   ├── 搜索内容 → Grep（首选）
    │   │   │             └── 失败 → Bash grep
    │   │   │
    │   │   └── 目录操作 → mcp__filesystem__list_directory（首选）
    │   │                 └── 失败 → Bash ls
    │   │
    │   ├── Memory 操作
    │   │   │
    │   │   ├── 创建 → mcp__memory__create_entities
    │   │   ├── 查询 → mcp__memory__search_nodes
    │   │   ├── 更新 → mcp__memory__add_observations
    │   │   └── 关联 → mcp__memory__create_relations
    │   │
    │   └── 系统操作
    │       └── Git / NPM / 其他 → Bash
    │
    └── 复杂度判断（决定执行路径）
        │
        ├── L1 (< 2) → 直接执行
        │              └── 单文件、简单查询、无依赖
        │
        ├── L2 (2-4) → MCP 工具优先
        │              └── 文档创建/编辑、Memory 操作
        │
        ├── L3 (4-6) → Agent 执行
        │              └── 跨文件、知识推理、中等复杂度
        │
        ├── L4 (6-8) → Team 协调
        │              └── 多角色、复杂流程、依赖管理
        │
        └── L5 (> 8) → 拆分 + 递归
                       └── 超复杂任务分解为子任务
```

### 1.2 文档操作决策树

```
文档操作需求
    │
    ├── 读取文档
    │   ├── 单文件 → mcp__filesystem__read_file（首选）
    │   │           └── 备选：Read 工具
    │   └── 多文件 → mcp__filesystem__read_multiple_files
    │
    ├── 写入文档
    │   ├── 创建新文档 → mcp__filesystem__write_file（首选）
    │   │               └── 备选：Write 工具
    │   └── 覆盖文档 → mcp__filesystem__write_file
    │
    ├── 编辑文档
    │   ├── 精确替换 → Edit 工具（首选）
    │   │             └── 备选：mcp__filesystem__edit_file
    │   └── 复杂修改 → 读取 → 修改 → 写入
    │
    └── 搜索文档
        ├── 按名称 → mcp__filesystem__search_files
        │             └── 备选：Glob 工具
        └── 按内容 → Grep 工具
```

### 1.3 Memory 操作决策树

```
Memory 操作需求
    │
    ├── 创建记录
    │   ├── 任务 → create_entities (entityType: "Task")
    │   ├── 决策 → create_entities (entityType: "Decision")
    │   ├── 日志 → create_entities (entityType: "ExecutionLog")
    │   └── 进化 → create_entities (entityType: "SelfReflection")
    │
    ├── 查询记录
    │   ├── 模糊搜索 → search_nodes
    │   └── 完整图谱 → read_graph
    │
    ├── 更新记录
    │   └── 添加观察 → add_observations
    │
    └── 关联记录
        └── 创建关系 → create_relations
```

### 1.4 任务执行路径决策树

```
任务输入
    │
    ├── 复杂度评分
    │   │
    │   ├── L1 (< 2) → 直接执行
    │   │              └── 单文件、简单查询
    │   │
    │   ├── L2 (2-4) → MCP 工具优先
    │   │              └── 文档创建/编辑
    │   │
    │   ├── L3 (4-6) → Agent 执行
    │   │              └── 跨文件、知识推理
    │   │
    │   ├── L4 (6-8) → Team 协调
    │   │              └── 多角色、复杂流程
    │   │
    │   └── L5 (> 8) → 拆分+递归
    │                   └── 超复杂任务分解
    │
    └── 依赖分析
        ├── 无依赖 → 可并行执行
        └── 有依赖 → 按顺序执行
```

---

## 二、文档操作流程

### 2.1 读取文档

**首选工具**: `mcp__filesystem__read_file`

> **重要**: 根据项目规范，当前电脑环境 Direct 编辑/写入有问题，所有文档操作**优先使用 MCP 工具**。

#### 使用场景

| 场景 | 说明 |
|------|------|
| 读取任务分配 | 获取当前任务状态和角色负载 |
| 读取战略目标 | 了解当前战略方向 |
| 读取版本规划 | 查看具体规划内容 |
| 读取执行日志 | 了解历史执行记录 |

#### 工具调用示例

```json
// 读取任务分配文档
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md"
})

// 读取战略目标文档
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/战略规划/战略目标.md"
})

// 读取版本规划
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/版本规划/v2-技能规划/README.md"
})

// 读取执行日志
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/执行日志/2026-02-26.md"
})
```

#### 备选工具

当 MCP 工具不可用时，使用内置 `Read` 工具：

```json
Read({
  "file_path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md"
})
```

### 2.2 写入文档

**首选工具**: `mcp__filesystem__write_file`

#### 使用场景

| 场景 | 说明 |
|------|------|
| 创建新文档 | 创建新的规划文档或记录 |
| 记录协调事件 | 写入协调记录文档 |
| 保存执行日志 | 记录操作过程 |
| 更新任务状态 | 完全重写任务文档 |

#### 工具调用示例

```json
// 写入新文档
mcp__filesystem__write_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/协调记录.md",
  "content": "# 协调记录\n\n## COORD-2026-02-26-001\n\n**时间**: 2026-02-26\n**类型**: 任务分配协调\n**内容**: ...\n"
})

// 写入执行日志
mcp__filesystem__write_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/执行日志/2026-02-26.md",
  "content": "# 执行日志 - 2026-02-26\n\n## 完成的任务\n- v2.3.1.1 创建底层执行能力.md\n"
})
```

### 2.3 编辑文档

**首选工具**: `Edit`（精确字符串替换）

#### 使用场景

| 场景 | 说明 |
|------|------|
| 修改任务状态 | 替换"待执行"为"已完成" |
| 追加新任务 | 在任务列表中添加新行 |
| 更新特定字段 | 修改某个特定值 |

#### 工具调用示例

```json
// 编辑文档（替换特定内容）
Edit({
  "file_path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md",
  "old_string": "| v2.3.1.1 | 待执行 |",
  "new_string": "| v2.3.1.1 | 已完成 |"
})

// 追加新任务到任务列表
Edit({
  "file_path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md",
  "old_string": "<!-- 新任务在此添加 -->",
  "new_string": "| v2.4.1.1 | 新增能力模块 | 待执行 | opc-ceo-core | 2026-02-26 |\n\n<!-- 新任务在此添加 -->"
})
```

### 2.4 批量读取文档

**工具**: `mcp__filesystem__read_multiple_files`

#### 使用场景

需要同时读取多个文件时使用，提高效率。

#### 工具调用示例

```json
// 批量读取多个文件
mcp__filesystem__read_multiple_files({
  "paths": [
    "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md",
    "E:/workspaces_2026_python/OPC-CEO/docs/战略规划/战略目标.md",
    "E:/workspaces_2026_python/OPC-CEO/docs/执行日志/2026-02-26.md"
  ]
})
```

### 2.5 文档操作最佳实践

```
1. 优先使用 MCP 工具（mcp__filesystem__*）
2. 使用绝对路径，避免相对路径问题
3. 写入前先读取确认内容格式
4. 批量操作时分步执行，每步验证
5. 重要操作前备份原文档内容
6. 复杂编辑先在临时文件中测试
7. 使用中文文件名（符合项目规范）
```

---

## 三、Memory 操作流程

### 3.1 创建实体

**工具**: `mcp__memory__create_entities`

#### CEO 常用实体类型

| 实体类型 | 用途 | 命名格式 |
|----------|------|----------|
| Task | 任务记录 | TASK-v2.x.y |
| Decision | 决策记录 | DECISION-YYYY-MM-DD-NNN |
| ExecutionLog | 执行日志 | LOG-YYYY-MM-DD-NNN |
| SelfReflection | 自我反思 | REFLECT-YYYY-MM-DD-NNN |
| ErrorPattern | 错误模式 | ERROR-PATTERN-NNN |
| CoordinationEvent | 协调事件 | COORD-YYYY-MM-DD-NNN |
| TaskDistribution | 任务分发 | DIST-YYYY-MM-DD-NNN |

#### 工具调用示例

```json
// 创建任务实体
mcp__memory__create_entities({
  "entities": [
    {
      "name": "TASK-v2.3.1.1",
      "entityType": "Task",
      "observations": [
        "description: 创建 CEO 底层执行能力.md",
        "status: in_progress",
        "assignedTo: opc-ceo-core",
        "priority: high",
        "createdAt: 2026-02-26T10:00:00",
        "dueDate: 2026-02-26"
      ]
    }
  ]
})

// 创建决策记录
mcp__memory__create_entities({
  "entities": [
    {
      "name": "DECISION-2026-02-26-001",
      "entityType": "Decision",
      "observations": [
        "context: CEO 能力增强",
        "decision: 创建底层执行能力.md 文档",
        "reason: V6.1 进化计划",
        "impact: 提升 CEO 独立执行能力",
        "timestamp: 2026-02-26T10:00:00"
      ]
    }
  ]
})

// 创建执行日志
mcp__memory__create_entities({
  "entities": [
    {
      "name": "LOG-2026-02-26-001",
      "entityType": "ExecutionLog",
      "observations": [
        "taskId: TASK-v2.3.1.1",
        "executionPath: L2-MCP工具优先",
        "complexityScore: 3",
        "result: 成功",
        "duration: 120秒",
        "decisionPoints: [\"使用MCP工具\", \"并行读取模板\"]",
        "lessons: \"模板参考提高效率\""
      ]
    }
  ]
})

// 创建任务分发记录（V5.0 新增）
mcp__memory__create_entities({
  "entities": [
    {
      "name": "DIST-2026-02-26-001",
      "entityType": "TaskDistribution",
      "observations": [
        "taskId: TASK-v2.3.1.1",
        "assignedTo: opc-ceo-core",
        "distributionLevel: L2",
        "reason: 文档创建任务，适合MCP工具执行",
        "timestamp: 2026-02-26T10:00:00"
      ]
    }
  ]
})
```

### 3.2 查询实体

**工具**: `mcp__memory__search_nodes`

#### 使用场景

| 场景 | 查询关键词 |
|------|------------|
| 检查 Memory 状态 | "company status task project" |
| 查找特定任务 | "TASK-v2.3" |
| 查找决策记录 | "DECISION-2026-02" |
| 查找执行日志 | "LOG-2026-02" |
| 查找错误模式 | "ERROR-PATTERN" |

#### 工具调用示例

```json
// 启动自检 - 检查 Memory 状态
mcp__memory__search_nodes({
  "query": "company status task project"
})

// 查找特定任务
mcp__memory__search_nodes({
  "query": "TASK-v2.3.1"
})

// 查找当天的决策记录
mcp__memory__search_nodes({
  "query": "DECISION-2026-02-26"
})

// 查找执行日志
mcp__memory__search_nodes({
  "query": "LOG-2026-02"
})

// 查找所有任务
mcp__memory__search_nodes({
  "query": "Task"
})
```

### 3.3 查看完整图谱

**工具**: `mcp__memory__read_graph`

#### 使用场景

当需要了解 Memory 中的所有实体和关系时使用。

#### 工具调用示例

```json
// 读取完整 Memory 图谱
mcp__memory__read_graph({})
```

### 3.4 添加观察记录

**工具**: `mcp__memory__add_observations`

#### 使用场景

| 场景 | 说明 |
|------|------|
| 更新任务状态 | 修改任务的 status 观察 |
| 添加进展记录 | 为实体添加新的观察 |
| 记录执行结果 | 添加完成时间等信息 |

#### 工具调用示例

```json
// 更新任务状态
mcp__memory__add_observations({
  "observations": [
    {
      "entityName": "TASK-v2.3.1.1",
      "contents": [
        "status: completed",
        "completedAt: 2026-02-26T11:00:00",
        "result: 成功创建底层执行能力.md"
      ]
    }
  ]
})

// 为执行日志添加教训
mcp__memory__add_observations({
  "observations": [
    {
      "entityName": "LOG-2026-02-26-001",
      "contents": [
        "lesson: 模板参考可以显著提高文档创建效率",
        "improvement: 建立常用模板库"
      ]
    }
  ]
})
```

### 3.5 创建关系

**工具**: `mcp__memory__create_relations`

#### CEO 常用关系类型

| 关系类型 | 用途 | 示例 |
|----------|------|------|
| depends_on | 任务依赖 | Task A depends_on Task B |
| assigned_to | 任务分配 | Task assigned_to Role |
| triggered_by | 触发关系 | Task triggered_by Decision |
| results_in | 结果关系 | Task results_in ExecutionLog |
| parallel_with | 可并行（V5.0） | Task A parallel_with Task B |

#### 工具调用示例

```json
// 创建任务与决策的关系
mcp__memory__create_relations({
  "relations": [
    {
      "from": "TASK-v2.3.1.1",
      "to": "DECISION-2026-02-26-001",
      "relationType": "triggered_by"
    }
  ]
})

// 创建任务与日志的关系
mcp__memory__create_relations({
  "relations": [
    {
      "from": "TASK-v2.3.1.1",
      "to": "LOG-2026-02-26-001",
      "relationType": "results_in"
    }
  ]
})

// 创建可并行任务关系（V5.0 新增）
mcp__memory__create_relations({
  "relations": [
    {
      "from": "TASK-v2.3.1.1",
      "to": "TASK-v2.3.1.2",
      "relationType": "parallel_with"
    }
  ]
})
```

### 3.6 Memory 操作最佳实践

```
1. 实体命名遵循规范（见实体 ID 命名规范）
2. 创建实体时包含完整观察字段
3. 重要操作同时记录到 Memory 和文档
4. 定期检查 Memory 状态，必要时重建
5. 关系创建前确认两个实体都存在
6. 避免重复创建相同实体
7. 任务分发记录包含分发级别和原因
```

---

## 四、Git 操作流程

### 4.1 常用 Git 命令

**工具**: `Bash`

#### 状态查看

```json
// 查看状态
Bash({ "command": "git status" })

// 查看差异
Bash({ "command": "git diff" })

// 查看日志
Bash({ "command": "git log --oneline -10" })

// 查看当前分支
Bash({ "command": "git branch" })

// 查看远程仓库
Bash({ "command": "git remote -v" })
```

### 4.2 提交流程

```json
// 步骤1: 查看状态
Bash({ "command": "git status" })

// 步骤2: 添加文件
Bash({ "command": "git add 文件路径" })

// 步骤3: 提交
Bash({ "command": "git commit -m \"feat: 提交信息\"" })

// 步骤4: 查看提交结果
Bash({ "command": "git log --oneline -1" })
```

### 4.3 Git 提交规范

| 类型 | 说明 | 示例 |
|------|------|------|
| feat | 新功能 | feat: 新增底层执行能力模块 |
| fix | 修复 | fix: 修复任务分发逻辑 |
| docs | 文档 | docs: 更新 SKILL.md |
| refactor | 重构 | refactor: 优化决策树 |
| chore | 杂项 | chore: 更新版本号 |

---

## 五、并行任务执行

### 5.1 识别可并行任务

**并行识别算法**：

```
步骤 1: 构建任务依赖图
  - 分析任务间的依赖关系
  - 标记数据依赖和资源依赖

步骤 2: 识别并行层
  - Layer 0: 无依赖的任务
  - Layer 1: 只依赖 Layer 0 的任务
  - Layer N: 只依赖 Layer N-1 的任务

步骤 3: 生成执行计划
  - 同一 Layer 内的任务可并行执行
  - 不同 Layer 的任务按顺序执行
```

### 5.2 并行识别规则

| 条件 | 判定 | 处理 |
|------|------|------|
| 任务间无依赖 | 可并行 | 同时执行 |
| 任务间有依赖 | 串行 | 按依赖顺序 |
| 共享资源 | 谨慎并行 | 资源锁定 |
| 相同角色执行 | 串行化 | 避免冲突 |

### 5.3 使用 Task 工具启动 Subagent

当需要并行执行多个独立任务时，使用 Task 工具启动 subagent。

#### 并行执行示例

```json
// 场景：同时读取多个文件和检查 Memory 状态

// 任务1: 读取任务分配（可并行）
Task({
  "description": "读取任务分配文档",
  "prompt": "读取 E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md，提取待执行任务列表"
})

// 任务2: 检查 Memory 状态（可并行）
Task({
  "description": "检查 Memory 状态",
  "prompt": "使用 mcp__memory__search_nodes 检查 Memory 状态，查询 'company status task project'"
})

// 任务3: 读取战略目标（可并行）
Task({
  "description": "读取战略目标",
  "prompt": "读取 E:/workspaces_2026_python/OPC-CEO/docs/战略规划/战略目标.md，提取当前战略重点"
})
```

### 5.4 并行执行最佳实践

```
1. 识别无依赖任务 - 优先并行执行
2. 合理分组 - 相关任务放同一组
3. 资源隔离 - 避免资源竞争
4. 错误隔离 - 单个任务失败不影响其他
5. 结果汇总 - 并行完成后统一处理结果
6. 记录到 Memory - 使用 parallel_with 关系
```

---

## 六、MCP 工具优先级

### 6.1 工具选择矩阵

| 操作类型 | 首选工具 | 备选工具 | 说明 |
|----------|----------|----------|------|
| 文档读取 | mcp__filesystem__read_file | Read | MCP 优先，解决环境问题 |
| 文档写入 | mcp__filesystem__write_file | Write | MCP 优先 |
| 文档编辑 | Edit | mcp__filesystem__edit_file | Edit 适合精确替换 |
| 批量读取 | mcp__filesystem__read_multiple_files | 多次 Read | 提高效率 |
| 文件搜索 | Glob | Bash find | 更友好的输出格式 |
| 内容搜索 | Grep | Bash grep | 更友好的输出格式 |
| 目录列表 | mcp__filesystem__list_directory | Bash ls | MCP 优先 |
| 目录树 | mcp__filesystem__directory_tree | - | 唯一选择 |
| 命令执行 | Bash | - | Git 操作、目录管理 |
| Memory 查询 | mcp__memory__search_nodes | - | 唯一选择 |
| Memory 创建 | mcp__memory__create_entities | - | 唯一选择 |
| Memory 更新 | mcp__memory__add_observations | - | 唯一选择 |

### 6.2 工具使用原则

```
1. MCP 工具优先 - 解决 Direct 编辑环境问题
2. 内置工具次之 - 作为备选方案
3. Bash 最后 - 仅用于系统操作
4. 避免混用 - 同一任务使用同类工具
5. Edit 精确编辑 - 字符串替换优先使用 Edit
```

---

## 七、常见操作场景示例

### 7.1 启动自检流程

**触发时机**: 每次唤醒 opc-ceo-core 时

**执行步骤**:

```
步骤1: 检查 Memory 状态
  工具: mcp__memory__search_nodes
  参数: { query: "company status task project" }
  判断: 若返回空，则需要从文档重建

步骤2: 检查 Git 状态
  工具: Bash
  命令: git status
  判断: 若有未提交变更，记录到日志

步骤3: 检查待办任务
  工具: mcp__filesystem__read_file
  路径: docs/沟通文档/任务分配.md
  判断: 识别未完成任务

步骤4: 检查关键文档
  工具: mcp__filesystem__read_file
  路径: docs/战略规划/战略目标.md
  判断: 确认文档存在且可读
```

**示例代码**:

```json
// 步骤1-4 可并行执行（无依赖）
mcp__memory__search_nodes({ "query": "company status task project" })
Bash({ "command": "git status" })
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md"
})
mcp__filesystem__read_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/战略规划/战略目标.md"
})
```

### 7.2 任务记录流程

**触发时机**: 与用户沟通确认任务后

**执行步骤**:

```
步骤1: 创建 Memory 实体
  工具: mcp__memory__create_entities
  内容: 创建 Task 实体

步骤2: 更新任务分配文档
  工具: mcp__filesystem__read_file + Edit
  内容: 追加新任务记录

步骤3: 记录决策（如有）
  工具: mcp__memory__create_entities
  内容: 创建 Decision 实体

步骤4: 创建关系
  工具: mcp__memory__create_relations
  内容: 关联任务与决策
```

### 7.3 执行日志记录流程

**触发时机**: 任务执行完成后

**执行步骤**:

```json
// 步骤1: 创建执行日志实体
mcp__memory__create_entities({
  "entities": [
    {
      "name": "LOG-2026-02-26-001",
      "entityType": "ExecutionLog",
      "observations": [
        "taskId: TASK-v2.3.1.1",
        "executionPath: L2-MCP工具优先",
        "complexityScore: 3",
        "result: 成功",
        "duration: 120秒",
        "decisionPoints: [\"使用MCP工具\", \"参考模板\"]",
        "lessons: \"模板参考提高效率\""
      ]
    }
  ]
})

// 步骤2: 创建任务与日志的关系
mcp__memory__create_relations({
  "relations": [
    {
      "from": "TASK-v2.3.1.1",
      "to": "LOG-2026-02-26-001",
      "relationType": "results_in"
    }
  ]
})

// 步骤3: 写入执行日志文档
mcp__filesystem__write_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/执行日志/2026-02-26.md",
  "content": "# 执行日志 - 2026-02-26\n\n## LOG-2026-02-26-001\n\n**任务**: v2.3.1.1\n**执行路径**: L2-MCP工具优先\n**结果**: 成功\n**耗时**: 120秒\n**决策点**: 使用MCP工具, 参考模板\n**教训**: 模板参考提高效率\n"
})
```

---

## 八、执行检查清单

### 8.1 任务执行前检查

```
□ 复杂度评分是否准确？
□ 执行路径是否最优？
□ 是否有遗漏的依赖关系？
□ 工具选择是否正确（MCP 优先）？
□ 是否已确认用户执行意图？
```

### 8.2 文档操作检查

```
□ 是否使用了 MCP 工具？（优先）
□ 是否使用了绝对路径？
□ 写入前是否读取确认格式？
□ 重要操作是否有备份？
□ 是否记录到 Memory？
□ 是否符合文档命名规范（中文命名）？
```

### 8.3 Memory 操作检查

```
□ 实体名称是否符合命名规范？
□ entityType 是否正确？
□ observations 是否包含必要字段？
□ 是否创建了必要的关系？
□ 是否同步到文档？
□ 是否避免了重复创建？
```

### 8.4 并行执行检查

```
□ 任务间是否真的无依赖？
□ 共享资源是否处理妥当？
□ 错误处理是否独立？
□ 结果汇总方式是否明确？
□ 是否记录 parallel_with 关系？
```

### 8.5 执行后检查

```
□ 是否记录到 Memory？
□ 是否同步到文档？
□ 是否更新任务状态？
□ 是否记录执行日志？
□ 是否复盘总结？
□ 是否有遗漏？
```

---

## 九、错误处理流程（V8.0 新增）

### 9.1 错误分类体系

| 错误类型 | 识别特征 | 严重程度 |
|----------|----------|----------|
| 工具错误 | 工具调用返回失败 | 中 |
| 路径错误 | 复杂度评分与实际不匹配 | 中 |
| 验证错误 | 输入/输出不符合预期 | 低 |
| 依赖错误 | 前置条件未满足 | 高 |
| 权限错误 | 无操作权限 | 高 |

### 9.2 工具错误处理

#### 9.2.1 工具错误识别

```json
// 错误响应示例
{
  "error": "Tool execution failed",
  "tool": "mcp__filesystem__read_file",
  "reason": "File not found or permission denied"
}
```

#### 9.2.2 自动处理策略

| 工具类型 | 首选失败后动作 | 备选失败后动作 |
|----------|----------------|----------------|
| 文档读取 | 尝试 Read 工具 | 检查路径是否存在 |
| 文档写入 | 尝试 Write 工具 | 检查目录权限 |
| 文档编辑 | 尝试 mcp__filesystem__edit_file | 重新读取后整体替换 |
| 文件搜索 | 尝试 Bash find | 检查路径有效性 |
| 内容搜索 | 尝试 Bash grep | 减少搜索范围 |

#### 9.2.3 工具错误处理流程

```
工具调用失败
    │
    ├── 记录错误信息
    │   └── 工具名称、错误类型、时间戳
    │
    ├── 尝试备选工具
    │   ├── 成功 → 继续执行
    │   └── 失败 → 进入下一步
    │
    ├── 诊断根因
    │   ├── 路径问题 → 修正路径
    │   ├── 权限问题 → 通知用户
    │   └── 工具问题 → 记录并汇报
    │
    └── 记录到执行日志
```

### 9.3 路径错误处理

#### 9.3.1 路径错误识别特征

| 特征 | 说明 |
|------|------|
| 实际耗时远超预估 | L2 任务耗时如 L4 |
| 需要额外工具 | 最初判断不足 |
| 任务范围扩大 | 执行中发现新需求 |
| 频繁回滚 | 判断与实际不符 |

#### 9.3.2 自动处理策略

```
检测到路径错误
    │
    ├── 暂停当前执行
    │
    ├── 重新评估复杂度
    │   └── 使用更详细评分矩阵
    │
    ├── 选择正确路径
    │   ├── 升级 → 转入更高级别执行路径
    │   └── 降级 → 简化执行方案
    │
    └── 记录调整原因
        └── 用于后续优化评分模型
```

### 9.4 验证错误处理

#### 9.4.1 验证错误类型

| 验证类型 | 检查内容 | 处理方式 |
|----------|----------|----------|
| 输入验证 | 参数格式、范围 | 立即修正 |
| 输出验证 | 结果完整性 | 补充缺失部分 |
| 格式验证 | 文档格式规范 | 自动格式化 |
| 业务验证 | 符合业务规则 | 通知确认 |

#### 9.4.2 验证错误处理流程

```
验证失败
    │
    ├── 识别验证类型
    │
    ├── 尝试自动修正
    │   ├── 成功 → 继续执行
    │   └── 失败 → 请求用户确认
    │
    └── 记录修正过程
```

### 9.5 依赖错误处理

#### 9.5.1 依赖错误类型

| 依赖类型 | 示例 | 处理优先级 |
|----------|------|------------|
| 数据依赖 | 需要其他任务输出 | 高 |
| 资源依赖 | 需要特定文件存在 | 高 |
| 环境依赖 | 需要特定工具可用 | 中 |
| 时序依赖 | 需要按顺序执行 | 中 |

#### 9.5.2 依赖错误处理流程

```
依赖未满足
    │
    ├── 识别缺失依赖
    │   └── 具体是什么依赖
    │
    ├── 评估解决方案
    │   ├── 可自动解决 → 执行解决方案
    │   │   ├── 创建缺失文件
    │   │   ├── 安装缺失工具
    │   │   └── 调整执行顺序
    │   │
    │   └── 需要用户介入 → 通知用户
    │
    └── 更新依赖图
```

### 9.6 权限错误处理

#### 9.6.1 权限错误识别

| 场景 | 错误信息 | 处理方式 |
|------|----------|----------|
| 文件只读 | "Permission denied" | 通知用户修改权限 |
| 目录不可写 | "Access denied" | 使用临时目录 |
| 工具受限 | "Tool not available" | 使用备选工具 |
| 网络受限 | "Connection refused" | 切换离线模式 |

#### 9.6.2 权限错误处理流程

```
权限错误
    │
    ├── 记录错误详情
    │
    ├── 尝试替代方案
    │   ├── 有替代方案 → 执行替代方案
    │   └── 无替代方案 → 通知用户
    │
    └── 建议用户操作
        └── 具体的权限修改建议
```

### 9.7 错误恢复检查清单

```
□ 错误类型是否正确识别？
□ 是否尝试了所有备选方案？
□ 根因分析是否完整？
□ 是否记录到执行日志？
□ 是否需要更新错误模式库？
□ 是否需要通知用户？
□ 恢复后是否验证结果？
```

---

## 十二、错误处理与重试（精简版）

> 本节为原有错误处理内容的精简版本，详细内容见第九章。

### 12.1 MCP 工具失败处理

当 MCP 工具调用失败时，按以下顺序处理：

```
1. 记录错误信息
2. 尝试备选工具（见工具选择矩阵）
3. 如仍失败，通知用户
4. 记录到执行日志
```

#### 备选方案表

| MCP 工具 | 备选工具 |
|----------|----------|
| mcp__filesystem__read_file | Read |
| mcp__filesystem__write_file | Write |
| mcp__filesystem__edit_file | Edit |
| mcp__filesystem__search_files | Glob |
| mcp__filesystem__list_directory | Bash ls |

### 12.2 Memory 操作失败处理

```
1. 检查实体是否已存在（使用 search_nodes）
2. 如已存在，使用 add_observations 更新
3. 如创建失败，检查字段格式
4. 记录失败原因到执行日志
```

### 12.3 常见错误模式

| 模式 | 识别特征 | 自动处理 |
|------|----------|----------|
| 路径选择错误 | 复杂度评分与实际不匹配 | 调整评分参数 |
| 依赖遗漏 | 执行时报错"依赖未满足" | 自动扫描依赖 |
| 角色边界不清 | Agent返回"超出能力范围" | 重新评估角色能力 |
| 上下文丢失 | 多次调用后上下文异常 | 触发快照恢复 |
| 工具选择错误 | MCP 工具失败 | 使用备选工具 |

---

## 十一、错误处理与重试（精简版）

> 本节为原有错误处理内容的精简版本，详细内容见第九章。

### 11.1 MCP 工具失败处理

当 MCP 工具调用失败时，按以下顺序处理：

```
1. 记录错误信息
2. 尝试备选工具（见工具选择矩阵）
3. 如仍失败，通知用户
4. 记录到执行日志
```

#### 备选方案表

| MCP 工具 | 备选工具 |
|----------|----------|
| mcp__filesystem__read_file | Read |
| mcp__filesystem__write_file | Write |
| mcp__filesystem__edit_file | Edit |
| mcp__filesystem__search_files | Glob |
| mcp__filesystem__list_directory | Bash ls |

### 11.2 Memory 操作失败处理

```
1. 检查实体是否已存在（使用 search_nodes）
2. 如已存在，使用 add_observations 更新
3. 如创建失败，检查字段格式
4. 记录失败原因到执行日志
```

### 11.3 常见错误模式

| 模式 | 识别特征 | 自动处理 |
|------|----------|----------|
| 路径选择错误 | 复杂度评分与实际不匹配 | 调整评分参数 |
| 依赖遗漏 | 执行时报错"依赖未满足" | 自动扫描依赖 |
| 角色边界不清 | Agent返回"超出能力范围" | 重新评估角色能力 |
| 上下文丢失 | 多次调用后上下文异常 | 触发快照恢复 |
| 工具选择错误 | MCP 工具失败 | 使用备选工具 |

---

## 十二、版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 8.0.0 | 2026-02-26 | V8.0 更新 - 增强工具选择决策树、新增完整错误处理流程章节 |
| 1.0.0 | 2026-02-26 | 初始版本 - 文档操作、Memory 操作、Git 操作、并行执行 |

---

## 相关模块

- [SKILL.md](SKILL.md) - 主入口文档
- [自我进化.md](自我进化.md) - 自我反思与持续改进
- [快速参考.md](快速参考.md) - 快速查阅手册
- [能力边界.md](能力边界.md) - 各角色能力范围

---

> opc-ceo-core V8.0 - 底层执行能力模块

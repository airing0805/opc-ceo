# 批量处理

## 功能概述

提供批量任务处理功能，包括任务队列、并发控制、结果汇总。

## 操作命令

### 命令 1：批量执行

**用途**：批量执行多个相同类型的任务

**语法**：
```
批量执行:
  - tasks: <任务列表>
  - concurrency: <并发数> (可选，默认3)
  - timeout: <超时时间> (可选，默认180秒)
```

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| tasks | array | 是 | 任务列表，每个任务包含类型和参数 |
| concurrency | number | 否 | 并发数，默认3 |
| timeout | number | 否 | 超时时间（秒），默认180 |

**任务格式**：

```json
{
  "type": "api_call|skill_call",
  "prompt": "提示词" (仅 api_call),
  "skill": "技能名" (仅 skill_call),
  "params": {"参数": "值"}
}
```

**示例**：

```json
{
  "tasks": [
    {"type": "api_call", "prompt": "分析文件A"},
    {"type": "api_call", "prompt": "分析文件B"},
    {"type": "api_call", "prompt": "分析文件C"}
  ],
  "concurrency": 2,
  "timeout": 120
}
```

---

### 命令 2：队列处理

**用途**：创建任务队列并按顺序处理

**语法**：
```
队列处理:
  - tasks: <任务列表>
  - queueName: <队列名称> (可选)
```

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| tasks | array | 是 | 任务列表 |
| queueName | string | 否 | 队列名称，用于跟踪 |

**示例**：

```json
{
  "tasks": [
    {"type": "skill_call", "skill": "task-manager", "params": {"action": "search"}},
    {"type": "skill_call", "skill": "file-manager", "params": {"action": "list"}}
  ],
  "queueName": "文件扫描"
}
```

---

### 命令 3：进度查询

**用途**：查询批量任务的执行进度

**语法**：
```
进度查询:
  - queueName: <队列名称>
```

**返回信息**：

- 总任务数
- 已完成数
- 进行中数
- 失败数
- 失败任务列表

**示例**：

```markdown
## 进度报告：文件扫描

- 总任务数: 10
- 已完成: 7
- 进行中: 2
- 失败: 1

### 失败任务
1. 文件D: 超时
```

---

## 并发控制

### 并发策略

| 策略 | 说明 |
|------|------|
| 固定并发 | 始终保持固定并发数 |
| 自适应并发 | 根据成功率动态调整 |
| 队列串行 | 单个队列内串行执行 |

### 并发数配置

| 场景 | 推荐并发数 |
|------|----------|
| API 调用 | 2-3 |
| 技能调用 | 1-2 |
| 文件操作 | 1-3 |

---

## 错误处理

### 重试机制

| 错误类型 | 重试策略 |
|---------|----------|
| 网络错误 | 指数退避重试 |
| API 错误 | 指数退避重试 |
| 超时 | 单次重试 |
| 参数错误 | 不重试，直接失败 |

### 重试配置

```
最大重试次数: 3
初始延迟: 1秒
退避因子: 2
最大延迟: 30秒
```

---

## 结果汇总

### 汇总格式

```markdown
## 批量执行报告

执行时间: YYYY-MM-DD HH:mm:ss

### 统计
- 总任务数: 10
- 成功: 8
- 失败: 2
- 平均耗时: 15.2秒

### 失败任务
1. 任务3: 超时
2. 任务7: 网络错误

### 成功结果
(按任务展示关键结果)
```

---

## 相关模块

- [API调用](API调用.md) - API 调用模式
- [技能调用](技能调用.md) - 技能调用方法
- [结果处理](结果处理.md) - 结果解析、存储

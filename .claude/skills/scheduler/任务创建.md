# 任务创建

## 创建流程

```
用户请求 → 分析参数 → 生成脚本 → 注册任务 → 验证
```

## 参数收集

| 参数 | 说明 | 默认值 |
|------|------|--------|
| taskName | 任务名称（Windows 任务名称） | - |
| title | 任务标题 | taskName |
| description | 任务描述 | - |
| schedule | 调度规则（自然语言或 cron） | - |
| prompt | Claude 执行的提示词 | - |
| workingDirectory | 工作目录 | 当前项目 |
| skipPermissions | 是否跳过权限检查 | false |

## 调度类型判断

### 一次性任务（关键词）
- "今天 at 3pm"
- "tomorrow at noon"
- "next Tuesday at 2pm"
- "2026-03-01 at 09:00"

### 循环任务（关键词）
- "every 20 minutes"
- "daily at 9am"
- "weekly on Monday"
- "weekdays at 10am"
- Cron 表达式

## 执行脚本模板

```batch
@echo off
chcp 65001 > nul
set PROJECT_DIR=E:\workspaces_2026_python\OPC-CEO
set LOG_DIR=%PROJECT_DIR%\.claude\logs
set LOG_FILE=%LOG_DIR%\{taskName}.log
set ERROR_FILE=%LOG_DIR%\{taskName}.error.log

if not exist "%LOG_DIR%" mkdir "%LOG_DIR%"

cd /d "%PROJECT_DIR%"

echo [%date% %time%] Starting task... >> "%LOG_FILE%"
claude -p "{prompt}" --dangerously-skip-permissions >> "%LOG_FILE%" 2>> "%ERROR_FILE%"
echo [%date% %time%] Task completed. >> "%LOG_FILE%"
```

## 注册脚本模板

```powershell
$taskName = "{taskName}"
$scriptPath = "E:\workspaces_2026_python\OPC-CEO\.claude\schedules\{taskName}.bat"
$description = "{description}"

# 删除已存在的同名任务
Unregister-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue -Confirm:$false

$action = New-ScheduledTaskAction -Execute "cmd.exe" -Argument "/c `'$scriptPath`'"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes {interval})
$settings = New-ScheduledTaskSettingsSet -StartWhenAvailable -DontStopOnIdleEnd -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries

Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Settings $settings -Description $description -Force
```

## 验证检查

- [ ] 任务已注册
- [ ] 任务状态为 Ready
- [ ] 手动运行测试成功
- [ ] 日志输出正常

## 记录到 Memory

创建 Task 实体：
```
实体名称: TASK-YYYY-MM-DD-NNN
实体类型: Task
观察内容:
  - taskName: Windows 任务名称
  - title: 任务标题
  - scheduleType: once/recurring
  - cronExpression: cron 表达式（如适用）
  - command: 执行脚本路径
  - status: active
  - createdAt: 创建时间
```

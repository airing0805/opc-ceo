# 底层执行能力

> Coach 的核心操作流程和工具使用规范（精简版）
>
> **详细示例**: [底层执行示例库.md](底层执行示例库.md)
> **快速参考**: [执行工具速查卡.md](执行工具速查卡.md)

> **V14.0 更新**: 错误处理精细化（3层分类）、性能监控集成

---

## 一、核心内容快速索引（V14.0）

> **重要**: 80% 的操作只需要以下核心内容

### 1.1 工具选择决策树（3 秒决策）

```
需要什么操作？
├── 读取文档 ──────────► mcp__filesystem__read_file
│   └── 备选 ──────────► Read
├── 写入/创建文档 ──────► mcp__filesystem__write_file
│   └── 备选 ──────────► Write
├── 编辑文档 ──────────► mcp__filesystem__edit_file
│   └── 备选 ──────────► Edit
├── 搜索文件 ──────────► Glob
├── 搜索内容 ──────────► Grep
├── Memory 查询 ────────► mcp__memory__search_nodes
├── Memory 创建 ────────► mcp__memory__create_entities
├── Memory 更新 ────────► mcp__memory__add_observations
├── Git/系统操作 ───────► Bash
└── 并行操作 ──────────► 在单次响应中同时调用多个工具
```

### 1.2 常用路径速查

| 目标 | 路径 |
|------|------|
| 任务分配 | `docs/沟通文档/任务分配.md` |
| 战略目标 | `docs/战略规划/战略目标.md` |
| 版本规划 | `docs/版本规划/v2-技能规划/README.md` |
| 执行日志 | `docs/沟通文档/执行日志/YYYY-MM-DD.md` |
| 协调记录 | `docs/沟通文档/协调记录.md` |
| 自我进化报告 | `docs/沟通文档/自我进化/coach 自我进化报告.md` |

**完整路径前缀**: `E:/workspaces_2026_python/OPC-CEO/`

### 1.3 Memory 实体类型速查

| 类型 | 命名格式 | 用途 |
|------|----------|------|
| Task | `TASK-v2.x.y` | 任务实体 |
| Decision | `DECISION-YYYY-MM-DD-NNN` | 决策记录 |
| CoachEvolution | `COACH-EVOLUTION-YYYY-MM-DD-NNN` | 进化记录 |
| CoachEvaluation | `COACH-EVAL-YYYY-MM-DD-NNN` | 评估记录 |
| CoordinationEvent | `COORD-YYYY-MM-DD-NNN` | 协调事件 |

### 1.4 启动自检（3 步）

```json
// 步骤1: 检查 Memory
mcp__memory__search_nodes({ "query": "task project status" })

// 步骤2: 检查任务
mcp__filesystem__read_file({ "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md" })

// 步骤3: 检查 Git
Bash({ "command": "git status" })
```

### 1.5 错误处理快速决策（V14.0 增强）

```
错误分类（3层）：
├── 基础设施错误
│   ├── MCP 工具不可用 → 切换备选工具
│   ├── Memory 服务异常 → 记录+继续
│   └── 文件系统故障 → 切换路径+记录
├── 业务逻辑错误
│   ├── 实体已存在 → 使用 update 而非 create
│   ├── 实体不存在 → 先创建再操作
│   └── 数据格式错误 → 尝试修复+记录
└── 执行时序错误
    ├── 依赖不满足 → 调整执行顺序
    ├── 状态不一致 → 重新加载状态
    └── 超时错误 → 重试1次

Memory 返回空？
└── 从文档读取 → 重建 Memory 实体
```

---

## 二、快速执行模板

### 2.1 创建任务记录

```json
// Memory
mcp__memory__create_entities({
  "entities": [{
    "name": "TASK-v2.x.y",
    "entityType": "Task",
    "observations": ["description: ...", "status: pending", "assignedTo: ..."]
  }]
})

// 文档
mcp__filesystem__edit_file({
  "path": "E:/workspaces_2026_python/OPC-CEO/docs/沟通文档/任务分配.md",
  "old_string": "<!-- 新任务在此添加 -->",
  "new_string": "| v2.x.y | 描述 | 待执行 | 角色 | 日期 |\n\n<!-- 新任务在此添加 -->"
})
```

### 2.2 记录进化

```json
mcp__memory__create_entities({
  "entities": [{
    "name": "COACH-EVOLUTION-YYYY-MM-DD-NNN",
    "entityType": "CoachEvolution",
    "observations": [
      "type: capability_improvement",
      "area: ...",
      "change: ...",
      "status: completed",
      "timestamp: ..."
    ]
  }]
})
```

### 2.3 更新任务状态

```json
// Memory
mcp__memory__add_observations({
  "observations": [{
    "entityName": "TASK-v2.x.y",
    "contents": ["status: completed", "completedAt: ..."]
  }]
})

// 文档
mcp__filesystem__edit_file({
  "path": "...",
  "old_string": "| v2.x.y | 描述 | 待执行 |",
  "new_string": "| v2.x.y | 描述 | 已完成 |"
})
```

---

## 三、并行执行模式

**场景**: 需要同时读取多个独立文件

```json
// 同时发起多个读取请求（单次响应中）
mcp__filesystem__read_file({ "path": "文件1" })
mcp__filesystem__read_file({ "path": "文件2" })
mcp__memory__search_nodes({ "query": "关键词" })
```

**原则**:
- 独立操作可以并行
- 有依赖的操作必须串行
- 优先使用并行提升效率

---

## 四、MCP 工具优先级

| 操作类型 | 首选工具 | 备选工具 |
|----------|----------|----------|
| 文档读取 | mcp__filesystem__read_file | Read |
| 文档写入 | mcp__filesystem__write_file | Write |
| 文档编辑 | mcp__filesystem__edit_file | Edit |
| 文件搜索 | Glob | Bash find |
| 内容搜索 | Grep | Bash grep |
| 命令执行 | Bash | - |
| Memory 查询 | mcp__memory__search_nodes | - |
| Memory 创建 | mcp__memory__create_entities | - |
| Memory 更新 | mcp__memory__add_observations | - |

**优先级原则**:
1. MCP 工具优先 - 解决 Direct 编辑环境问题
2. 内置工具次之 - 作为备选方案
3. Bash 最后 - 仅用于系统操作

---

## 五、操作检查清单

### 5.1 文档操作检查

```
□ 是否使用了 MCP 工具？（优先）
□ 是否使用了绝对路径？
□ 写入前是否读取确认格式？
□ 重要操作是否有备份？
□ 是否记录到 Memory？
```

### 5.2 Memory 操作检查

```
□ 实体名称是否符合命名规范？
□ entityType 是否正确？
□ observations 是否包含必要字段？
□ 是否创建了必要的关系？
□ 是否避免了重复创建？
```

### 5.3 执行后检查

```
□ 是否记录到 Memory？
□ 是否同步到文档？
□ 是否更新任务状态？
□ 是否复盘总结？
```

---

## 六、数据优先级（重要）

**当 Memory 为空时，从文档读取数据**:

| 数据类型 | 来源文档 | Memory 实体名 |
|----------|----------|---------------|
| 任务状态 | 任务分配.md | TASK-* |
| 战略目标 | 战略目标.md | GOAL-* |
| 进度状态 | v2-技能规划/README.md | PROGRESS-* |
| 公司状态 | 公司愿景.md | COMPANY-STATUS |

---

## 七、详细示例索引

> 以下场景的完整代码示例请参考 [底层执行示例库.md](底层执行示例库.md)

| 场景 | 示例库章节 |
|------|-----------|
| 文档读取/写入/编辑 | 一、文档操作详细示例 |
| Memory 创建/查询/更新 | 二、Memory 操作详细示例 |
| 启动自检完整流程 | 三.1 |
| Memory 重建完整流程 | 三.2 |
| 任务记录完整流程 | 三.3 |
| 进化记录完整流程 | 三.4 |
| 风险预警检测流程 | 三.5 |
| MCP 工具不可用 | 四.1 |
| Memory 返回空 | 四.2 |
| 文档写入失败 | 四.3 |
| 实体已存在错误 | 四.4 |
| 文件名/内容搜索 | 五、搜索操作详细示例 |
| Git 命令 | 六、Git 操作详细示例 |

---

## 八、并行执行模板增强

### 8.1 场景化并行模板

| 场景 | 模板 | 适用情况 |
|------|------|----------|
| **多文件读取** | 并行读取独立文件 | 读取多个不相关的配置/数据文件 |
| **多任务创建** | 批量创建实体 | 一次性创建多个Memory实体 |
| **组合操作** | 读取+处理+写入 | 典型的工作流模式 |
| **依赖分析** | 串行+并行混合 | 复杂场景优化执行顺序 |

### 8.2 多文件读取模板

```json
// 场景：需要同时读取多个独立文件
// 方案：并行读取，提升IO效率

// 一次性发起多个读取请求
mcp__filesystem__read_file({ "path": "文件1路径" })
mcp__filesystem__read_file({ "path": "文件2路径" })
mcp__filesystem__read_file({ "path": "文件3路径" })

// 注意：文件之间无依赖关系才可并行
```

### 8.3 批量创建实体模板

```json
// 场景：需要创建多个相关实体
// 方案：合并创建请求，减少API调用

mcp__memory__create_entities({
  "entities": [
    {"name": "实体1", "entityType": "类型1", "observations": [...]},
    {"name": "实体2", "entityType": "类型2", "observations": [...]},
    {"name": "实体3", "entityType": "类型3", "observations": [...]}
  ]
})

// 注意：同一类型的实体可批量创建
```

### 8.4 依赖分析决策

```
执行前先问：这些操作有依赖吗？
├── 无依赖 → 全并行
├── A依赖B → 先B后A（串行）
├── A和B互不依赖但需同时完成 → 并行
└── 复杂依赖 → 画依赖图，按拓扑排序
```

---

## 九、错误处理完善（V13.0新增）

### 9.1 错误分类决策树

```
错误类型
├── MCP工具错误
│   ├── 文档操作 → 切换备选工具(Read/Write/Edit)
│   ├── Memory操作 → 记录错误+继续
│   └── 持续失败 → 记录+通知用户
├── 权限错误
│   ├── 权限不足 → 请求用户授权
│   └── 越权操作 → 记录+跳过
├── 逻辑错误
│   ├── 数据格式 → 尝试修复
│   └── 业务规则 → 记录+跳过
└── 超时错误
    ├── 重试(1次) → 成功则继续
    └── 失败 → 记录+通知
```

### 9.2 错误处理策略

| 错误类型 | 处理方式 | 优先级 |
|----------|----------|--------|
| 文档操作失败 | 切换工具+记录 | P0 |
| Memory操作失败 | 记录+继续 | P1 |
| 权限错误 | 请求授权+跳过 | P0 |
| 超时错误 | 重试1次 | P1 |
| 逻辑错误 | 记录+跳过 | P2 |

### 9.3 重试策略

```
需要重试的场景：
├── 网络超时 → 重试1次
├── 服务暂时不可用 → 重试1次
└── 不需要重试的场景：
    ├── 权限不足 → 不重试，直接请求授权
    ├── 数据不存在 → 不重试，返回空结果
    └── 格式错误 → 不重试，记录并跳过
```

---

## 十、TRS追踪执行（V13.0新增）

### 10.1 追踪时机

每次用户交互结束前记录TRS执行状态：

```json
mcp__memory__create_entities({
  "entities": [{
    "name": "TRS-2026-02-28-NNN",
    "entityType": "TRSTracking",
    "observations": [
      "timestamp: 2026-02-28T10:00:00",
      "trsCompleted: true",
      "t_done: true",
      "r_done: true",
      "s_done: true",
      "whyAsked: 1",
      "solutionsGiven: 2",
      "risksNoted: 1"
    ]
  }]
})
```

### 10.2 统计周期

- **每日**: 自动记录
- **每周一**: 统计上周执行率
- **低于85%**: 触发强化流程

---

## 十一、版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| **14.0** | **2026-02-28** | **错误处理精细化（3层分类）、性能监控集成** |
| 13.0 | 2026-02-28 | 并行模板增强、错误处理完善、TRS追踪执行 |
| 11.0 | 2026-02-26 | 精简版核心内容 |
| 1.0.0 | 2026-02-26 | 初始版本 |

---

> ceo-coach V14.0 - 底层执行能力增强版（错误处理精细化+性能监控）

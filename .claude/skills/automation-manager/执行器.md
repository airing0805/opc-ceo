# 执行器

## 概述

处理工作流的执行逻辑、错误重试和日志记录。

## 执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     工作流执行流程                           │
├─────────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐           │
│  │ 1.验证   │ -> │ 2.执行   │ -> │ 3.记录   │           │
│  │   工作流  │    │   步骤    │    │   日志    │           │
│  └──────────┘    └──────────┘    └──────────┘           │
│       │                │                │                    │
│       ▼                ▼                ▼                    │
│  检查依赖        按顺序/并行     保存执行结果             │
│  验证触发器      执行每个步骤     更新工作流状态            │
│                                                            │
│  ┌──────────┐    ┌──────────┐                          │
│  │ 4.处理   │ <- │ 错误     │                          │
│  │   重试    │    │   检测    │                          │
│  └──────────┘    └──────────┘                          │
│       │                │                                 │
│       ▼                ▼                                 │
│  按策略重试        失败通知                             │
│  更新失败次数       标记工作流失败                       │
│                                                            │
└─────────────────────────────────────────────────────────────────┘
```

## 执行步骤

### 步骤 1：验证工作流

```
1. 检查工作流状态（必须是 active）
2. 验证触发器配置
3. 检查依赖步骤是否完成
4. 初始化变量
```

### 步骤 2：执行步骤

```
1. 确定执行顺序（顺序/并行/条件）
2. 为每个步骤创建执行上下文
3. 调用对应的 skill 和 action
4. 收集执行结果
5. 传递变量到下一步骤
```

### 步骤 3：记录日志

```
1. 创建 WorkflowExecution 实体
2. 记录每个步骤的执行时间
3. 记录输出结果
4. 更新工作流最后执行时间
```

## 错误处理

### 重试策略

| 策略 | 说明 |
|-------|------|
| 立即重试 | 失败后立即重试 |
| 指数退避 | 失败后等待时间加倍 |
| 固定延迟 | 失败后等待固定时间 |

### 重试配置

```yaml
- name: 可能失败的步骤
  skill: external-service
  action: call-api
  retries: 3
  retryDelay: 5000  # 毫秒
  retryStrategy: exponential
  onRetry:
    action: log-error
    skill: knowledge-manager
```

### 错误类型处理

| 错误类型 | 处理方式 |
|---------|---------|
| `skill-not-found` | 跳过步骤，记录错误 |
| `action-not-found` | 跳过步骤，记录错误 |
| `execution-failed` | 根据重试策略处理 |
| `timeout` | 记录超时，继续下一步 |
| `validation-error` | 停止工作流，标记失败 |

## 执行状态

### 工作流状态

| 状态 | 说明 |
|------|------|
| `pending` | 等待触发 |
| `running` | 正在执行 |
| `completed` | 执行成功 |
| `failed` | 执行失败 |
| `paused` | 执行暂停 |
| `cancelled` | 执行取消 |

### 步骤状态

| 状态 | 说明 |
|------|------|
| `pending` | 等待执行 |
| `running` | 正在执行 |
| `completed` | 执行成功 |
| `failed` | 执行失败 |
| `skipped` | 跳过（条件不满足） |

## 并行执行

### 并行步骤执行

```yaml
- name: 并行任务
  parallel:
    - name: 备份文件
      skill: file-manager
      action: backup-folder
    - name: 备份数据库
      skill: knowledge-manager
      action: backup-graph
  waitFor: all  # all 或 any
```

### 并行执行逻辑

```
1. 启动所有并行步骤
2. 等待所有步骤完成（waitFor: all）
   或等待任一步骤完成（waitFor: any）
3. 汇总所有步骤的结果
4. 继续下一步骤
```

## 变量传递

### 变量作用域

| 作用域 | 说明 |
|-------|------|
| `variables` | 工作流级别，所有步骤可访问 |
| `steps.{stepName}` | 步骤输出，后续步骤可访问 |
| `trigger` | 触发器数据，所有步骤可访问 |

### 变量示例

```yaml
variables:
  basePath: /data

- name: 步骤1
  skill: file-manager
  action: read
  params:
    path: ${variables.basePath}/file.txt
  outputVar: fileContent

- name: 步骤2
  skill: knowledge-manager
  action: store
  params:
    content: ${steps.步骤1.outputVar}
```

## 执行日志

### 日志级别

| 级别 | 说明 |
|-------|------|
| `info` | 一般信息 |
| `debug` | 调试信息 |
| `warning` | 警告信息 |
| `error` | 错误信息 |

### 日志格式

```yaml
executionId: EXEC-2026-02-24-001
workflowId: WF-2026-02-24-001
startTime: 2026-02-24T18:00:00Z
endTime: 2026-02-24T18:05:00Z
status: completed
steps:
  - name: 获取任务
    status: completed
    startTime: 2026-02-24T18:00:00Z
    endTime: 2026-02-24T18:01:00Z
    output: {count: 5}
  - name: 生成报告
    status: completed
    startTime: 2026-02-24T18:01:00Z
    endTime: 2026-02-24T18:05:00Z
    output: {reportPath: reports/daily.md}
logs:
  - level: info
    message: 工作流开始执行
    timestamp: 2026-02-24T18:00:00Z
  - level: info
    message: 工作流执行完成
    timestamp: 2026-02-24T18:05:00Z
```

## MCP Memory 存储

### WorkflowExecution 实体

```yaml
entityType: WorkflowExecution
name: EXEC-2026-02-24-001
observations:
  - workflowId: WF-2026-02-24-001
  - startTime: 2026-02-24T18:00:00Z
  - endTime: 2026-02-24T18:05:00Z
  - duration: 300
  - status: completed
  - stepsCompleted: 2
  - stepsFailed: 0
  - createdAt: 2026-02-24T18:00:00Z
```

## 注意事项

- 执行失败需要记录详细错误
- 重试要有最大次数限制
- 并行执行需要合理控制并发
- 变量传递要避免循环引用

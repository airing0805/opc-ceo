# 工作流定义

## 概述

定义工作流的格式、步骤类型和变量传递机制。

## 工作流格式

### 完整定义

```yaml
workflow:
  id: WF-YYYY-MM-DD-NNN
  name: 工作流名称
  description: 工作流描述（可选）
  trigger:
    type: cron|event|manual
    schedule: "cron表达式"  # cron 类型
    eventType: 事件类型        # event 类型
  steps:
    - name: 步骤名称
      skill: 技能名
      action: 操作名
      params: {参数}
      condition: 条件表达式  # 可选
      on: 依赖步骤          # 可选
      retries: 重试次数      # 可选
  variables:
    varName: 变量值
  status: active|paused|disabled
  createdAt: 时间戳
  updatedAt: 时间戳
```

## 步骤类型

### 基本步骤

```yaml
- name: 步骤名称
  skill: task-manager
  action: create-task
  params:
    title: 新任务
    priority: P1
```

### 条件步骤

```yaml
- name: 条件判断
  condition: "${result.count} > 0"
  steps:
    - name: 有任务时执行
      skill: task-manager
      action: process-tasks
  else:
    - name: 无任务时执行
      skill: task-manager
      action: create-default-task
```

### 并行步骤

```yaml
- name: 并行执行
  parallel:
    - name: 步骤1
      skill: skill1
      action: action1
    - name: 步骤2
      skill: skill2
      action: action2
```

### 顺序步骤（默认）

```yaml
steps:
  - name: 步骤1
    skill: skill1
    action: action1
    on: start
  - name: 步骤2
    skill: skill2
    action: action2
    on: 步骤1
  - name: 步骤3
    skill: skill3
    action: action3
    on: 步骤2
```

## 变量系统

### 变量定义

```yaml
variables:
  projectName: OPC-CEO
  reportPath: reports/daily/
  emailRecipient: user@example.com
```

### 变量引用

```yaml
- name: 生成报告
  skill: file-manager
  action: save-file
  params:
    path: ${variables.reportPath}${date}.md
    content: "${variables.projectName} 每日报告"
```

### 步骤间变量传递

```yaml
- name: 获取任务
  skill: task-manager
  action: get-tasks
  outputVar: taskList

- name: 处理任务
  skill: task-manager
  action: process
  params:
    tasks: ${steps.获取任务.outputVar}
```

## 常用操作映射

### task-manager 操作

| 操作 | 说明 |
|------|------|
| `create-task` | 创建任务 |
| `get-completed-today` | 获取今日完成任务 |
| `get-weekly-summary` | 获取本周摘要 |
| `update-status` | 更新状态 |

### file-manager 操作

| 操作 | 说明 |
|------|------|
| `save-file` | 保存文件 |
| `backup-folder` | 备份文件夹 |
| `search-files` | 搜索文件 |

### schedule-manager 操作

| 操作 | 说明 |
|------|------|
| `create-event` | 创建事件 |
| `analyze-weekly-time` | 分析周时间 |
| `log-completion-time` | 记录完成时间 |

### finance-manager 操作

| 操作 | 说明 |
|------|------|
| `record-transaction` | 记录交易 |
| `generate-report` | 生成报告 |
| `check-budget` | 检查预算 |

## 工作流示例

### 每日备份

```yaml
workflow:
  id: WF-2026-02-24-004
  name: 每日备份
  trigger:
    type: cron
    schedule: "0 23 * * *"
  steps:
    - name: 备份项目文件
      skill: file-manager
      action: backup-folder
      params:
        path: E:/workspaces_2026_python/OPC-CEO
        destination: E:/backups/daily/
    - name: 记录备份日志
      skill: knowledge-manager
      action: store-record
      params:
        type: backup
        timestamp: ${now}
```

### 财务检查

```yaml
workflow:
  id: WF-2026-02-24-005
  name: 每周财务检查
  trigger:
    type: cron
    schedule: "0 9 * * 1"  # 每周一 9:00
  steps:
    - name: 检查预算
      skill: finance-manager
      action: check-budget
      outputVar: budgetStatus
    - name: 超支预警
      condition: "${budgetStatus.hasOverspending}"
      skill: knowledge-manager
      action: create-alert
      params:
        message: "预算超支警告"
```

## MCP Memory 存储

### Workflow 实体

```yaml
entityType: Workflow
name: WF-2026-02-24-001
observations:
  - name: 每日回顾
  - description: 每天生成日报
  - trigger:
    - type: cron
    - schedule: "0 18 * * *"
  - status: active
  - stepCount: 3
  - createdAt: 2026-02-24T00:00:00Z
  - updatedAt: 2026-02-24T00:00:00Z
```

## 注意事项

- 步骤名称必须唯一
- 变量引用使用 `${}` 语法
- 条件表达式支持基本比较和逻辑运算
- 循环引用需要谨慎，避免死循环

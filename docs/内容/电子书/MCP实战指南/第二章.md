# 第二章：MCP 工具安装与配置

> 本章将手把手教你安装和配置 MCP 工具。从 Claude Desktop 到 Claude Code，从配置文件编写到服务器安装，每个步骤都有详细说明。读完本章，你将拥有一个完整可用的 MCP 开发环境。

---

## 2.1 Claude Desktop 安装与配置

Claude Desktop 是体验 MCP 最简单的方式。它是 Anthropic 官方推出的桌面应用，支持 Windows、macOS 和 Linux。

### 2.1.1 下载与安装

**步骤一：访问官网下载**

访问 [claude.ai/download](https://claude.ai/download) 下载适合你操作系统的版本：

| 操作系统 | 文件格式 | 文件大小 |
|---------|---------|---------|
| Windows | .exe | ~150MB |
| macOS (Intel) | .dmg | ~180MB |
| macOS (Apple Silicon) | .dmg | ~160MB |
| Linux | .AppImage | ~200MB |

**步骤二：安装应用**

- **Windows**：双击 `.exe` 文件，按照向导完成安装
- **macOS**：双击 `.dmg` 文件，将 Claude 拖入 Applications 文件夹
- **Linux**：赋予 AppImage 执行权限后直接运行

```bash
# Linux 安装示例
chmod +x Claude-*.AppImage
./Claude-*.AppImage
```

**步骤三：登录账户**

首次启动时，使用你的 Anthropic 账户登录。如果没有账户，可以免费注册。

### 2.1.2 找到配置文件位置

Claude Desktop 的 MCP 配置存储在 JSON 文件中，位置因操作系统而异：

| 操作系统 | 配置文件路径 |
|---------|-------------|
| **Windows** | `%APPDATA%\Claude\claude_desktop_config.json` |
| **macOS** | `~/Library/Application Support/Claude/claude_desktop_config.json` |
| **Linux** | `~/.config/Claude/claude_desktop_config.json` |

**快速打开配置目录：**

- **Windows**：按 `Win + R`，输入 `%APPDATA%\Claude`，回车
- **macOS**：在 Finder 中按 `Cmd + Shift + G`，粘贴路径后回车
- **Linux**：在终端中运行 `nano ~/.config/Claude/claude_desktop_config.json`

如果配置文件不存在，你需要手动创建一个空的 JSON 文件：

```json
{
  "mcpServers": {}
}
```

### 2.1.3 配置第一个 MCP 服务器

让我们配置一个简单的文件系统服务器，让 Claude 能读取你电脑上的文件。

打开配置文件，修改为：

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem",
        "/Users/yourname/Documents"
      ]
    }
  }
}
```

**注意**：请将 `/Users/yourname/Documents` 替换为你实际的文档目录：
- **Windows**：`C:\\Users\\你的用户名\\Documents`（注意双反斜杠）
- **macOS**：`/Users/你的用户名/Documents`
- **Linux**：`/home/你的用户名/Documents`

### 2.1.4 重启并验证

保存配置文件后，**完全退出** Claude Desktop（不只是关闭窗口），然后重新启动。

验证方法：
1. 在 Claude 中输入："你能访问我的文件系统吗？列出我可以访问的目录。"
2. 如果配置正确，Claude 会告诉你它可以访问的目录

---

## 2.2 Claude Code 安装与配置

Claude Code 是专为开发者设计的命令行工具，它将 MCP 的强大功能带入终端环境。

### 2.2.1 安装 Claude Code

**前置要求**：
- Node.js v18 或更高版本
- npm 或 pnpm 包管理器

**安装命令**：

```bash
# 使用 npm 安装
npm install -g @anthropic-ai/claude-code

# 或使用 pnpm 安装
pnpm add -g @anthropic-ai/claude-code
```

**验证安装**：

```bash
claude --version
```

如果显示版本号，说明安装成功。

### 2.2.2 首次运行与登录

```bash
# 在任意目录运行
claude
```

首次运行时，Claude Code 会引导你：
1. 访问 Anthropic 授权页面
2. 输入显示的验证码
3. 完成账户授权

授权完成后，你就可以在终端中与 Claude 对话了。

### 2.2.3 Claude Code 的 MCP 配置

Claude Code 的 MCP 配置有两种方式：

**方式一：项目级配置（推荐）**

在项目根目录创建 `.claude/settings.json`：

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem",
        "."
      ]
    },
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    }
  }
}
```

**方式二：全局配置**

全局配置文件位于：
- **Windows**：`%USERPROFILE%\.claude\settings.json`
- **macOS/Linux**：`~/.claude/settings.json`

### 2.2.4 Claude Code 特有功能

Claude Code 有一些独特的 MCP 相关功能：

**1. 自动发现 MCP 工具**

启动 Claude Code 后，可以使用 `ToolSearch` 功能发现可用的 MCP 工具：

```
> 列出所有可用的 MCP 工具
```

**2. 工具权限管理**

Claude Code 允许你精细控制工具的使用权限：

```json
{
  "allowedTools": [
    "mcp__filesystem__read_file",
    "mcp__filesystem__write_file",
    "mcp__github__*"
  ]
}
```

**3. 调试模式**

启用调试模式查看 MCP 通信详情：

```bash
claude --debug
```

---

## 2.3 MCP 服务器配置详解

MCP 服务器是整个系统的核心。理解配置结构，是使用 MCP 的关键。

### 2.3.1 配置文件结构

完整的 MCP 配置文件结构如下：

```json
{
  "mcpServers": {
    "服务器名称": {
      "command": "启动命令",
      "args": ["参数1", "参数2"],
      "env": {
        "环境变量名": "环境变量值"
      },
      "disabled": false
    }
  }
}
```

### 2.3.2 配置字段说明

| 字段 | 必需 | 说明 |
|------|------|------|
| `command` | 是 | 启动服务器的命令，通常是 `npx`、`node` 或 `python` |
| `args` | 否 | 命令行参数数组 |
| `env` | 否 | 环境变量对象 |
| `disabled` | 否 | 设为 `true` 可临时禁用该服务器 |

### 2.3.3 三种常见的启动方式

**方式一：使用 npx（推荐新手）**

npx 会自动下载并执行 npm 包，无需预先安装：

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "/path/to/dir"]
    }
  }
}
```

`-y` 参数用于自动确认安装提示。

**方式二：使用 node 运行本地文件**

适用于本地开发或自定义服务器：

```json
{
  "mcpServers": {
    "custom-server": {
      "command": "node",
      "args": ["/path/to/server.js"]
    }
  }
}
```

**方式三：使用 Python 运行**

适用于 Python 编写的 MCP 服务器：

```json
{
  "mcpServers": {
    "python-server": {
      "command": "python",
      "args": ["-m", "my_mcp_server"],
      "env": {
        "PYTHONPATH": "/path/to/modules"
      }
    }
  }
}
```

### 2.3.4 环境变量的安全处理

敏感信息（如 API Token）应该通过环境变量传递，而不是硬编码：

**不推荐**（硬编码 Token）：
```json
{
  "env": {
    "GITHUB_TOKEN": "ghp_xxxxxxxxxxxx"
  }
}
```

**推荐**（引用系统环境变量）：
```json
{
  "env": {
    "GITHUB_TOKEN": "${GITHUB_TOKEN}"
  }
}
```

然后在系统中设置环境变量：

```bash
# macOS/Linux - 添加到 ~/.bashrc 或 ~/.zshrc
export GITHUB_TOKEN="ghp_xxxxxxxxxxxx"

# Windows - 通过系统属性设置环境变量
# 或在 PowerShell 中：
$env:GITHUB_TOKEN = "ghp_xxxxxxxxxxxx"
```

---

## 2.4 常见 MCP 服务器安装步骤

下面介绍几个最常用的 MCP 服务器的安装配置方法。

### 2.4.1 文件系统服务器（filesystem）

**功能**：读写本地文件、搜索文件、管理目录

**配置示例**：

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem",
        "/Users/yourname/projects",
        "/Users/yourname/Documents"
      ]
    }
  }
}
```

**注意事项**：
- 可以指定多个目录作为参数
- 建议只授予必要的目录访问权限
- 路径必须是绝对路径

**可用工具**：
- `read_file` - 读取文件内容
- `write_file` - 写入文件
- `list_directory` - 列出目录内容
- `search_files` - 搜索文件
- `get_file_info` - 获取文件元信息
- `move_file` - 移动/重命名文件

### 2.4.2 GitHub 服务器（github）

**功能**：管理仓库、创建 PR、处理 Issue、搜索代码

**前置准备**：
1. 访问 [GitHub Settings > Developer settings > Personal access tokens](https://github.com/settings/tokens)
2. 创建一个 Personal Access Token（建议使用 fine-grained token）
3. 勾选必要的权限：`repo`、`read:org`、`read:user`

**配置示例**：

```json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    }
  }
}
```

**可用工具**：
- `create_repository` - 创建仓库
- `fork_repository` - Fork 仓库
- `create_issue` - 创建 Issue
- `create_pull_request` - 创建 PR
- `search_code` - 搜索代码
- `get_file_contents` - 获取文件内容

### 2.4.3 Slack 服务器（slack）

**功能**：读取频道消息、发送消息、管理频道

**前置准备**：
1. 访问 [Slack API](https://api.slack.com/apps) 创建应用
2. 添加以下 Bot Token Scopes：
   - `channels:history`
   - `channels:read`
   - `chat:write`
   - `groups:history`
   - `groups:read`
3. 安装应用到工作区，获取 Bot User OAuth Token

**配置示例**：

```json
{
  "mcpServers": {
    "slack": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-slack"],
      "env": {
        "SLACK_BOT_TOKEN": "${SLACK_BOT_TOKEN}"
      }
    }
  }
}
```

### 2.4.4 PostgreSQL 服务器（postgres）

**功能**：执行 SQL 查询、查看表结构

**配置示例**：

```json
{
  "mcpServers": {
    "postgres": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-postgres"],
      "env": {
        "POSTGRES_CONNECTION_STRING": "postgresql://user:password@localhost:5432/mydb"
      }
    }
  }
}
```

**安全建议**：
- 使用只读数据库用户
- 限制可访问的表
- 在生产环境中使用 SSL 连接

### 2.4.5 Puppeteer 服务器（puppeteer）

**功能**：网页截图、表单填写、页面交互

**配置示例**：

```json
{
  "mcpServers": {
    "puppeteer": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-puppeteer"]
    }
  }
}
```

**可用工具**：
- `puppeteer_navigate` - 导航到 URL
- `puppeteer_screenshot` - 截取屏幕
- `puppeteer_click` - 点击元素
- `puppeteer_fill` - 填写表单

---

## 2.5 验证安装是否成功

配置完成后，需要验证 MCP 服务器是否正常工作。

### 2.5.1 Claude Desktop 验证方法

**方法一：直接询问**

重启 Claude Desktop 后，直接询问：

```
请列出你当前可以使用的所有 MCP 工具。
```

**方法二：测试具体功能**

```
请使用文件系统工具，列出我的 Documents 目录下的文件。
```

**方法三：查看日志**

查看 Claude Desktop 的日志文件：
- **Windows**：`%APPDATA%\Claude\logs\`
- **macOS**：`~/Library/Logs/Claude/`

日志中会显示 MCP 服务器的连接状态和错误信息。

### 2.5.2 Claude Code 验证方法

**方法一：列出 MCP 服务器**

```bash
claude
> 列出所有已配置的 MCP 服务器
```

**方法二：测试工具调用**

```
> 使用 filesystem 工具读取当前目录的 package.json 文件
```

**方法三：查看启动日志**

Claude Code 启动时会显示 MCP 服务器的连接状态：

```bash
claude --debug 2>&1 | grep -i mcp
```

### 2.5.3 成功标志

如果配置正确，你应该看到：

1. **无错误消息**：启动时没有 "Failed to connect to MCP server" 之类的错误
2. **工具可用**：Claude 能够列出并使用 MCP 提供的工具
3. **功能正常**：实际调用工具时能够返回正确的结果

---

## 2.6 常见问题排查

配置 MCP 时可能会遇到各种问题，以下是常见问题及解决方案。

### 2.6.1 "command not found" 错误

**症状**：
```
Error: spawn npx ENOENT
```

**原因**：系统找不到 `npx` 或 `node` 命令

**解决方案**：
1. 确认 Node.js 已正确安装
2. 检查 Node.js 是否在 PATH 环境变量中
3. 尝试使用完整路径：
   ```json
   {
     "command": "/usr/local/bin/npx",
     "args": ["-y", "@modelcontextprotocol/server-filesystem", "."]
   }
   ```

### 2.6.2 服务器连接超时

**症状**：
```
Error: MCP server connection timed out
```

**原因**：服务器启动时间过长或网络问题

**解决方案**：
1. 检查网络连接
2. 首次运行时 npx 需要下载包，可能需要等待
3. 尝试预先安装包：
   ```bash
   npm install -g @modelcontextprotocol/server-filesystem
   ```

### 2.6.3 权限被拒绝

**症状**：
```
Error: Access denied to path /some/path
```

**原因**：文件系统权限不足

**解决方案**：
1. 确认配置的路径存在
2. 确认当前用户有访问权限
3. 在 macOS/Linux 上检查路径权限：
   ```bash
   ls -la /path/to/directory
   ```

### 2.6.4 环境变量未生效

**症状**：
```
Error: GITHUB_TOKEN is required
```

**原因**：环境变量未正确设置或未被读取

**解决方案**：
1. 确认环境变量已设置：
   ```bash
   # macOS/Linux
   echo $GITHUB_TOKEN
   
   # Windows PowerShell
   $env:GITHUB_TOKEN
   ```
2. 重启 Claude Desktop/Claude Code 使环境变量生效
3. 尝试在配置文件中直接设置（仅用于测试，不推荐生产使用）

### 2.6.5 JSON 格式错误

**症状**：
```
Error: Failed to parse MCP configuration
```

**原因**：配置文件 JSON 格式不正确

**解决方案**：
1. 使用 JSON 验证工具检查格式
2. 注意 Windows 路径需要双反斜杠：`C:\\Users\\...`
3. 确保没有多余的逗号

**正确示例**：
```json
{
  "mcpServers": {
    "server1": { ... },
    "server2": { ... }
  }
}
```

**错误示例**（最后一个元素后不能有逗号）：
```json
{
  "mcpServers": {
    "server1": { ... },  // ← 这个逗号会导致错误
  }
}
```

### 2.6.6 端口冲突

**症状**：某些 MCP 服务器无法启动

**原因**：服务器默认端口被占用

**解决方案**：
1. 检查端口占用：
   ```bash
   # macOS/Linux
   lsof -i :3000
   
   # Windows
   netstat -ano | findstr :3000
   ```
2. 通过环境变量修改端口（具体方法参考服务器文档）

---

## 2.7 多服务器配置示例

实际使用中，通常需要同时配置多个 MCP 服务器。以下是一个完整的配置示例：

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem",
        "/Users/dev/projects",
        "/Users/dev/Documents"
      ]
    },
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    },
    "postgres": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-postgres"],
      "env": {
        "POSTGRES_CONNECTION_STRING": "${DATABASE_URL}"
      }
    },
    "slack": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-slack"],
      "env": {
        "SLACK_BOT_TOKEN": "${SLACK_BOT_TOKEN}"
      },
      "disabled": true
    }
  }
}
```

这个配置：
- 启用了文件系统、GitHub、PostgreSQL 三个服务器
- 暂时禁用了 Slack 服务器（`disabled: true`）
- 所有敏感信息都通过环境变量引用

---

## 2.8 本章小结

本章我们完成了：

1. **Claude Desktop 安装**：下载、安装、配置 MCP
2. **Claude Code 安装**：npm 安装、授权登录、项目配置
3. **配置文件详解**：字段说明、启动方式、环境变量安全处理
4. **常见服务器配置**：filesystem、github、slack、postgres、puppeteer
5. **验证方法**：如何确认安装成功
6. **问题排查**：常见错误及解决方案

现在你已经拥有了一个完整可用的 MCP 环境。下一章，我们将深入学习如何使用这些工具，通过实际案例体验 MCP 的强大功能。

---

## 延伸阅读

- [MCP 官方服务器列表](https://github.com/modelcontextprotocol/servers)
- [Claude Code 文档](https://docs.anthropic.com/claude-code)
- [MCP 规范文档](https://modelcontextprotocol.io/specification)
- [社区 MCP 服务器收集](https://github.com/punkpeye/awesome-mcp-servers)

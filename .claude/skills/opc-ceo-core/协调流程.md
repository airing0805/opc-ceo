# 协调流程

## 功能概述

定义多角色协作模式，处理复杂跨角色任务。

## Agent 调用指南

### Agent 概览

| Agent | 文件 | 工具权限 | 调用场景 |
|-------|-------|---------|----------|
| task-agent | .claude/agents/task-agent.md | mcp__memory__*, Read, Glob, Grep | 任务CRUD、状态跟踪、统计分析 |
| file-agent | .claude/agents/file-agent.md | Read, Write, Edit, Glob, Grep, Bash | 文件搜索、读写、备份、目录管理 |
| knowledge-agent | .claude/agents/knowledge-agent.md | mcp__memory__* | 知识存储、检索、图谱构建 |
| finance-agent | .claude/agents/finance-agent.md | mcp__memory__* | 财务记录、分类、报告生成 |
| schedule-agent | .claude/agents/schedule-agent.md | mcp__memory__* | 日程管理、事件操作、时间块规划 |

### 调用规范

#### 1. 基本调用方式

使用 Task 工具调用 agent，必须指定 `subagent_type="general-purpose"`：

```
Task(
    name: "task-agent",
    subagent_type: "general-purpose",
    instructions: "<明确的任务描述和职责范围>"
)
```

#### 2. Prompt 要求

调用 agent 时，prompt 必须明确指定：
- **职责范围**：明确该 agent 应该执行的具体任务
- **输入数据**：提供必要的上下文和参数
- **输出格式**：明确期望的返回格式

**示例 - 调用 task-agent 创建任务**：
```
你是 task-agent，请执行以下任务：
1. 创建一个任务，标题为"完成项目文档"
2. 设置优先级为 high
3. 设置项目ID为 PROJ-001
4. 返回创建的任务ID
```

**示例 - 调用 file-agent 搜索文件**：
```
你是 file-agent，请执行以下任务：
1. 在 E:\Documents 目录下搜索包含"任务管理"关键词的 .md 文件
2. 返回匹配的文件列表及其路径
```

#### 3. 并行调用

对于无依赖关系的独立任务，应使用并行调用提高效率：

```
同时调用：
1. task-agent - 查询今日任务
2. file-agent - 整理项目文件
3. finance-agent - 生成日报
```

#### 4. 串行调用

对于有依赖关系的任务，应按顺序调用：

```
步骤1: file-agent 备份项目文件
  ↓
步骤2: task-agent 检查备份完整性
  ↓
步骤3: knowledge-agent 更新知识库
```

#### 5. Team 协作模式

对于复杂的多 agent 协作任务，考虑使用 Team 模式：

**适用场景**：
- 需要多个 agent 长时间协作
- 有复杂的依赖关系和状态同步需求
- 需要实时协调和消息传递

**Team 模式示例**：
```
创建团队 "project-setup":
- task-agent: 负责任务分解和跟踪
- file-agent: 负责文件操作
- schedule-agent: 负责时间规划
```

### Agent 唤醒响应规范

当用户直接唤醒 agent 时（如 "/task-agent"），agent 第一次回答必须：
- 以"我是 {agent-name}"开头
- 简要说明核心能力
- 询问用户需要什么帮助

### Agent 能力边界

| Agent | 能力范围 | 禁止操作 |
|-------|---------|----------|
| task-agent | 任务CRUD、状态跟踪、统计分析 | 文件操作、知识图谱推理、财务计算 |
| file-agent | 文件搜索、读写、备份、目录管理 | 任务状态管理、知识图谱推理 |
| knowledge-agent | 知识存储、检索、图谱构建 | 文件操作、任务执行、财务计算 |
| finance-agent | 财务记录、分类、报告生成、预算跟踪 | 文件操作、任务管理、日程管理 |
| schedule-agent | 日程管理、事件操作、时间块规划、提醒系统 | 文件操作、任务执行、知识图谱推理 |

### 调用决策树

```
用户请求
  │
  ├─ 是否涉及文件操作？
  │   └─ 是 → file-agent
  │
  ├─ 是否涉及任务管理？
  │   └─ 是 → task-agent
  │
  ├─ 是否涉及知识管理？
  │   └─ 是 → knowledge-agent
  │
  ├─ 是否涉及财务记录？
  │   └─ 是 → finance-agent
  │
  ├─ 是否涉及日程安排？
  │   └─ 是 → schedule-agent
  │
  └─ 涉及多个领域？
      └─ 是 → 并行/串行/Team 模式调用多个 agent
```

### 错误处理

| 错误类型 | 处理方式 |
|----------|----------|
| Agent 响应超时 | 检查任务描述是否清晰，重新调用 |
| Agent 拒绝执行 | 确认任务是否在 agent 能力范围内 |
| 返回格式错误 | 明确指定输出格式，重新调用 |
| 多 agent 冲突 | 明确分工，使用 Team 模式或串行调用 |

### 调用示例

#### 示例 1：单 agent 调用

```
用户: "帮我查询今天的待办任务"

CEO 调用:
Task(
    name: "task-agent",
    subagent_type: "general-purpose",
    instructions: "你是 task-agent，请查询今天(2026-02-24)所有状态为 todo 的任务，按优先级排序返回"
)
```

#### 示例 2：并行调用多个 agent

```
用户: "帮我整理一下工作：查询今天任务、整理文档、生成财务报告"

CEO 并行调用:
1. Task(name: "task-agent", instructions: "查询今天的待办任务")
2. Task(name: "file-agent", instructions: "整理 E:\\Documents 目录下的文档")
3. Task(name: "finance-agent", instructions: "生成2026-02-24的财务日报")
```

#### 示例 3：串行调用（有依赖）

```
用户: "备份项目文件并检查完整性"

CEO 串行调用:
1. Task(name: "file-agent", instructions: "备份项目到 E:\\Backups")
   ↓ (等待完成)
2. Task(name: "file-agent", instructions: "验证备份文件完整性")
   ↓ (等待完成)
3. Task(name: "task-agent", instructions: "记录备份任务为已完成")
```

#### 示例 4：Team 协作模式

```
用户: "帮我规划下周的项目开发工作"

CEO 创建 Team:
TeamCreate(
    team_name: "project-planning",
    description: "规划下周项目开发工作"
)
然后调用 agent 协作...
```

## 操作命令

### 命令 1：单角色任务

**用途**：分配给单一角色的简单任务

**语法**：
```
分配单角色任务:
- 任务ID: <任务标识>
- 角色: <角色名>
- 任务描述: <描述>
- 验收标准: [标准列表]
- 超时: <分钟数>
```

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| 任务ID | string | 是 | 任务唯一标识 |
| 角色 | string | 是 | 执行角色 |
| 任务描述 | string | 是 | 任务详细描述 |
| 验收标准 | array | 是 | 验收标准列表 |
| 超时 | number | 否 | 超时时间（分钟） |

**示例**：
```
分配单角色任务:
- 任务ID: TASK-2026-02-23-001
- 角色: file-manager
- 任务描述: 整理项目目录下的所有文档文件
- 验收标准: [文档已分类, 有序排列, 无重复文件]
- 超时: 30
```

### 命令 2：多角色协调

**用途**：需要多个角色协作的复杂任务

**语法**：
```
协调多角色任务:
- 任务ID: <任务标识>
- 主角色: <角色名>
- 协作角色: [角色列表]
- 任务描述: <描述>
- 执行步骤: [步骤列表]
- 依赖关系: [依赖列表]
- 验收标准: [标准列表]
```

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| 任务ID | string | 是 | 任务唯一标识 |
| 主角色 | string | 是 | 负责协调的主角色 |
| 协作角色 | array | 是 | 协作角色列表 |
| 任务描述 | string | 是 | 任务详细描述 |
| 执行步骤 | array | 是 | 执行步骤顺序 |
| 依赖关系 | array | 否 | 步骤间的依赖关系 |
| 验收标准 | array | 是 | 验收标准列表 |

**示例**：
```
协调多角色任务:
- 任务ID: TASK-2026-02-23-002
- 主角色: opc-ceo-core
- 协作角色: [file-manager, knowledge-manager]
- 任务描述: 整理项目文件并更新知识库
- 执行步骤:
    - 步骤1: file-manager 整理文件
    - 步骤2: knowledge-manager 更新知识库
- 依赖关系: [步骤2依赖步骤1]
- 验收标准: [文件已整理, 知识库已更新]
```

### 命令 3：并行协调

**用途**：多个角色同时执行独立任务

**语法**：
```
并行协调任务:
- 任务ID: <任务标识>
- 并行任务: [任务列表]
- 汇总标准: [标准列表]
```

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| 任务ID | string | 是 | 主任务ID |
| 并行任务 | array | 是 | 并行执行的子任务列表 |
| 汇总标准 | array | 是 | 结果汇总标准 |

**示例**：
```
并行协调任务:
- 任务ID: TASK-2026-02-23-003
- 并行任务:
    - 任务1: file-manager 整理文档
    - 任务2: task-manager 检查任务状态
    - 任务3: finance-manager 生成周报
- 汇总标准: [所有子任务完成, 结果汇总完整]
```

## 协调模式

### 串行模式

```
任务A ──► 任务B ──► 任务C
```

- 适用：有依赖关系的任务
- 优点：顺序清晰，便于调试
- 缺点：总时间长

### 并行模式

```
任务A ──┐
         ├───► 汇总
任务B ──┘
```

- 适用：无依赖关系的任务
- 优点：节省时间
- 缺点：资源消耗大

### 混合模式

```
任务A ──► 任务B ──┐
                  ├───► 汇总
任务C ──► 任务D ──┘
```

- 适用：部分有依赖，部分无依赖
- 优点：兼顾效率和顺序
- 缺点：流程复杂

## MCP Memory 使用

### 创建协调记录

```
使用 mcp__memory__create_entities:
{
  "name": "COORD-2026-02-23-001",
  "entityType": "Coordination",
  "observations": [
    "taskId: TASK-2026-02-23-002",
    "pattern: 串行",
    "roles: [opc-ceo-core, file-manager, knowledge-manager]",
    "steps: 2",
    "status: in_progress",
    "startTime: 2026-02-23T10:00:00"
  ]
}
```

### 创建依赖关系

```
使用 mcp__memory__create_relations:
{
  "from": "TASK-2026-02-23-002-STEP2",
  "to": "TASK-2026-02-23-002-STEP1",
  "relationType": "dependsOn"
}
```

## 协调质量评估

| 维度 | 合格 | 优秀 | 卓越 |
|------|------|------|------|
| 按时完成 | 100% | 提前10% | 提前20%+ |
| 质量达标 | 所有标准 | 超出预期 | 超出明显 |
| 角色协作 | 无冲突 | 配合默契 | 高效协同 |
| 资源利用 | 合理 | 优化 | 最优 |

## 错误处理

| 错误类型 | 处理方式 |
|----------|----------|
| 角色执行失败 | 分析原因，重试或更换角色 |
| 超时未完成 | 评估进度，调整策略 |
| 依赖关系错误 | 重新设计流程 |

## 相关模块

- [决策支持](决策支持.md) - 决策协调策略
- [能力边界](能力边界.md) - 判断角色能力
- [任务检查](任务检查.md) - 验收协调结果

# 任务流转

## 功能概述

定义和实现任务状态的转换流程，包括状态验证、依赖关系处理和自动阻塞/解除阻塞。

## 状态定义

| 状态 | 说明 | 可转换到 |
|------|------|----------|
| `todo` | 待处理，初始状态 | in_progress, cancelled |
| `in_progress` | 进行中 | completed, blocked, cancelled |
| `blocked` | 被阻塞，等待依赖任务完成 | todo, in_progress, cancelled |
| `completed` | 已完成 | 终态，不再转换 |
| `cancelled` | 已取消 | 终态，不再转换 |

## 状态流转图

```
        ┌──────────────────────────────────────┐
        │                                      │
        ▼                                      │
    ┌───────┐    开始    ┌─────────────┐       │
    │ TODO  │ ─────────► │ IN_PROGRESS │ ──────┤
    └───────┘            └──────┬──────┘       │
        │                       │              │
        │ 阻塞                  │ 完成         │ 取消
        ▼                       ▼              ▼
    ┌─────────┐            ┌───────────┐  ┌───────────┐
    │ BLOCKED │            │ COMPLETED │  │ CANCELLED │
    └────┬────┘            └───────────┘  └───────────┘
         │                      ▲
         │ 解除阻塞              │
         └──────────────────────┘
```

## 操作命令

### 命令 1：开始任务

**用途**：将任务从 todo 或 blocked 转换为 in_progress

**语法**：
```
开始任务:
  - taskId: <任务ID>
```

**转换规则**：
- 允许从 `todo` 转换到 `in_progress`
- 允许从 `blocked` 转换到 `in_progress`（需先检查依赖是否满足）

**示例**：
```
开始任务:
  - taskId: TASK-2026-02-23-001
```

---

### 命令 2：阻塞任务

**用途**：将任务标记为 blocked（通常由依赖任务触发）

**语法**：
```
阻塞任务:
  - taskId: <任务ID>
  - reason: <阻塞原因> (可选)
```

**转换规则**：
- 允许从 `in_progress` 转换到 `blocked`
- 允许从 `todo` 转换到 `blocked`

**示例**：
```
阻塞任务:
  - taskId: TASK-2026-02-23-002
  - reason: 等待 TASK-2026-02-23-001 完成
```

---

### 命令 3：解除阻塞

**用途**：将 blocked 任务恢复到可执行状态

**语法**：
```
解除阻塞:
  - taskId: <任务ID>
```

**转换规则**：
- 允许从 `blocked` 转换到 `todo`（依赖未完全解决）
- 允许从 `blocked` 转换到 `in_progress`（依赖已完全解决）

**示例**：
```
解除阻塞:
  - taskId: TASK-2026-02-23-002
```

---

### 命令 4：完成任务

**用途**：将任务标记为已完成

**语法**：
```
完成任务:
  - taskId: <任务ID>
  - actualMinutes: <实际耗时> (可选)
  - notes: <完成备注> (可选)
```

**转换规则**：
- 允许从 `in_progress` 转换到 `completed`
- 完成后会自动检查并解除阻塞其他依赖此任务的任务

**示例**：
```
完成任务:
  - taskId: TASK-2026-02-23-001
  - actualMinutes: 90
  - notes: 比预期快30分钟
```

---

### 命令 5：取消任务

**用途**：取消任务（不再需要执行）

**语法**：
```
取消任务:
  - taskId: <任务ID>
  - reason: <取消原因> (可选)
```

**转换规则**：
- 允许从 `todo` 转换到 `cancelled`
- 允许从 `in_progress` 转换到 `cancelled`
- 允许从 `blocked` 转换到 `cancelled`

**示例**：
```
取消任务:
  - taskId: TASK-2026-02-23-003
  - reason: 需求变更，不再需要
```

---

### 命令 6：检查依赖状态

**用途**：检查任务的依赖关系和阻塞状态

**语法**：
```
检查依赖:
  - taskId: <任务ID>
```

**返回信息**：
- 直接依赖的任务列表及其状态
- 是否有未完成的依赖任务
- 是否被其他任务阻塞

**示例**：
```
检查依赖:
  - taskId: TASK-2026-02-23-002
```

---

## MCP Memory 使用

### 状态更新

```
使用 mcp__memory__add_observations 更新任务状态:
{
  "observations": [{
    "entityName": "TASK-2026-02-23-001: 完成项目文档",
    "contents": [
      "status: in_progress",
      "startedAt: 2026-02-23T14:00:00",
      "updatedAt: 2026-02-23T14:00:00"
    ]
  }]
}
```

### 自动解除阻塞逻辑

当一个任务完成时，需要：

1. 查询所有 dependsOn 此任务的其他任务
2. 检查这些任务的其他依赖是否也已完成
3. 如果所有依赖都已完成，将任务状态从 blocked 更新为 todo

```
步骤1: 搜索依赖此任务的任务
mcp__memory__search_nodes: "Task dependsOn:TASK-2026-02-23-001"

步骤2: 检查每个依赖任务的完整依赖链

步骤3: 更新符合条件的任务
mcp__memory__add_observations: status=todo, updatedAt=<当前时间>
```

## 状态转换验证矩阵

| 当前状态 → 新状态 | todo | in_progress | blocked | completed | cancelled |
|------------------|-------|-------------|----------|-----------|------------|
| **todo** | - | ✅ | ✅ | ❌ | ✅ |
| **in_progress** | ❌ | - | ✅ | ✅ | ✅ |
| **blocked** | ✅ | ✅ | - | ❌ | ✅ |
| **completed** | ❌ | ❌ | ❌ | - | ❌ |
| **cancelled** | ❌ | ❌ | ❌ | ❌ | - |

## 依赖关系处理

### 设置依赖时的状态检查

```
当设置任务 A dependsOn 任务 B 时：

1. 如果任务 B 状态是 completed：
   - 任务 A 可以开始，状态保持不变

2. 如果任务 B 状态不是 completed：
   - 任务 A 如果是 in_progress，自动转为 blocked
   - 任务 A 如果是 todo，建议转为 blocked
```

### 任务完成时的依赖处理

```
当任务 B 完成时：

1. 搜索所有 dependsOn 任务 B 的任务（A1, A2, ...）
2. 对每个 Ai：
   a. 检查 Ai 的所有依赖任务是否都已完成
   b. 如果是，更新 Ai 状态从 blocked 到 todo
   c. 如果否，保持 Ai 状态为 blocked
```

## 错误处理

| 错误类型 | 处理方式 |
|---------|---------|
| 非法状态转换 | 提示当前状态和允许的转换 |
| 任务不存在 | 返回错误，建议检查任务ID |
| 依赖任务不存在 | 提示依赖任务不存在，无法建立关系 |
| 已完成任务不能修改 | 返回错误，提示任务已完成 |
| 阻塞任务但无依赖原因 | 要求提供阻塞原因 |

## 相关模块

- [任务操作](任务操作.md) - 基础CRUD操作
- [任务统计](任务统计.md) - 统计报告

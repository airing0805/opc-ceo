# 自媒体 Agent 系统架构设计

> **版本**: V1.0  
> **日期**: 2026-02-27  
> **状态**: 草案  
> **任务ID**: v22.5

---

## 一、架构概述

### 1.1 设计原则

| 原则 | 说明 |
|------|------|
| **模块化** | 各 Agent 独立部署，职责单一 |
| **可扩展** | 支持新平台、新功能快速接入 |
| **异步优先** | 长时任务异步执行，提升响应速度 |
| **数据驱动** | 所有决策基于数据，可追溯 |

### 1.2 系统全景图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户交互层                                      │
│                    Claude Code / Web 界面 / CLI                              │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
┌───────────────────────────────────▼─────────────────────────────────────────┐
│                              协调层                                          │
│                                                                              │
│                         CEO Agent (协调中心)                                  │
│                    任务分发 │ 进度追踪 │ 冲突处理                              │
│                                                                              │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
        ▼                           ▼                           ▼
┌───────────────┐         ┌───────────────┐         ┌───────────────┐
│ 内容策划 Agent │         │ 内容生产 Agent │         │ 数据分析 Agent │
│               │         │               │         │               │
│ - 热点采集    │◄───────►│ - 文章生成    │◄───────►│ - 数据采集    │
│ - 选题推荐    │         │ - 多平台适配  │         │ - 效果分析    │
│ - 大纲生成    │         │ - 素材整合    │         │ - 报告生成    │
└───────┬───────┘         └───────┬───────┘         └───────┬───────┘
        │                         │                         │
        │         ┌───────────────┼───────────────┐         │
        │         │               │               │         │
        │         ▼               ▼               ▼         │
        │ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
        │ │ 发布执行 Agent │ │ 运营决策 Agent │ │ 素材设计 Agent │
        │ │               │ │               │ │               │
        │ │ - 多平台发布  │ │ - 策略建议    │ │ - 配图生成    │
        │ │ - 状态追踪    │ │ - 资源优化    │ │ - 封面设计    │
        │ │ - 错误重试    │ │ - 预警通知    │ │ - 模板管理    │
        │ └───────────────┘ └───────────────┘ └───────────────┘
        │                         │
        └─────────────────────────┼─────────────────────────────────────────┐
                                  │                                         │
┌─────────────────────────────────▼─────────────────────────────────────────┐
│                              数据层                                         │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │
│  │   知识图谱       │  │   任务队列      │  │   配置存储      │           │
│  │  (MCP Memory)   │  │   (Redis)       │  │   (JSON/YAML)   │           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘           │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │
│  │   内容存储       │  │   数据缓存      │  │   日志存储      │           │
│  │   (FileSystem)  │  │   (SQLite)      │  │   (File)        │           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────▼─────────────────────────────────────────┐
│                            外部集成层                                       │
│                                                                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ Claude  │  │  知乎   │  │  简书   │  │  CSDN   │  │  掘金   │        │
│  │   API   │  │  API    │  │  API    │  │  API    │  │  API    │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
│                                                                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │  公众号  │  │  B站    │  │ 热点API │  │ 图片API │  │ 支付API │        │
│  │  API    │  │  API    │  │         │  │         │  │         │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、核心模块设计

### 2.1 CEO Agent（协调中心）

#### 职责定义

| 职责 | 说明 |
|------|------|
| 任务接收 | 接收用户指令，解析意图 |
| 任务分发 | 将任务分发给专业 Agent |
| 进度追踪 | 追踪各 Agent 任务执行状态 |
| 冲突处理 | 处理资源冲突、优先级调整 |
| 结果汇总 | 汇总各 Agent 执行结果 |

#### 协作流程

```
用户指令
    │
    ▼
┌───────────────┐
│  意图解析     │ ─── 识别任务类型（选题/创作/发布/分析）
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  任务拆分     │ ─── 拆分为子任务，确定依赖关系
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  Agent 分配   │ ─── 根据任务类型分配专业 Agent
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  执行监控     │ ─── 监控执行进度，处理异常
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  结果汇总     │ ─── 汇总结果，返回用户
└───────────────┘
```

### 2.2 内容策划 Agent

#### 模块结构

```
内容策划 Agent
│
├── 热点采集模块
│   ├── 知乎热榜采集
│   ├── 微博热搜采集
│   ├── 头条热点采集
│   └── 行业资讯采集
│
├── 选题推荐模块
│   ├── 热度计算
│   ├── 竞争度分析
│   ├── 匹配度评估
│   └── 推荐排序
│
├── 大纲生成模块
│   ├── 结构模板
│   ├── 内容填充
│   └── 风格适配
│
└── 选题库管理
    ├── 选题状态追踪
    ├── 历史记录
    └── 标签管理
```

#### 选题推荐算法

```
推荐分数 = 热度分数 × 0.3 
         + 竞争度分数 × 0.2 
         + 匹配度分数 × 0.3 
         + 时效性分数 × 0.2

其中：
- 热度分数：基于搜索量、讨论量
- 竞争度分数：反向指标，竞争越低分数越高
- 匹配度分数：与账号定位的契合程度
- 时效性分数：热点衰减曲线
```

### 2.3 内容生产 Agent

#### 生成流程

```
选题输入
    │
    ▼
┌───────────────┐
│  大纲解析     │ ─── 解析选题和大纲结构
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  内容生成     │ ─── 调用 Claude API 生成内容
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  质量检测     │ ─── 检查字数、可读性、敏感词
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  格式适配     │ ─── 适配目标平台格式
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  素材整合     │ ─── 添加配图、封面
└───────┬───────┘
        │
        ▼
    输出内容
```

#### 内容模板结构

```yaml
article:
  title: "文章标题"
  summary: "摘要（100字以内）"
  content:
    - type: heading
      level: 1
      text: "一级标题"
    - type: paragraph
      text: "正文内容..."
    - type: code
      language: python
      code: "print('hello')"
    - type: image
      url: "配图URL"
      alt: "图片描述"
  tags: ["标签1", "标签2"]
  category: "分类"
```

### 2.4 数据分析 Agent

#### 数据采集架构

```
┌─────────────────────────────────────────────────────────────┐
│                      数据采集器                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 知乎采集器   │  │ 简书采集器   │  │ CSDN采集器  │        │
│  │             │  │             │  │             │        │
│  │ - 粉丝数    │  │ - 粉丝数    │  │ - 粉丝数    │        │
│  │ - 阅读量    │  │ - 阅读量    │  │ - 阅读量    │        │
│  │ - 互动数据  │  │ - 互动数据  │  │ - 互动数据  │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 掘金采集器   │  │ B站采集器    │  │ 公众号采集器 │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据处理层                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 数据清洗    │  │ 数据聚合    │  │ 数据存储    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      分析引擎                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 趋势分析    │  │ 归因分析    │  │ 预测模型    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 数据模型

```python
# 账号数据模型
class AccountMetrics:
    platform: str          # 平台名称
    date: date             # 日期
    followers: int         # 粉丝数
    new_followers: int     # 新增粉丝
    total_views: int       # 总阅读量
    daily_views: int       # 日阅读量
    engagement_rate: float # 互动率

# 内容数据模型
class ContentMetrics:
    content_id: str        # 内容ID
    platform: str          # 平台
    title: str             # 标题
    publish_date: datetime # 发布时间
    views: int             # 阅读量
    likes: int             # 点赞数
    comments: int          # 评论数
    shares: int            # 分享数
    saves: int             # 收藏数
```

### 2.5 发布执行 Agent

#### 发布流程

```
待发布内容
    │
    ▼
┌───────────────┐
│  平台选择     │ ─── 选择目标发布平台
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  格式转换     │ ─── 转换为平台特定格式
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  预览确认     │ ─── 预览发布效果（可选）
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  发布执行     │ ─── 调用平台 API 发布
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  状态追踪     │ ─── 记录发布状态和链接
└───────┬───────┘
        │
        ▼
   发布完成
```

#### 平台适配器模式

```
┌─────────────────────────────────────────────────────────────┐
│                    PlatformAdapter (接口)                    │
├─────────────────────────────────────────────────────────────┤
│ + publish(content: Content) -> PublishResult                │
│ + get_status(content_id: str) -> PublishStatus              │
│ + delete(content_id: str) -> bool                           │
│ + get_metrics(content_id: str) -> ContentMetrics            │
└─────────────────────────────────────────────────────────────┘
                              △
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        │                     │                     │
┌───────┴───────┐    ┌───────┴───────┐    ┌───────┴───────┐
│ ZhihuAdapter  │    │ JianShuAdapter│    │  CSDNAdapter  │
└───────────────┘    └───────────────┘    └───────────────┘
```

### 2.6 素材设计 Agent

#### 素材类型

| 类型 | 用途 | 来源 | 规格 |
|------|------|------|------|
| 配图 | 文章插图 | AI 生成/图库 | 1200x800 |
| 封面 | 文章封面 | AI 生成/模板 | 平台特定 |
| 头像 | 账号头像 | AI 设计/设计 | 200x200 |
| 海报 | 活动海报 | 模板生成 | 1080x1920 |

#### 生成流程

```
素材需求
    │
    ▼
┌───────────────┐
│  需求解析     │ ─── 解析类型、风格、尺寸
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  来源选择     │ ─── AI生成/图库/模板
└───────┬───────┘
        │
        ├──────────────┬──────────────┐
        ▼              ▼              ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│  AI 生成      │ │  图库搜索     │ │  模板渲染     │
│  (DALL-E)     │ │  (Unsplash)   │ │  (Canvas)     │
└───────┬───────┘ └───────┬───────┘ └───────┬───────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          │
                          ▼
                  ┌───────────────┐
                  │  素材输出     │
                  └───────────────┘
```

---

## 三、数据流设计

### 3.1 内容生产数据流

```
                    ┌─────────────────────────────────────────┐
                    │              内容生产数据流              │
                    └─────────────────────────────────────────┘

┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 选题输入 │───►│ 大纲生成 │───►│ 内容生成 │───►│ 格式适配 │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                    │                                │
                    │                                │
                    ▼                                ▼
              ┌──────────┐                    ┌──────────┐
              │ 选题库   │                    │ 内容库   │
              │ (Memory) │                    │ (Files)  │
              └──────────┘                    └──────────┘
                                                    │
                    ┌───────────────────────────────┘
                    │
                    ▼
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 素材整合 │───►│ 质量检测 │───►│ 发布队列 │───►│ 平台发布 │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                    │                                │
                    │                                │
                    ▼                                ▼
              ┌──────────┐                    ┌──────────┐
              │ 审核记录 │                    │ 发布记录 │
              │ (SQLite) │                    │ (Memory) │
              └──────────┘                    └──────────┘
```

### 3.2 数据采集数据流

```
                    ┌─────────────────────────────────────────┐
                    │              数据采集数据流              │
                    └─────────────────────────────────────────┘

┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 定时触发 │───►│ 任务队列 │───►│ 采集执行 │───►│ 数据清洗 │
│ (Cron)   │    │ (Redis)  │    │ (Spider) │    │ (Clean)  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                                                      │
                    ┌─────────────────────────────────┘
                    │
                    ▼
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 数据存储 │───►│ 指标计算 │───►│ 趋势分析 │───►│ 报告生成 │
│ (SQLite) │    │ (Calc)   │    │ (Analysis)│   │ (Report) │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
```

---

## 四、部署架构

### 4.1 单机部署（MVP）

```
┌─────────────────────────────────────────────────────────────┐
│                        单机部署                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   Claude Code 环境                    │   │
│  │                                                       │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐ │   │
│  │  │CEO Agent│  │策划Agent│  │生产Agent│  │分析Agent│ │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘ │   │
│  │                                                       │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐              │   │
│  │  │发布Agent│  │运营Agent│  │素材Agent│              │   │
│  │  └─────────┘  └─────────┘  └─────────┘              │   │
│  │                                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    本地数据层                         │   │
│  │                                                       │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │
│  │  │ MCP Mem  │  │  SQLite  │  │  Files   │           │   │
│  │  └──────────┘  └──────────┘  └──────────┘           │   │
│  │                                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 扩展部署（未来）

```
┌─────────────────────────────────────────────────────────────┐
│                        分布式部署                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │
│  │  API 网关   │────►│  任务调度   │────►│  消息队列   │   │
│  └─────────────┘     └─────────────┘     └─────────────┘   │
│                                                   │         │
│         ┌─────────────────────────────────────────┤         │
│         │                     │                   │         │
│         ▼                     ▼                   ▼         │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │
│  │ 策划服务    │     │ 生产服务    │     │ 分析服务    │   │
│  │ (Container) │     │ (Container) │     │ (Container) │   │
│  └─────────────┘     └─────────────┘     └─────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                     数据层                           │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │
│  │  │PostgreSQL│  │  Redis   │  │   OSS    │           │   │
│  │  └──────────┘  └──────────┘  └──────────┘           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、模块间协作

### 5.1 协作协议

```python
# Agent 间消息格式
class AgentMessage:
    sender: str           # 发送方 Agent ID
    receiver: str         # 接收方 Agent ID
    message_type: str     # 消息类型
    task_id: str          # 任务 ID
    payload: dict         # 消息内容
    timestamp: datetime   # 时间戳
    priority: int         # 优先级 (1-10)

# 消息类型
MESSAGE_TYPES = [
    "TASK_ASSIGN",        # 任务分配
    "TASK_UPDATE",        # 任务更新
    "TASK_COMPLETE",      # 任务完成
    "TASK_ERROR",         # 任务错误
    "DATA_REQUEST",       # 数据请求
    "DATA_RESPONSE",      # 数据响应
    "NOTIFICATION",       # 通知
]
```

### 5.2 协作示例

```
用户：「帮我写一篇关于 AI 工具的文章并发布到知乎」

1. CEO Agent 接收指令
   ├── 解析意图：创作 + 发布
   └── 拆分任务：选题 → 创作 → 发布

2. CEO Agent → 内容策划 Agent
   └── TASK_ASSIGN: 生成 AI 工具选题

3. 内容策划 Agent → CEO Agent
   └── TASK_COMPLETE: 返回选题和大纲

4. CEO Agent → 内容生产 Agent
   └── TASK_ASSIGN: 根据大纲生成文章

5. 内容生产 Agent → 素材设计 Agent
   └── DATA_REQUEST: 生成配图

6. 素材设计 Agent → 内容生产 Agent
   └── DATA_RESPONSE: 返回配图

7. 内容生产 Agent → CEO Agent
   └── TASK_COMPLETE: 返回完整文章

8. CEO Agent → 发布执行 Agent
   └── TASK_ASSIGN: 发布到知乎

9. 发布执行 Agent → CEO Agent
   └── TASK_COMPLETE: 返回发布结果

10. CEO Agent → 用户
    └── 返回最终结果
```

---

## 六、安全设计

### 6.1 凭证管理

| 凭证类型 | 存储方式 | 访问控制 |
|----------|----------|----------|
| API Key | 环境变量 | 只读 |
| 账号密码 | 加密存储 | 权限控制 |
| Token | 内存缓存 | 自动刷新 |

### 6.2 敏感数据处理

- 内容发布前敏感词检测
- 用户隐私数据脱敏
- 日志中敏感信息过滤

---

## 七、监控与告警

### 7.1 监控指标

| 指标类型 | 指标项 | 阈值 |
|----------|--------|------|
| 系统 | CPU/内存使用率 | >80% 告警 |
| 任务 | 任务成功率 | <90% 告警 |
| API | 响应时间 | >5s 告警 |
| 业务 | 内容生成数量 | 低于目标告警 |

### 7.2 告警渠道

- 控制台日志
- 系统通知
- （可选）邮件/微信通知

---

## 八、相关文档

| 文档 | 路径 |
|------|------|
| 需求文档 | 需求文档.md |
| 技术选型 | 技术选型.md |
| 开发计划 | 开发计划.md |

---

## 九、版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| V1.0 | 2026-02-27 | 初始版本 - 架构设计草案 |

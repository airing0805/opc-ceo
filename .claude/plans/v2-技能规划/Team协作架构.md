# Team 协作架构

## 概述

### 为什么需要 Team 模式

在 OPC-CEO 系统中，虽然各角色（task-manager、file-manager 等）可以独立通过 Skill 调用，但在处理复杂业务场景时，需要多个角色协同工作。**Team 模式**提供了：

1. **并行协作能力** - 多个 agent 可以同时执行独立任务，提高效率
2. **任务共享与协调** - 通过统一的任务列表实现任务分配和状态跟踪
3. **实时沟通机制** - 支持 agent 间直接通信和广播消息
4. **生命周期管理** - 统一的团队创建、协调、关闭流程

### Team 与独立 Task 调用的区别

| 维度 | 独立 Skill 调用 | Team 模式 |
|------|----------------|-----------|
| 执行方式 | 串行，逐个调用 | 并行，多个 agent 同时工作 |
| 状态共享 | 通过用户传递 | 通过任务列表自动同步 |
| 沟通方式 | 依赖用户中转 | agent 间直接消息传递 |
| 适用场景 | 简单、独立的任务 | 复杂、多角色协作的场景 |
| 生命周期 | 即时调用即结束 | 创建团队 → 执行 → 关闭 |

### 适用场景

| 场景 | 说明 | 示例 |
|------|------|------|
| 项目启动 | 需要多个角色同时创建资源 | 创建新项目：任务 + 文档 + 知识点 |
| 复杂分析 | 需要跨角色数据整合 | 财务分析：查询交易 + 知识存储 + 报告生成 |
| 工作流执行 | 需要多步骤流水线处理 | 日程规划：安排日程 + 关联任务 + 发送提醒 |
| 紧急响应 | 需要快速协调多个角色 | 系统故障：诊断 + 备份 + 通知 |

---

## 架构设计

### 整体架构图

```
                    CEO (opc-ceo-core)
                            │
                    决策协调层
                            │
                ┌───────────┴───────────┐
                │   Team 创建与管理    │
                │   TeamCreate         │
                └───────────┬───────────┘
                            │
                ┌───────────┼───────────┐
                │           │           │
                ▼           ▼           ▼
           ┌─────────┐ ┌─────────┐ ┌─────────┐
           │ Team A  │ │ Team B  │ │ Team C  │
           │ 项目启动 │ │ 财务分析 │ │ 日程规划 │
           └────┬────┘ └────┬────┘ └────┬────┘
                │            │            │
      ┌─────────┼────────────┼────────────┼─────────┐
      │         │            │            │         │
      ▼         ▼            ▼            ▼         ▼
 ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
 │agent-1  │ │agent-2  │ │agent-3  │ │agent-4  │ │agent-5  │
 │task     │ │file     │ │knowledge│ │finance  │ │schedule │
 └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
      │            │            │            │            │
      └────────────┴────────────┴────────────┴────────────┘
                           │
                  ┌────────┴────────┐
                  │  TaskList      │
                  │  任务列表       │
                  └─────────────────┘
```

### Team 与 CEO 的关系

```
┌─────────────────────────────────────────────────────────────┐
│                        CEO (opc-ceo-core)                  │
│                                                            │
│  ┌────────────────────────────────────────────────────┐   │
│  │              Team 协调管理器                       │   │
│  │                                                    │   │
│  │  1. 场景识别 - 判断是否需要 Team 模式             │   │
│  │  2. Team 创建 - 调用 TeamCreate                   │   │
│  │  3. Agent 启动 - 使用 Task 工具启动队友           │   │
│  │  4. 任务分发 - 使用 TaskUpdate 分配任务           │   │
│  │  5. 消息协调 - 通过 SendMessage 沟通             │   │
│  │  6. 结果汇总 - 收集各 agent 执行结果              │   │
│  │  7. Team 关闭 - 调用 TeamDelete 清理资源          │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
└─────────────────────────────────────────────────────────────┘
```

---

## Team 类别

### Team 类型定义

| Team 类型 | 用途 | 成员 | 典型场景 | agent_type (leader) |
|-----------|------|------|----------|---------------------|
| 项目启动 | 启动新项目 | task-manager, file-manager, knowledge-manager | 创建新项目 + 文档 + 知识点 | general-purpose |
| 财务分析 | 财务分析 | finance-manager, knowledge-manager | 生成财务报告 + 知识提取 | general-purpose |
| 日程规划 | 日程规划 | schedule-manager, task-manager | 安排日程 + 关联任务 | general-purpose |
| 全局协作 | 多角色协作 | 所有 agents | 复杂决策场景 | general-purpose |
| 文档整理 | 文档归档 | file-manager, knowledge-manager | 整理文档 + 提取知识 | general-purpose |
| 工作流执行 | 自动化流程 | automation-manager + 其他角色 | 定时任务 + 多步处理 | general-purpose |

### Team 配置示例

```json
{
  "team_name": "project-launch-PROJ-001",
  "description": "启动 PROJ-001 项目，创建任务、文档和知识库",
  "agent_type": "general-purpose"
}
```

---

## Team 创建流程

### 流程图

```
┌──────────────────────────────────────────────────────────────┐
│  1. 场景识别                                                 │
│     CEO 分析用户请求，判断是否需要 Team 模式                 │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────┐
│  2. Team 创建                                                 │
│     使用 TeamCreate 创建团队                                 │
│     - team_name: 唯一标识符（如 project-launch-PROJ-001）    │
│     - description: 团队用途描述                              │
│     - agent_type: team leader 类型                            │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────┐
│  3. 读取 Team 配置                                            │
│     读取 ~/.claude/teams/{team-name}/config.json            │
│     获取团队成员信息和当前状态                               │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────┐
│  4. 启动队友 Agents                                           │
│     使用 Task 工具创建队友 agents                            │
│     - name: agent 名称（如 task-agent）                       │
│     - team_name: 归属的团队                                   │
│     - subagent_type: agent 类型（如 general-purpose）        │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────┐
│  5. 创建任务列表                                              │
│     Team 创建时自动创建任务列表目录                         │
│     ~/.claude/tasks/{team-name}/                             │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────┐
│  6. 分配任务                                                  │
│     使用 TaskUpdate 设置任务 owner                           │
│     每个 agent 检查任务列表，认领未分配任务                 │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────┐
│  7. 执行与协调                                                │
│     Agents 并行执行任务                                       │
│     通过 SendMessage 进行协作沟通                             │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────┐
│  8. 结果汇总                                                  │
│     收集各 agent 的执行结果                                  │
│     生成综合报告给用户                                       │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────┐
│  9. Team 关闭                                                 │
│     使用 SendMessage 发送 shutdown_request 给所有队友        │
│     所有队友退出后，使用 TeamDelete 清理资源                 │
└──────────────────────────────────────────────────────────────┘
```

### 详细步骤说明

#### 步骤 1：场景识别

CEO 分析用户请求，判断是否需要 Team 模式：

| 判断依据 | 需要 Team | 不需要 Team |
|----------|-----------|-------------|
| 任务数量 | 多个独立任务需要同时执行 | 单一任务或串行任务 |
| 角色数量 | 需要 2+ 个不同角色协作 | 单一角色即可完成 |
| 复杂度 | 需要跨角色协调和状态共享 | 简单操作 |
| 实时性 | 需要 agent 间实时沟通 | 无需沟通 |

**判断示例**：
```
用户：「帮我启动一个新项目，创建任务、文档和知识库」
→ 需要 Team：涉及 3 个角色，可并行执行

用户：「帮我创建一个任务」
→ 不需要 Team：单一角色，直接调用 task-manager
```

#### 步骤 2：Team 创建

使用 `TeamCreate` 工具：

```json
{
  "team_name": "project-launch-PROJ-001",
  "description": "启动 PROJ-001 项目，创建任务、文档和知识库",
  "agent_type": "general-purpose"
}
```

**执行结果**：
- 创建团队配置文件：`~/.claude/teams/project-launch-PROJ-001/config.json`
- 创建任务列表目录：`~/.claude/tasks/project-launch-PROJ-001/`

#### 步骤 3：读取 Team 配置

```bash
cat ~/.claude/teams/project-launch-PROJ-001/config.json
```

```json
{
  "name": "project-launch-PROJ-001",
  "description": "启动 PROJ-001 项目，创建任务、文档和知识库",
  "leader": "project-launch-PROJ-001-leader",
  "members": []
}
```

#### 步骤 4：启动队友 Agents

使用 `Task` 工具创建队友（并行执行）：

```python
# 伪代码示例 - 并行创建 3 个队友
Task(
    name="task-agent",
    team_name="project-launch-PROJ-001",
    subagent_type="general-purpose",
    instructions="你是任务管理专家，负责创建项目任务..."
)

Task(
    name="file-agent",
    team_name="project-launch-PROJ-001",
    subagent_type="general-purpose",
    instructions="你是文件管理专家，负责创建项目文档..."
)

Task(
    name="knowledge-agent",
    team_name="project-launch-PROJ-001",
    subagent_type="general-purpose",
    instructions="你是知识管理专家，负责创建项目知识点..."
)
```

#### 步骤 5：创建任务列表

Team 创建时自动创建任务列表，可手动添加任务：

```python
TaskCreate(
    team_name="project-launch-PROJ-001",
    tasks=[
        {"content": "创建项目主任务 TASK-PROJ-001-001", "activeForm": "创建项目主任务"},
        {"content": "创建项目文档结构", "activeForm": "创建项目文档结构"},
        {"content": "添加项目知识实体", "activeForm": "添加项目知识实体"}
    ]
)
```

#### 步骤 6：分配任务

使用 `TaskUpdate` 设置任务 owner：

```python
TaskUpdate(
    team_name="project-launch-PROJ-001",
    task_id=1,
    owner="task-agent"
)

TaskUpdate(
    team_name="project-launch-PROJ-001",
    task_id=2,
    owner="file-agent"
)

TaskUpdate(
    team_name="project-launch-PROJ-001",
    task_id=3,
    owner="knowledge-agent"
)
```

#### 步骤 7：执行与协调

Agents 并行执行任务，使用 `SendMessage` 沟通：

```python
# agent 完成任务后通知队友
SendMessage(
    type="message",
    recipient="file-agent",
    content="任务 TASK-PROJ-001-001 已完成，任务 ID: TASK-PROJ-001-001",
    summary="通知文档 agent 任务完成"
)
```

#### 步骤 8：结果汇总

CEO 收集所有 agent 的执行结果：

```python
# 收集结果
results = {
    "task-agent": "创建了 3 个任务",
    "file-agent": "创建了 5 个文档文件",
    "knowledge-agent": "添加了 2 个知识实体"
}

# 生成报告
report = f"""
项目启动完成：
- 任务管理: {results['task-agent']}
- 文档管理: {results['file-agent']}
- 知识管理: {results['knowledge-agent']}
"""
```

#### 步骤 9：Team 关闭

发送关闭请求给所有队友，然后清理资源：

```python
# 关闭所有队友
SendMessage(
    type="shutdown_request",
    recipient="task-agent",
    content="项目启动完成，请退出"
)

SendMessage(
    type="shutdown_request",
    recipient="file-agent",
    content="项目启动完成，请退出"
)

SendMessage(
    type="shutdown_request",
    recipient="knowledge-agent",
    content="项目启动完成，请退出"
)

# 所有队友退出后清理资源
TeamDelete()
```

---

## SendMessage 协作规范

### 消息类型

| type | 用途 | 参数 | 是否需要 recipient |
|------|------|------|---------------------|
| message | 向单个 agent 发送消息 | recipient, content, summary | 是 |
| broadcast | 向所有队友广播消息 | content, summary | 否 |
| shutdown_request | 请求队友退出 | recipient, content | 是 |
| shutdown_response | 响应退出请求 | request_id, approve, content | 否（响应） |
| plan_approval_response | 审批/拒绝队友计划 | request_id, recipient, approve, content | 是 |

### 消息格式

#### type: message - 单对单消息

```python
SendMessage(
    type="message",
    recipient="task-agent",
    content="任务 TASK-PROJ-001-001 已完成，可以开始后续任务",
    summary="通知任务 agent 完成状态"
)
```

#### type: broadcast - 广播消息

**注意**：广播会向每个队友发送单独消息，成本较高，谨慎使用。

```python
SendMessage(
    type="broadcast",
    content="项目 PROJ-001 启动完成，各 agent 请汇报执行结果",
    summary="广播项目完成消息"
)
```

**适用场景**：
- 关键问题需要所有 agent 知道
- 主要功能变更通知
- Team 生命周期关键事件

#### type: shutdown_request - 请求退出

```python
SendMessage(
    type="shutdown_request",
    recipient="task-agent",
    content="项目启动完成，请准备退出"
)
```

**响应方式**（由队友 agent 调用）：

```python
SendMessage(
    type="shutdown_response",
    request_id="abc-123",  # 从 shutdown_request 消息中提取
    approve=True  # True=同意退出，False=拒绝
)
```

#### type: plan_approval_response - 计划审批

当队友使用 `ExitPlanMode` 退出计划模式时，会发送审批请求：

```python
SendMessage(
    type="plan_approval_response",
    request_id="plan-456",
    recipient="task-agent",
    approve=True
)
```

### 消息最佳实践

1. **优先使用 message 而非 broadcast** - 广播成本高
2. **summary 简洁明了** - 5-10 个字，便于 UI 展示
3. **content 详细清晰** - 包含足够上下文
4. **及时响应 shutdown_request** - 避免资源泄露
5. **拒绝退出时说明原因** - 便于协调

---

## 任务所有权管理

### TaskList 结构

任务列表存储在 `~/.claude/tasks/{team-name}/` 目录：

```
~/.claude/tasks/project-launch-PROJ-001/
├── task-001.json    # 任务 1 - 创建项目主任务
├── task-002.json    # 任务 2 - 创建文档结构
├── task-003.json    # 任务 3 - 添加知识实体
└── index.json       # 任务索引
```

### 任务状态

| 状态 | 说明 |
|------|------|
| pending | 未分配，等待认领 |
| in_progress | 已分配，执行中 |
| completed | 已完成 |
| blocked | 被其他任务阻塞 |

### 任务所有权流程

```
┌─────────────────────────────────────────────────────────────┐
│  1. CEO 创建任务（pending 状态）                            │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  2. Agent 检查 TaskList，发现 pending 任务                 │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  3. Agent 认领任务（使用 TaskUpdate 设置 owner）           │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 执行任务（状态变为 in_progress）                       │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 完成任务（状态变为 completed）                          │
└─────────────────────┬────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  6. Agent 检查 TaskList，查找下一个 pending 任务           │
└─────────────────────────────────────────────────────────────┘
```

### TaskUpdate 使用示例

```python
# Agent 认领任务
TaskUpdate(
    team_name="project-launch-PROJ-001",
    task_id=1,
    owner="task-agent",
    status="in_progress"
)

# Agent 完成任务
TaskUpdate(
    team_name="project-launch-PROJ-001",
    task_id=1,
    status="completed",
    result="创建了任务 TASK-PROJ-001-001"
)
```

### 任务分配策略

| 策略 | 说明 | 适用场景 |
|------|------|----------|
| 按角色分配 | 根据任务类型分配给对应角色 | 明确角色分工 |
| 负载均衡 | 分配给任务最少的 agent | 同类型任务 |
| 优先级分配 | 高优先级任务先分配 | 紧急场景 |
| 自主认领 | Agent 主动认领可处理任务 | 灵活协作 |

---

## 示例场景

### 场景 1：启动新项目

**用户请求**：
```
帮我启动一个新项目「个人网站 V2」，需要创建任务、文档和知识库。
```

**CEO 执行流程**：

```
┌─────────────────────────────────────────────────────────────┐
│  CEO 决策流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 场景识别：需要 3 个角色并行协作 → 使用 Team 模式       │
│  2. Team 创建：                                              │
│     - team_name: "project-launch-PROJ-001"                  │
│     - description: "启动 PROJ-001 项目"                    │
│  3. 创建任务列表：                                          │
│     - 任务 1: 创建项目任务                                  │
│     - 任务 2: 创建文档结构                                  │
│     - 任务 3: 添加知识实体                                  │
│  4. 启动 Agents（并行）：                                   │
│     - task-agent (owner: 任务 1)                           │
│     - file-agent (owner: 任务 2)                           │
│     - knowledge-agent (owner: 任务 3)                      │
│  5. 执行与协调：                                            │
│     - task-agent: 创建主任务 TASK-2026-02-24-001           │
│     - file-agent: 创建文档目录结构                          │
│     - knowledge-agent: 创建项目知识实体                     │
│  6. 结果汇总：                                              │
│     - 收集 3 个 agent 的执行结果                           │
│     - 生成项目启动报告                                     │
│  7. Team 关闭：发送 shutdown_request 给所有 agents         │
└─────────────────────────────────────────────────────────────┘
```

**执行结果**：
```
项目「个人网站 V2」启动完成：

✓ 任务管理: 创建了 1 个主任务
  - TASK-2026-02-24-001: 个人网站 V2 开发

✓ 文档管理: 创建了文档结构
  - ~/Documents/Projects/个人网站-V2/
    ├── README.md
    ├── 设计文档/
    └── 测试文档/

✓ 知识管理: 添加了知识实体
  - 实体: PROJ-001 (个人网站 V2)
  - 观察: 项目启动日期 2026-02-24
```

---

### 场景 2：财务分析

**用户请求**：
```
帮我分析本月的财务情况，生成报告并存储到知识库。
```

**CEO 执行流程**：

```
┌─────────────────────────────────────────────────────────────┐
│  CEO 决策流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 场景识别：需要 finance + knowledge 协作 → Team 模式   │
│  2. Team 创建：                                              │
│     - team_name: "finance-analysis-2026-02"               │
│     - description: "2026年2月财务分析"                      │
│  3. 创建任务列表：                                          │
│     - 任务 1: 查询本月交易数据                             │
│     - 任务 2: 生成财务分析报告                             │
│     - 任务 3: 存储分析结果到知识库                         │
│  4. 启动 Agents（并行）：                                   │
│     - finance-agent (owner: 任务 1, 2)                     │
│     - knowledge-agent (owner: 任务 3)                      │
│  5. 执行与协调：                                            │
│     - finance-agent:                                        │
│       * 查询 2026-02-01 至 2026-02-24 的交易              │
│       * 统计总收入: ¥15,000                                │
│       * 统计总支出: ¥8,500                                 │
│       * 生成报告                                           │
│     - knowledge-agent:                                       │
│       * 等待 finance-agent 完成查询                         │
│       * 收到报告数据后，创建知识实体                       │
│  6. 结果汇总：                                              │
│     - 显示财务分析报告                                     │
│  7. Team 关闭                                              │
└─────────────────────────────────────────────────────────────┘
```

**Agent 协作消息流**：

```
[finance-agent] → [knowledge-agent]
message: "财务数据查询完成，总收入 ¥15,000，总支出 ¥8,500，
          净收益 ¥6,500，可以开始存储知识实体"

[knowledge-agent] → [finance-agent]
message: "知识实体已创建，ID: FINANCE-ANALYSIS-2026-02，
          存储了收入、支出、净收益等数据"
```

**执行结果**：
```
2026年2月财务分析报告：

────────────────────────────
收入统计
────────────────────────────
项目收入: ¥12,000
咨询服务: ¥3,000
总收入: ¥15,000

────────────────────────────
支出统计
────────────────────────────
办公设备: ¥2,000
软件订阅: ¥1,500
云服务: ¥3,000
其他支出: ¥2,000
总支出: ¥8,500

────────────────────────────
净收益
────────────────────────────
¥6,500

✓ 分析结果已存储到知识库
  知识实体: FINANCE-ANALYSIS-2026-02
```

---

### 场景 3：日程规划与任务关联

**用户请求**：
```
帮我安排明天的日程，并关联相关任务。
```

**CEO 执行流程**：

```
┌─────────────────────────────────────────────────────────────┐
│  CEO 决策流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 场景识别：需要 schedule + task 协作 → Team 模式       │
│  2. Team 创建：                                              │
│     - team_name: "daily-planning-2026-02-25"              │
│     - description: "2026-02-25 日程规划"                  │
│  3. 创建任务列表：                                          │
│     - 任务 1: 获取待处理任务列表                           │
│     - 任务 2: 安排日程                                     │
│     - 任务 3: 关联日程与任务                               │
│  4. 启动 Agents（并行）：                                   │
│     - task-agent (owner: 任务 1)                          │
│     - schedule-agent (owner: 任务 2, 3)                    │
│  5. 执行与协调：                                            │
│     - task-agent:                                          │
│       * 查询所有 TODO 状态的任务                           │
│       * 返回任务列表                                       │
│     - schedule-agent:                                      │
│       * 等待任务列表                                       │
│       * 根据任务优先级安排日程                             │
│       * 创建事件实体，关联任务 ID                          │
│  6. 结果汇总：显示日程规划                                 │
│  7. Team 关闭                                              │
└─────────────────────────────────────────────────────────────┘
```

**执行结果**：
```
2026-02-25 日程规划：

────────────────────────────
09:00 - 11:00 | Deep Work
────────────────────────────
完成任务: TASK-2026-02-24-001
描述: 个人网站 V2 开发 - 前端页面
事件 ID: EVENT-2026-02-25-001

────────────────────────────
11:00 - 12:00 | Meeting
────────────────────────────
客户会议: 与 ABC 公司讨论需求
事件 ID: EVENT-2026-02-25-002

────────────────────────────
14:00 - 16:00 | Deep Work
────────────────────────────
完成任务: TASK-2026-02-23-003
描述: 财务报表分析
事件 ID: EVENT-2026-02-25-003

────────────────────────────
16:00 - 17:00 | Admin
────────────────────────────
完成任务: TASK-2026-02-22-005
描述: 整理项目文档
事件 ID: EVENT-2026-02-25-004

✓ 日程已创建，所有任务已关联
```

---

### 场景 4：复杂工作流 - 项目周报

**用户请求**：
```
生成「个人网站 V2」项目的周报，包含任务进度、财务支出和时间统计。
```

**CEO 执行流程**：

```
┌─────────────────────────────────────────────────────────────┐
│  CEO 决策流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 场景识别：需要 4 个角色协作 → Team 模式              │
│  2. Team 创建：                                              │
│     - team_name: "weekly-report-PROJ-001-WK08"             │
│     - description: "PROJ-001 第8周周报"                    │
│  3. 创建任务列表（并行任务）：                               │
│     - 任务 1: 统计任务进度 (task-agent)                    │
│     - 任务 2: 查询财务支出 (finance-agent)                 │
│     - 任务 3: 统计时间投入 (schedule-agent)                │
│     - 任务 4: 生成周报并存储 (knowledge-agent)             │
│  4. 启动 Agents（全部并行）：                               │
│     - task-agent (owner: 任务 1)                          │
│     - finance-agent (owner: 任务 2)                       │
│     - schedule-agent (owner: 任务 3)                      │
│     - knowledge-agent (owner: 任务 4 - 依赖前3个任务)       │
│  5. 执行与协调：                                            │
│     - 前 3 个 agents 并行执行                              │
│     - 完成后发送消息给 knowledge-agent                    │
│     - knowledge-agent 收集数据，生成周报                   │
│  6. 结果汇总：显示周报                                     │
│  7. Team 关闭                                              │
└─────────────────────────────────────────────────────────────┘
```

**Agent 消息流**：

```
[task-agent] → [knowledge-agent]
message: "任务进度统计完成：
          - 总任务: 15
          - 已完成: 8
          - 进行中: 5
          - 阻塞: 2"

[finance-agent] → [knowledge-agent]
message: "财务支出统计完成：
          - 本周支出: ¥3,500
          - 云服务: ¥2,000
          - 软件订阅: ¥1,000
          - 其他: ¥500"

[schedule-agent] → [knowledge-agent]
message: "时间投入统计完成：
          - Deep Work: 12 小时
          - Meetings: 4 小时
          - Admin: 2 小时
          - 总计: 18 小时"

[knowledge-agent]
收集所有数据后生成周报并存储
```

**执行结果**：
```
PROJ-001 「个人网站 V2」第8周周报
报告期间: 2026-02-17 至 2026-02-23

────────────────────────────
任务进度
────────────────────────────
总任务数: 15
✓ 已完成: 8 (53%)
→ 进行中: 5 (33%)
⚠ 阻塞: 2 (14%)

完成的主要任务:
- TASK-2026-02-20-001: 首页设计
- TASK-2026-02-21-003: 数据库设计
- TASK-2026-02-22-002: API 开发

────────────────────────────
财务支出
────────────────────────────
本周支出: ¥3,500
- 云服务: ¥2,000
- 软件订阅: ¥1,000
- 其他: ¥500

累计支出: ¥12,000

────────────────────────────
时间投入
────────────────────────────
Deep Work: 12 小时 (67%)
Meetings: 4 小时 (22%)
Admin: 2 小时 (11%)
总计: 18 小时

────────────────────────────
总结
────────────────────────────
本周进展顺利，任务完成率达到预期。
建议下周解决阻塞任务，优先级提高。

✓ 周报已存储到知识库
  知识实体: WEEKLY-REPORT-PROJ-001-WK08
```

---

## 最佳实践

### Team 创建规范

| 规范 | 说明 |
|------|------|
| 命名 | 使用描述性名称，包含业务标识（如 project-launch-PROJ-001） |
| 描述 | 清晰说明团队用途和目标 |
| Leader | 选择合适的 agent_type（通常为 general-purpose） |
| 成员数量 | 避免过多成员，2-5 个为佳 |

### 消息发送规范

| 规范 | 说明 |
|------|------|
| 简洁 | content 包含必要信息，避免冗长 |
| 明确 | summary 清晰概括消息内容 |
| 及时 | 完成任务后立即通知队友 |
| 适度 | 谨慎使用 broadcast |

### 任务分配规范

| 规范 | 说明 |
|------|------|
| 粒度适中 | 任务大小适合单个 agent 处理 |
| 依赖明确 | 有依赖的任务注明前置条件 |
| 优先级标记 | 高优先级任务优先分配 |
| 避免重复 | 同一任务不分配给多个 agent |

### 错误处理

| 错误类型 | 处理方式 |
|----------|----------|
| Agent 无响应 | 重试或重新分配任务 |
| 任务执行失败 | 标记为 blocked，记录错误信息 |
| Team 创建失败 | 检查 team_name 是否重复，重试 |
| 资源清理失败 | 手动清理 ~/.claude/teams/ 和 ~/.claude/tasks/ |

---

## 总结

Team 协作模式为 OPC-CEO 提供了高效的多角色协作能力，适用于需要多个角色并行工作的复杂场景。通过合理使用 TeamCreate、SendMessage、TaskUpdate 等工具，可以实现：

1. **并行执行** - 提高任务处理效率
2. **自动协调** - 减少人工干预
3. **状态共享** - 通过任务列表同步进度
4. **灵活扩展** - 支持不同类型的协作模式

在 CEO 的统一协调下，各专业角色可以协同工作，共同完成复杂的业务目标。

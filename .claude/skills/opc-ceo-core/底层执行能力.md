# 底层执行能力

> 本模块记录 CEO 的具体操作流程和工具使用规范，是 V6.1 自我进化能力的核心补充。

---

## 一、工具选择决策树

### 1.1 决策优先级

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     CEO 工具选择决策树                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   判断操作类型                                                            │
│      │                                                                   │
│      ├── 【文档操作】                                                     │
│      │   │                                                               │
│      │   ├── 读取 → mcp__filesystem__read_file（首选）                    │
│      │   │         └→ Read（备选，MCP 不可用时）                          │
│      │   │                                                               │
│      │   ├── 写入 → mcp__filesystem__write_file（首选）                   │
│      │   │         └→ Write（备选，MCP 不可用时）                         │
│      │   │                                                               │
│      │   └── 编辑 → Edit（首选，精确字符串替换）                           │
│      │               └→ mcp__filesystem__edit_file（备选）               │
│      │                                                                   │
│      ├── 【Memory 操作】                                                  │
│      │   │                                                               │
│      │   ├── 创建实体 → mcp__memory__create_entities                     │
│      │   ├── 查询实体 → mcp__memory__search_nodes                        │
│      │   ├── 更新实体 → mcp__memory__add_observations                    │
│      │   ├── 创建关系 → mcp__memory__create_relations                    │
│      │   ├── 删除实体 → mcp__memory__delete_entities                     │
│      │   └── 读取图谱 → mcp__memory__read_graph                          │
│      │                                                                   │
│      ├── 【文件搜索】                                                     │
│      │   │                                                               │
│      │   ├── 按名称 → Glob（首选，更友好的输出）                           │
│      │   │           └→ mcp__filesystem__search_files（备选）            │
│      │   │                                                               │
│      │   └── 按内容 → Grep（首选，更友好的输出）                           │
│      │                                                                   │
│      └── 【系统操作】                                                     │
│          │                                                               │
│          └── Bash（唯一选择，用于 git/npm/mkdir 等）                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 工具选择矩阵

| 操作类型 | 首选工具 | 备选工具 | 说明 |
|----------|----------|----------|------|
| 文档读取 | `mcp__filesystem__read_file` | `Read` | MCP 优先，解决环境问题 |
| 文档写入 | `mcp__filesystem__write_file` | `Write` | MCP 优先 |
| 文档编辑 | `Edit` | `mcp__filesystem__edit_file` | 精确替换用 Edit |
| 目录列表 | `mcp__filesystem__list_directory` | `Bash ls` | MCP 更友好 |
| 文件搜索 | `Glob` | `mcp__filesystem__search_files` | Glob 更友好 |
| 内容搜索 | `Grep` | - | 唯一选择 |
| Memory 查询 | `mcp__memory__search_nodes` | - | 唯一选择 |
| Memory 创建 | `mcp__memory__create_entities` | - | 唯一选择 |
| 系统命令 | `Bash` | - | 唯一选择 |

---

## 二、文档操作标准流程

### 2.1 读取文档

**首选工具**: `mcp__filesystem__read_file`

> **重要**: 根据项目规范，当前电脑环境 Direct 编辑/写入有问题，所有文档操作**优先使用 MCP 工具**。

#### 使用场景

| 场景 | 路径示例 |
|------|----------|
| 读取任务分配 | `docs/沟通文档/任务分配.md` |
| 读取战略目标 | `docs/战略规划/战略目标.md` |
| 读取版本规划 | `docs/版本规划/v2-技能规划/README.md` |
| 读取角色配置 | `.claude/skills/xxx/SKILL.md` |

#### 操作步骤

```
1. 确定文件路径（使用绝对路径）
2. 调用 mcp__filesystem__read_file
3. 检查返回内容
4. 如 MCP 不可用，使用 Read 备选
```

### 2.2 写入文档

**首选工具**: `mcp__filesystem__write_file`

#### 使用场景

| 场景 | 说明 |
|------|------|
| 创建新文档 | 创建新的规划文档或记录 |
| 更新任务状态 | 重写整个任务分配文件 |
| 记录执行日志 | 写入操作过程 |

#### 操作步骤

```
1. 准备要写入的内容
2. 确定文件路径（使用绝对路径）
3. 如是覆盖现有文件，先读取确认内容
4. 调用 mcp__filesystem__write_file
5. 验证写入结果
```

### 2.3 编辑文档

**首选工具**: `Edit`（精确字符串替换）

#### 使用场景

| 场景 | 说明 |
|------|------|
| 更新状态 | 修改任务状态字段 |
| 追加内容 | 在特定位置插入内容 |
| 修正错误 | 替换错误内容 |

#### 操作步骤

```
1. 读取文件获取当前内容
2. 确定 old_string（必须唯一）
3. 准备 new_string
4. 调用 Edit 工具
5. 验证修改结果
```

---

## 三、Memory 操作标准流程

### 3.1 创建实体

**工具**: `mcp__memory__create_entities`

#### 实体类型定义

| 实体类型 | 命名格式 | 用途 |
|----------|----------|------|
| Task | `v2.x.y` 或 `TASK-YYYY-MM-DD-NNN` | 任务记录 |
| Decision | `DECISION-YYYY-MM-DD-NNN` | 决策记录 |
| CoordinationEvent | `COORD-YYYY-MM-DD-NNN` | 协调事件 |
| Evolution | `EVO-YYYY-MM-DD-NNN` | 进化决策 |
| ExecutionLog | `LOG-YYYY-MM-DD-NNN` | 执行日志 |
| SelfReflection | `REFLECT-YYYY-MM-DD-NNN` | 自我反思 |

#### 标准观察字段

```json
// 任务实体示例
{
  "name": "v2.4.1.1",
  "entityType": "Task",
  "observations": [
    "description: 创建 CEO 底层执行能力.md",
    "status: in_progress",
    "assignedTo: opc-ceo-core",
    "priority: high",
    "createdAt: 2026-02-26T10:00:00",
    "dueDate: 2026-02-26"
  ]
}
```

### 3.2 查询实体

**工具**: `mcp__memory__search_nodes`

#### 常用查询关键词

| 场景 | 查询关键词 |
|------|------------|
| 检查整体状态 | `company status task project` |
| 查找任务 | `TASK` 或 `v2.x` |
| 查找决策 | `DECISION-YYYY-MM` |
| 查找进化记录 | `EVO` 或 `Evolution` |

### 3.3 更新实体

**工具**: `mcp__memory__add_observations`

#### 常见更新场景

```json
// 更新任务状态
{
  "observations": [
    {
      "entityName": "v2.4.1.1",
      "contents": [
        "status: completed",
        "completedAt: 2026-02-26T12:00:00",
        "result: 成功创建底层执行能力.md"
      ]
    }
  ]
}
```

### 3.4 创建关系

**工具**: `mcp__memory__create_relations`

#### 关系类型定义

| 关系类型 | 用途 | 示例 |
|----------|------|------|
| `depends_on` | 任务依赖 | Task A → Task B |
| `assigned_to` | 任务分配 | Task → Role |
| `triggered_by` | 触发关系 | Task → Decision |
| `relates_to` | 相关联 | 任意实体 |

---

## 四、执行检查清单

### 4.1 执行前检查（必须全部通过）

```
□ 复杂度评分
  - 使用简化评分表
  - 确定分发级别 L1-L5

□ 工具选择
  - 按照决策树选择工具
  - 文档操作优先 MCP

□ 需求理解
  - 是否理解用户真实需求？
  - 是否需要追问为什么？

□ 触发词确认（如需执行）
  - "去执行" / "开始做" / "执行它" / "按照这个方案执行"
```

### 4.2 执行中检查（关键节点）

```
□ 每步操作是否成功？
□ 是否出现异常需要处理？
□ 是否需要调整执行策略？
□ 上下文是否保持完整？
```

### 4.3 执行后检查（必须全部完成）

```
□ 结果验证
  - 结果是否符合预期？
  - 验证是否通过？

□ 记录更新
  - 是否记录到执行日志？
  - 是否更新 Memory？
  - 是否同步文档？

□ 反思总结
  - 有什么教训？
  - 可以改进什么？
```

---

## 五、常见场景操作指南

### 5.1 任务记录流程

```
触发时机: 与用户沟通确认任务后

步骤 1: 创建 Memory 实体
  工具: mcp__memory__create_entities
  内容: 创建 Task 实体

步骤 2: 更新任务分配文档
  工具: mcp__filesystem__read_file + write_file
  路径: docs/沟通文档/任务分配.md
  内容: 追加新任务记录

步骤 3: 记录决策（如有）
  工具: mcp__memory__create_entities
  内容: 创建 Decision 实体
```

### 5.2 进化记录流程

```
触发时机: 完成能力改进后

步骤 1: 创建进化记录
  工具: mcp__memory__create_entities
  实体类型: Evolution
  内容: 记录进化类型、变更内容、状态

步骤 2: 更新 Skill 文件
  工具: Edit
  内容: 更新版本号、模块索引、变更历史

步骤 3: 记录到执行日志
  工具: mcp__filesystem__write_file
  路径: docs/执行日志/YYYY-MM-DD.md
```

### 5.3 协调记录流程

```
触发时机: 跨角色协调任务时

步骤 1: 创建协调事件
  工具: mcp__memory__create_entities
  实体类型: CoordinationEvent
  命名: COORD-YYYY-MM-DD-NNN

步骤 2: 更新协调文档
  工具: mcp__filesystem__write_file
  路径: docs/沟通文档/协调记录.md

步骤 3: 创建任务关系
  工具: mcp__memory__create_relations
  关系类型: depends_on / relates_to
```

### 5.4 启动自检流程

```
触发时机: 每次会话开始时

步骤 1: 检查 Memory 状态
  工具: mcp__memory__search_nodes
  查询: "company status task project"
  判断: 若返回空，需要从文档重建

步骤 2: 检查 Git 状态
  工具: Bash
  命令: git status
  判断: 若有未提交变更，记录到日志

步骤 3: 检查待办任务
  工具: mcp__filesystem__read_file
  路径: docs/沟通文档/任务分配.md
  判断: 识别未完成任务

步骤 4: 检查关键文档
  工具: mcp__filesystem__read_file
  路径: docs/战略规划/战略目标.md
  判断: 确认文档存在且可读
```

---

## 六、故障排除指南

### 6.1 MCP 工具不可用

**症状**: 调用 `mcp__*` 工具返回错误

**解决方案**:
1. 使用内置工具作为备选（Read, Write, Edit）
2. 记录问题到执行日志
3. 通知用户检查 MCP 配置

**备选方案表**:
| MCP 工具 | 备选工具 |
|----------|----------|
| `mcp__filesystem__read_file` | `Read` |
| `mcp__filesystem__write_file` | `Write` |
| `mcp__filesystem__edit_file` | `Edit` |
| `mcp__filesystem__search_files` | `Glob` |
| `mcp__filesystem__list_directory` | `Bash ls` |

### 6.2 Memory 返回空

**症状**: `search_nodes` 返回空结果

**解决方案**:
1. 执行 Memory 重建流程
2. 从文档读取数据
3. 创建必要的 Memory 实体

**重建流程**:
```
1. 读取 docs/沟通文档/任务分配.md
2. 解析任务列表
3. 为每个任务创建 Task 实体
4. 读取 docs/战略规划/战略目标.md
5. 为每个目标创建 Goal 实体
```

### 6.3 文档写入失败

**症状**: `write_file` 返回错误

**解决方案**:
1. 检查路径是否存在（使用 list_directory）
2. 检查文件权限
3. 尝试使用内置 Write 工具
4. 检查磁盘空间

### 6.4 工具选择不确定

**症状**: 不确定使用哪个工具

**解决方案**:
1. 参考"工具选择决策树"
2. 优先使用 MCP 工具进行文档操作
3. Memory 操作只有 MCP 工具可用
4. 系统操作只用 Bash

---

## 七、简化复杂度评分表

### 7.1 快速评分方法

**公式**: `复杂度 = 基础分 × 文件数 × 操作系数`

| 任务类型 | 基础分 | 典型文件数 | 操作系数 | 典型分数 |
|----------|--------|------------|----------|----------|
| 单文件读取 | 0.5 | 1 | 1.0 | **0.5** |
| 单文件写入 | 1.0 | 1 | 1.5 | **1.5** |
| 文档编辑 | 1.0 | 1 | 1.8 | **1.8** |
| 跨文件搜索 | 1.5 | 2 | 1.0 | **3.0** |
| 任务创建 | 2.0 | 1 | 1.5 | **3.0** |
| 知识推理 | 4.0 | 1 | 1.2 | **4.8** |
| 多角色协调 | 6.0 | 2 | 1.2 | **14.4** |

### 7.2 分发级别判断

| 分数范围 | 级别 | 执行方式 |
|----------|------|----------|
| < 2 | L1 | 直接执行 |
| 2-4 | L2 | MCP 工具 |
| 4-6 | L3 | Agent 执行 |
| 6-8 | L4 | Team 协调 |
| > 8 | L5 | 拆分递归 |

---

## 八、版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0.0 | 2026-02-26 | 初始版本 - 工具决策树、文档操作、Memory 操作、检查清单、场景指南、故障排除 |

---

## 相关模块

- [SKILL.md](SKILL.md) - 主入口文档
- [自我进化.md](自我进化.md) - 自我反思与持续改进
- [能力边界.md](能力边界.md) - 角色能力范围定义
- [快速参考.md](快速参考.md) - 快速查阅手册

---

> opc-ceo-core V6.1 - 底层执行能力模块

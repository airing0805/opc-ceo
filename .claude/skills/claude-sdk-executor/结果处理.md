# 结果处理

## 功能概述

提供结果解析、存储和错误处理功能。

## 操作命令

### 命令 1：解析结果

**用途**：解析 Claude API 响应并提取关键信息

**语法**：
```
解析结果:
  - response: <API响应>
  - extractFields: <提取字段>
```

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| response | object | 是 | Claude API 响应对象 |
| extractFields | array | 否 | 需要提取的字段列表 |

**提取字段类型**：

| 字段 | 说明 |
|------|------|
| content | 响应内容 |
| tool_calls | 工具调用列表 |
| usage | Token 使用量 |
| model | 使用的模型 |
| stop_reason | 停止原因 |

**示例**：

```json
{
  "response": {"id": "msg_xxx", ...},
  "extractFields": ["content", "tool_calls", "usage"]
}
```

---

### 命令 2：存储结果

**用途**：将结果存储到知识图谱或文件

**语法**：
```
存储结果:
  - type: <存储类型>
  - data: <数据>
  - entityId: <关联实体ID> (可选)
```

**存储类型**：

| 类型 | 说明 |
|------|------|
| knowledge | 存储到知识图谱（MCP Memory） |
| file | 存储到文件 |
| report | 生成报告文件 |

**示例**：

```json
{
  "type": "knowledge",
  "data": {
    "entityType": "Note",
    "name": "NOTE-2026-02-23-002",
    "observations": ["content: 分析结果..."]
  }
}
```

---

### 命令 3：生成报告

**用途**：生成批量执行报告

**语法**：
```
生成报告:
  - type: <报告类型>
  - results: <结果数据>
  - outputPath: <输出路径> (可选)
```

**报告类型**：

| 类型 | 说明 |
|------|------|
| batch | 批量执行报告 |
| daily | 日报 |
| weekly | 周报 |
| error | 错误报告 |

**示例**：

```json
{
  "type": "batch",
  "results": {
    "total": 10,
    "success": 8,
    "failed": 2,
    "errors": [...]
  }
}
```

---

### 命令 4：错误处理

**用途**：处理和记录错误

**语法**：
```
错误处理:
  - error: <错误对象>
  - context: <上下文信息> (可选)
```

**错误对象**：

```json
{
  "code": "ERROR_CODE",
  "message": "错误描述",
  "details": {
    "additional_info": "值"
  },
  "timestamp": "2026-02-23T18:00:00"
}
```

---

## 错误代码

| 代码 | 说明 | 处理方式 |
|------|------|----------|
| API_TIMEOUT | API 调用超时 | 记录并重试 |
| API_ERROR | API 错误 | 记录详细信息 |
| SKILL_NOT_FOUND | 技能不存在 | 返回可用技能列表 |
| SKILL_ERROR | 技能执行错误 | 记录错误堆栈 |
| INVALID_PARAMS | 参数错误 | 返回参数验证错误 |
| RATE_LIMITED | 速率限制 | 添加延迟后重试 |

---

## 结果存储

### 知识图谱存储

```
使用 mcp__memory__create_entities 存储分析结果：
{
  "entities": [{
    "name": "RESULT-2026-02-23-001",
    "entityType": "AnalysisResult",
    "observations": [
      "type: file_analysis",
      "source: Claude API",
      "content: <分析结果>",
      "timestamp: 2026-02-23T18:00:00"
    ]
  }]
}

使用 mcp__memory__create_relations 建立关联：
{
  "relations": [{
    "from": "RESULT-2026-02-23-001",
    "to": "PROJ-001: OPC-CEO",
    "relationType": "belongs_to"
  }]
}
```

### 文件存储

```
生成 Markdown 格式的报告文件
保存到指定输出路径或默认报告目录
```

---

## 相关模块

- [API调用](API调用.md) - API 调用模式
- [批量处理](批量处理.md) - 批量任务处理
- [技能调用](技能调用.md) - 技能调用方法

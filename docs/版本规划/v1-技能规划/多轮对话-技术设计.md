# 多轮对话技术设计

## 1. 概述

本文档描述 OPC-CEO 系统中**无人值守多轮对话**的技术设计方案。与传统的用户交互式对话不同，OPC-CEO 的多轮对话主要用于自动化工作流，通过 Claude SDK 执行独立会话，在任务完成后通知发起方继续后续流程。

### 1.1 设计原则

- **无人值守执行** - 对话自动进行，无需用户实时参与
- **独立会话隔离** - 通过 claude-sdk-executor 创建独立 Claude 会话，绕过嵌套限制
- **Claude Code 原生管理** - 会话历史和恢复完全由 Claude Code 管理
- **明确完成通知** - Skill 必须明确通知任务完成状态

---

## 2. 系统架构设计

### 2.1 整体架构

```
[CEO 技能] ───▶ 调用 claude-sdk-executor 执行任务
                      │
                      ├─▶ Bash 启动 Python 进程
                      │       │
                      │       └─▶ anthropic SDK 调用 Claude API
                      │                       │
                      │                       └─▶ 独立 Claude 会话（多轮对话）
                      │                                │
                      │                                └─▶ Claude Code 自动管理会话历史
                      │                                     （~/.claude/ 目录）
                      │
                      └─▶ [执行完成后] 返回结果给 CEO
```

### 2.2 核心组件职责

| 组件 | 职责 | 实现方式 |
|------|------|----------|
| **发起方** | 创建任务、发起执行、等待完成 | CEO 或其他 Skill |
| **claude-sdk-executor** | 执行独立会话任务 | Bash + Python + anthropic SDK |
| **Claude Code** | 管理会话历史和恢复 | 原生会话管理（~/.claude/） |
| **执行方** | 执行具体任务逻辑 | 独立 Claude 会话 |

---

## 3. Claude Code 会话管理

### 3.1 会话存储

- **存储位置**: `~/.claude/` 目录
- **保存时长**: 默认 30 天（可配置）
- **自动管理**: Claude Code 自动保存和清理

### 3.2 会话恢复命令

| 命令 | 说明 |
|------|------|
| `claude --resume <session-id>` | 恢复指定会话 |
| `claude --continue` | 恢复上一次对话 |
| `/resume <session-id>` | 在会话内恢复 |
| `/rename <name>` | 重命名当前会话 |
| `/status` | 查看当前会话信息 |

### 3.3 会话恢复流程

```
1. CEO 调用 claude-sdk-executor
   ├─ 传入会话 ID（如果恢复现有会话）
   └─ 传入任务提示词

2. claude-sdk-executor 启动执行
   ├─ 使用 --resume <session-id> 恢复会话（可选）
   ├─ 或创建新会话（不指定 session-id）
   └─ Claude SDK 自动加载历史上下文（如果恢复）

3. 独立会话执行
   ├─ 在上下文中继续对话
   └─ 生成结果

4. Claude Code 自动保存
   └─ 对话历史自动保存到 ~/.claude/
```

---

## 4. 执行流程设计

### 4.1 基本执行流程

```
1. CEO 调用 claude-sdk-executor
   ├─ 传入任务提示词
   ├─ 传入会话 ID（可选，用于恢复）
   └─ 等待执行完成

2. claude-sdk-executor 启动执行
   ├─ 通过 Bash 启动 Python 进程
   └─ 调用 anthropic SDK

3. 独立 Claude 会话执行
   ├─ 接收任务提示
   ├─ 执行多轮推理
   └─ 生成结果

4. claude-sdk-executor 返回结果
   ├─ 返回执行结果给 CEO
   └─ 返回会话 ID（供后续恢复使用）

5. CEO 处理结果
   ├─ 接收执行结果
   └─ 继续后续流程
```

### 4.2 会话恢复执行流程

```
1. CEO 调用 claude-sdk-executor
   ├─ 传入会话 ID（恢复之前会话）
   └─ 传入新的提示词

2. claude-sdk-executor 恢复会话
   ├─ 使用 --resume <session-id>
   └─ Claude Code 自动加载历史上下文

3. 在恢复的上下文中继续对话
   ├─ 访问之前的历史消息
   └─ 生成新响应

4. Claude Code 自动保存
   └─ 新消息追加到原会话历史
```

---

## 5. 执行结果处理

### 5.1 完成通知

执行完成后，claude-sdk-executor 返回结果给 CEO：

```json
{
  "success": true,
  "session_id": "abc123-def456-789",
  "result": "执行结果内容",
  "usage": {
    "input_tokens": 150,
    "output_tokens": 500,
    "total_tokens": 650
  }
}
```

### 5.2 会话 ID 使用

- **首次执行**: 创建新会话，返回新的 session_id
- **继续执行**: 传入 session_id，恢复原会话并继续
- **会话命名**: 可选，便于通过名称查找会话

---

## 6. 数据结构

### 6.1 执行请求格式

```json
{
  "prompt": "任务描述",
  "session_id": "abc123-def456-789",  // 可选，用于恢复会话
  "session_name": "任务名称",           // 可选，便于查找
  "model": "claude-opus-4-6",
  "system_prompt": "系统提示（可选）",
  "max_tokens": 4096,
  "timeout": 300
}
```

### 6.2 执行结果格式

```json
{
  "success": true,
  "session_id": "abc123-def456-789",
  "result": "执行结果内容",
  "usage": {
    "input_tokens": 150,
    "output_tokens": 500,
    "total_tokens": 650
  },
  "duration_ms": 5200
}
```

---

## 7. 错误处理

### 7.1 错误类型

| 错误类型 | 说明 | 处理方式 |
|----------|------|----------|
| API 错误 | 调用 Claude API 失败 | 重试 |
| 超时错误 | 执行时间超过限制 | 重试 |
| 网络错误 | 网络连接问题 | 重试 |
| 权限错误 | 无执行权限 | 标记失败 |
| 格式错误 | 输入格式不正确 | 标记失败 |

### 7.2 重试策略

- **默认重试次数**: 3 次
- **重试间隔**: 指数退避（1s, 2s, 4s）
- **最大重试时间**: 60 秒

---

## 8. 使用场景

### 场景 1: 代码分析

```
CEO: 分析这个项目的代码结构

1. CEO 调用 claude-sdk-executor 执行分析
2. 独立会话读取代码文件
3. 生成分析结果
4. 返回会话 ID 和结果
5. CEO 展示结果给用户

如需继续分析：
1. CEO 传入会话 ID
2. claude-sdk-executor 恢复会话
3. 在原上下文中继续对话
```

### 场景 2: 文档生成

```
automation-manager: 每周生成本项目周报

1. 创建定时任务
2. 每周五触发
3. 调用 claude-sdk-executor 生成周报
4. 返回周报内容
5. automation-manager 保存到文件系统
```

### 场景 3: 会话延续

```
用户: 继续昨天的分析工作

1. CEO 获取昨天的会话 ID
2. CEO 调用 claude-sdk-executor，传入会话 ID
3. 恢复会话，加载历史上下文
4. 在原对话基础上继续工作
5. 返回新的会话状态
```

---

## 9. 性能考虑

### 9.1 资源管理

- 监控 Token 使用量
- 控制单个任务的执行时间
- Claude Code 自动清理过期会话（默认 30 天）

---

## 10. 安全设计

### 10.1 权限验证

- 执行前验证会话 ID 有效性
- 防止跨会话访问

### 10.2 敏感信息

- API Key 通过环境变量管理
- 不在会话中存储敏感信息

---

## 11. 相关文档

- [`claude-sdk-executor/SKILL.md`](../../.claude/skills/claude-sdk-executor/SKILL.md) - SDK 执行器技能
- [`设计意图.md`](../设计意图.md) - 整体设计原则
- [`模板规范.md`](../模板规范.md) - Skill 格式规范

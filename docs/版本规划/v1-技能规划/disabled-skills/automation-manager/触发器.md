# 触发器

## 概述

定义工作流的触发条件，包括定时触发和事件触发。

## 触发器类型

### Cron 触发器

基于时间表的定时触发。

**格式**：

```yaml
trigger:
  type: cron
  schedule: "cron表达式"
  timezone: "Asia/Shanghai"  # 可选
```

**Cron 表达式格式**：

```
分 时 日 月 周
*  *  *  *  *  → 每分钟
0  *  *  *  *  → 每小时
0  0  *  *  *  → 每天 00:00
0  18 *  *  *  → 每天 18:00
0  0  *  *  1  → 每周一 00:00
0  9  *  *  1  → 每周一 09:00
0  0  1  *  *  → 每月 1 日 00:00
*/5 *  *  *  *  → 每 5 分钟
0 */2 *  *  *  → 每 2 小时
```

**示例**：

```yaml
# 每天早上 9 点
trigger:
  type: cron
  schedule: "0 9 * * *"

# 每周一 18 点
trigger:
  type: cron
  schedule: "0 18 * * 1"

# 每月 1 日 0 点
trigger:
  type: cron
  schedule: "0 0 1 * *"

# 每小时
trigger:
  type: cron
  schedule: "0 * * * *"
```

### 事件触发器

基于系统事件或业务事件的触发。

**格式**：

```yaml
trigger:
  type: event
  eventType: 事件类型
  conditions:
    field: value
```

**内置事件类型**：

| 事件类型 | 说明 |
|---------|------|
| `task-completed` | 任务完成 |
| `task-created` | 任务创建 |
| `event-started` | 日程事件开始 |
| `budget-overspent` | 预算超支 |
| `workflow-completed` | 工作流完成 |

**示例**：

```yaml
# 任务完成后触发
trigger:
  type: event
  eventType: task-completed

# 高优先级任务完成后触发
trigger:
  type: event
  eventType: task-completed
  conditions:
    priority: P1

# 预算超支时触发
trigger:
  type: event
  eventType: budget-overspent
  conditions:
    severity: warning
```

### 手动触发器

需要手动启动的工作流。

**格式**：

```yaml
trigger:
  type: manual
```

## 触发器配置

### 重复触发

```yaml
trigger:
  type: cron
  schedule: "0 18 * * 1-5"  # 工作日
```

### 多条件触发

```yaml
trigger:
  type: event
  eventType: task-completed
  conditions:
    priority: P1
    category: critical
```

### 过期触发

```yaml
trigger:
  type: event
  eventType: task-deadline
  conditions:
    status: pending
    overdue: true
```

## 触发器验证

### 验证规则

| 规则 | 说明 |
|------|------|
| Cron 表达式格式正确 | 5 段，数值范围有效 |
| 事件类型有效 | 必须是内置事件类型 |
| 条件字段存在 | 引用的字段必须存在 |
| 时区有效 | 必须是有效的时区名称 |

### 验证示例

```yaml
# 有效
trigger:
  type: cron
  schedule: "0 18 * * 1-5"

# 无效 - 星期范围错误
trigger:
  type: cron
  schedule: "0 18 * * 8"  # 星期只有 0-6

# 无效 - 事件类型错误
trigger:
  type: event
  eventType: invalid-event
```

## MCP Memory 存储

### Trigger 实体

```yaml
entityType: Trigger
name: TRIGGER-WF-2026-02-24-001
observations:
  - workflowId: WF-2026-02-24-001
  - type: cron
  - schedule: "0 18 * * *"
  - timezone: Asia/Shanghai
  - active: true
  - lastTriggered: 2026-02-24T18:00:00Z
  - createdAt: 2026-02-24T00:00:00Z
```

## 注意事项

- Cron 表达式使用 UTC 时间（除非指定时区）
- 事件触发器的条件必须精确
- 手动触发器不需要自动执行
- 禁用的工作流不会触发

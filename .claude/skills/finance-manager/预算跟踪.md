# 预算跟踪

## 概述

管理预算设置、跟踪预算使用进度，并在超支时发出预警。

## 预算设置

### 创建预算

**输入参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `period` | string | 是 | 预算周期，如 `2026-02` |
| `category` | string | 是 | 分类代码 |
| `limit` | number | 是 | 预算限额 |

**处理流程**：

```
1. 生成预算 ID: BUD-YYYY-MM-NNN
2. 创建 Budget 实体
3. 初始化 spent 为 0
4. 设置 status 为 normal
```

**示例**：

```
创建 2 月软件订阅预算
- 周期: 2026-02
- 分类: EXP-SUB
- 限额: ¥1,500.00

生成 ID: BUD-2026-02-001
```

## 预算跟踪

### 更新已消费金额

每次记录支出时，自动更新对应预算：

```
记录支出: ¥299 (EXP-SUB)
→ 查找 2026-02 的 EXP-SUB 预算
→ 更新 spent: spent + 299
→ 检查预算状态
```

### 预算状态

| 状态 | 阈值 | 说明 |
|------|------|------|
| `normal` | spent ≤ 80% | 正常 |
| `warning` | 80% < spent ≤ 100% | 预警 |
| `over` | spent > 100% | 超支 |

### 状态检查逻辑

```
ratio = spent / limit

if ratio <= 0.8:
    status = normal
elif ratio <= 1.0:
    status = warning
else:
    status = over
```

## 超支预警

### 触发条件

- 预算状态变为 `warning`
- 预算状态变为 `over`

### 预警内容

```
【预算预警】
分类: 软件订阅 (EXP-SUB)
周期: 2026-02
已消费: ¥1,200.00 / ¥1,500.00 (80.0%)
状态: 预警
建议: 注意控制软件订阅支出
```

## 预算报告

### 查询预算

```
查询 2026-02 所有预算
→ 返回所有预算及其状态
```

**结果格式**：

```json
{
  "period": "2026-02",
  "budgets": [
    {
      "budgetId": "BUD-2026-02-001",
      "category": "EXP-SUB",
      "categoryName": "软件订阅",
      "limit": 1500,
      "spent": 1200,
      "remaining": 300,
      "ratio": 0.8,
      "status": "warning"
    }
  ],
  "summary": {
    "totalLimit": 5000,
    "totalSpent": 3800,
    "totalRemaining": 1200
  }
}
```

### 预算对比

```
对比本月与上月预算
→ 查询上月预算
→ 计算差异
→ 生成对比报告
```

## MCP Memory 实体

### Budget 实体

```yaml
entityType: Budget
name: BUD-2026-02-001
observations:
  - period: 2026-02
  - category: EXP-SUB
  - categoryName: 软件订阅
  - limit: 1500
  - spent: 1200
  - remaining: 300
  - ratio: 0.8
  - status: warning
  - createdAt: 2026-02-01T00:00:00Z
  - updatedAt: 2026-02-23T10:00:00Z
```

## 注意事项

- 预算周期按月管理
- 超支预算需要人工审批调整
- 预算状态变化时立即预警
